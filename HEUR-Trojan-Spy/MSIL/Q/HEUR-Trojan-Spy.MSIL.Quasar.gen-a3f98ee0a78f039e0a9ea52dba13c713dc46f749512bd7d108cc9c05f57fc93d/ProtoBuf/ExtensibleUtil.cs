// Decompiled with JetBrains decompiler
// Type: ProtoBuf.ExtensibleUtil
// Assembly: Stubv2.0, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: E945C042-2241-44AF-B826-4AD3FC72B170
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2021.03-msil\HEUR-Trojan-Spy.MSIL.Quasar.gen-a3f98ee0a78f039e0a9ea52dba13c713dc46f749512bd7d108cc9c05f57fc93d.exe

using ProtoBuf.Meta;
using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;

namespace ProtoBuf
{
  internal static class ExtensibleUtil
  {
    internal static IEnumerable<TValue> GetExtendedValues<TValue>(
      IExtensible instance,
      int tag,
      DataFormat format,
      bool singleton,
      bool allowDefinedTag)
    {
      foreach (TValue extendedValue in ExtensibleUtil.GetExtendedValues((TypeModel) RuntimeTypeModel.Default, typeof (TValue), instance, tag, format, singleton, allowDefinedTag))
        yield return extendedValue;
    }

    internal static IEnumerable GetExtendedValues(
      TypeModel model,
      Type type,
      IExtensible instance,
      int tag,
      DataFormat format,
      bool singleton,
      bool allowDefinedTag)
    {
      if (instance == null)
        throw new ArgumentNullException(nameof (instance));
      if (tag <= 0)
        throw new ArgumentOutOfRangeException(nameof (tag));
      IExtension extn = instance.GetExtensionObject(false);
      if (extn != null)
      {
        Stream stream = extn.BeginQuery();
        object obj = (object) null;
        ProtoReader reader = (ProtoReader) null;
        try
        {
          reader = ProtoReader.Create(stream, model, new SerializationContext(), -1);
          while (model.TryDeserializeAuxiliaryType(reader, format, tag, type, ref obj, true, false, false, false) && obj != null)
          {
            if (!singleton)
            {
              yield return obj;
              obj = (object) null;
            }
          }
          if (singleton && obj != null)
            yield return obj;
        }
        finally
        {
          ProtoReader.Recycle(reader);
          extn.EndQuery(stream);
        }
      }
    }

    internal static void AppendExtendValue(
      TypeModel model,
      IExtensible instance,
      int tag,
      DataFormat format,
      object value)
    {
      if (instance == null)
        throw new ArgumentNullException(nameof (instance));
      if (value == null)
        throw new ArgumentNullException(nameof (value));
      IExtension extensionObject = instance.GetExtensionObject(true);
      if (extensionObject == null)
        throw new InvalidOperationException("No extension object available; appended data would be lost.");
      bool commit = false;
      Stream stream = extensionObject.BeginAppend();
      try
      {
        using (ProtoWriter writer = new ProtoWriter(stream, model, (SerializationContext) null))
        {
          model.TrySerializeAuxiliaryType(writer, (Type) null, format, tag, value, false);
          writer.Close();
        }
        commit = true;
      }
      finally
      {
        extensionObject.EndAppend(stream, commit);
      }
    }
  }
}
