// Decompiled with JetBrains decompiler
// Type: s193316744763357.s507753835847680
// Assembly: s802785987160928, Version=1.0.0.0, Culture=neutral, PublicKeyToken=8d3bb6c79cff225a
// MVID: E562BAAF-678F-45B2-A19A-CFBF160B1BAF
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.04\Trojan.Win64.Injects.byr-71d4abb6ea36ebfca83e1b236cadfd303a41fe6d642637197c630ec1263b20db.exe

using s254766793960553;
using s362420967940830;
using s465337320084666;
using s740588166303995;
using s914955847573057;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Runtime.Serialization;
using System.Threading;
using System.Threading.Tasks;

namespace s193316744763357
{
  internal class s507753835847680
  {
    private static Lazy<bool> s865308774934129 = new Lazy<bool>(new Func<bool>(s507753835847680.s986752630629882));
    private Stack<s775788418010176> s701828124576469 = new Stack<s775788418010176>();

    private static bool s986752630629882()
    {
      string environmentVariable = Environment.GetEnvironmentVariable("TTD_RECORD_LOG_SHADOW_STACK");
      return !string.IsNullOrEmpty(environmentVariable) && !"0".Equals(environmentVariable);
    }

    public bool s579526503544806(out s775788418010176 s626618765262356)
    {
      s626618765262356 = (s775788418010176) null;
      foreach (s775788418010176 s775788418010176 in this.s701828124576469)
      {
        if (s775788418010176.s882366201092505)
        {
          s626618765262356 = s775788418010176;
          return true;
        }
      }
      return false;
    }

    private static string s705086183126740(string s901845034804823) => string.Format("{0}[T:{1}]: {2}", (object) nameof (s507753835847680), (object) Thread.CurrentThread.ManagedThreadId, (object) s901845034804823);

    private static void s100120173519446(string s493846249638691, params object[] s950162618209735) => s095683830799280.s567800687732192.s411925689910680(s507753835847680.s705086183126740(s493846249638691), s950162618209735);

    private static void s812915693141765(string s163752995364469, params object[] s767292747462747) => s095683830799280.s567800687732192.s411925689910680(s507753835847680.s705086183126740(s163752995364469), s767292747462747);

    private void s598288608659846()
    {
      if (!s507753835847680.s802426635330133 || this.s701828124576469.Count <= 0)
        return;
      s507753835847680.s812915693141765("Current stack:");
      s507753835847680.s508579240479873((IEnumerable<s775788418010176>) this.s701828124576469.ToArray());
    }

    private static void s508579240479873(IEnumerable<s775788418010176> s763639039837716)
    {
      if (!s507753835847680.s802426635330133)
        return;
      List<s775788418010176> s775788418010176List = new List<s775788418010176>(s763639039837716);
      for (int index = 0; index < s775788418010176List.Count; ++index)
      {
        s775788418010176 s775788418010176 = s775788418010176List[index];
        s507753835847680.s812915693141765("- Frame {0}: ID=0x{1:X16}, StartedRecording={2}, IsAsyncMethod={3}, IsCompleting={4}", (object) index, (object) s775788418010176.s650232807345924, (object) s775788418010176.s882366201092505, (object) s775788418010176.s931393618492295, (object) s775788418010176.s105885803816556);
      }
    }

    public s775788418010176 s474915752977342()
    {
      s775788418010176 s775788418010176 = this.s701828124576469.Pop();
      s507753835847680.s812915693141765("Removed function ID 0x{0:X} from stack. Frame count = {1}", (object) s775788418010176.s650232807345924, (object) this.s701828124576469.Count);
      if (this.s701828124576469.Count > 0)
        this.s598288608659846();
      return s775788418010176;
    }

    public s775788418010176 s733588821216499(
      ulong s509499618942198,
      bool s110582074636038)
    {
      s775788418010176 s775788418010176 = new s775788418010176(s509499618942198, s110582074636038);
      this.s701828124576469.Push(s775788418010176);
      s507753835847680.s812915693141765("Added function ID 0x{0:X} to stack. Frame count = {1}", (object) s775788418010176.s650232807345924, (object) this.s701828124576469.Count);
      this.s598288608659846();
      return s775788418010176;
    }

    public IDisposable s599267095129781(s960412633860805 s406780757150972)
    {
      Stack<s775788418010176> s775788418010176Stack = new Stack<s775788418010176>();
      while (this.s701828124576469.Count > 0)
      {
        s775788418010176 s775788418010176 = this.s701828124576469.Peek();
        if (s775788418010176.s105885803816556)
        {
          s406780757150972.s324448413406438(s775788418010176.s650232807345924);
          s775788418010176Stack.Push(this.s701828124576469.Pop());
        }
        else
          break;
      }
      if (s507753835847680.s802426635330133 && s775788418010176Stack.Count > 0)
      {
        s507753835847680.s812915693141765("Temporarily removed the following completing frames:");
        s507753835847680.s508579240479873(s775788418010176Stack.Reverse<s775788418010176>());
      }
      // ISSUE: object of a compiler-generated type is created
      return (IDisposable) new s754392368222187.s933520665798903(s406780757150972, this.s701828124576469, (IEnumerable<s775788418010176>) s775788418010176Stack);
    }

    public void s207143662383960()
    {
      foreach (s775788418010176 s775788418010176 in this.s701828124576469)
        s775788418010176.s882366201092505 = false;
    }

    public bool s981035436828707(out s775788418010176 s042709586415899)
    {
      if (this.s701828124576469.Count > 0)
      {
        s042709586415899 = this.s701828124576469.Peek();
        return true;
      }
      s507753835847680.s100120173519446("Unable to get top frame because stack is empty.");
      s042709586415899 = (s775788418010176) null;
      return false;
    }

    public bool s209270748417790(ulong s393217708733346, out s775788418010176 s496843175129149)
    {
      s775788418010176 s042709586415899;
      if (!this.s981035436828707(out s042709586415899))
      {
        s496843175129149 = (s775788418010176) null;
        return false;
      }
      if ((long) s393217708733346 != (long) s042709586415899.s650232807345924)
      {
        s507753835847680.s100120173519446("Expected frame to be function ID 0x{0:X} but frame is function ID 0x{1:X}.", (object) s393217708733346, (object) s042709586415899.s650232807345924);
        s496843175129149 = (s775788418010176) null;
        return false;
      }
      s496843175129149 = s042709586415899;
      return true;
    }

    private static bool s802426635330133 => s507753835847680.s865308774934129.Value;

    public bool s727298766669709 => this.s701828124576469.Count > 0;

    private class s610262370468970 : IDisposable
    {
      private s960412633860805 s284931579554137;
      private Stack<s775788418010176> s510101629174924;
      private static ObjectIDGenerator s100667261216227;

      public void s325117235450845()
      {
        // ISSUE: reference to a compiler-generated field
        if (this.s284931579554137 == null || this.s510101629174924 == null || ((s754392368222187.s933520665798903) this).s779503812243535 == null)
          return;
        // ISSUE: reference to a compiler-generated field
        if (((s754392368222187.s933520665798903) this).s779503812243535.Any<s775788418010176>())
        {
          if (s507753835847680.s802426635330133)
          {
            s507753835847680.s812915693141765("Restoring the following completing frames:");
            // ISSUE: reference to a compiler-generated field
            s507753835847680.s508579240479873(((s754392368222187.s933520665798903) this).s779503812243535.Reverse<s775788418010176>());
          }
          // ISSUE: reference to a compiler-generated field
          foreach (s775788418010176 s775788418010176 in ((s754392368222187.s933520665798903) this).s779503812243535)
          {
            this.s284931579554137.s476084563495243(s775788418010176.s650232807345924, s775788418010176.s882366201092505);
            this.s510101629174924.Push(s775788418010176);
          }
        }
        // ISSUE: reference to a compiler-generated field
        ((s754392368222187.s933520665798903) this).s779503812243535 = (IEnumerable<s775788418010176>) null;
        this.s510101629174924 = (Stack<s775788418010176>) null;
      }

      public s610262370468970(uint activityId, ulong functionId)
      {
        lock (s507753835847680.s610262370468970.s100667261216227)
          s424076493653259.s940659201817219("Created async state #{0}", (object) s507753835847680.s610262370468970.s100667261216227.GetId((object) this, out bool _));
        ((s424076493653259.s453905211137903) this).s401426390144248 = new TaskCompletionSource<object>();
        // ISSUE: reference to a compiler-generated field
        ((s424076493653259.s453905211137903) this).s320372881877239 = activityId;
        ((s424076493653259.s453905211137903) this).s575699294395452 = true;
        // ISSUE: reference to a compiler-generated field
        ((s424076493653259.s453905211137903) this).s714094363211816 = functionId;
      }
    }
  }
}
