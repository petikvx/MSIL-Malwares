// Decompiled with JetBrains decompiler
// Type: System.ServiceModel.Dispatcher.UriTemplateDispatchFormatter
// Assembly: Microsoft.Transactions.Bridge, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 51116F84-6FE2-4BD6-A908-2C88E06F45BB
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.07\HEUR-Trojan.MSIL.Picsys.gen-d64123468b2dcb11e9205288e0a6cb144a448944457a708807b7345a8a766675.exe

using System.Collections.Generic;
using System.Collections.Specialized;
using System.Diagnostics;
using System.ServiceModel.Channels;
using System.ServiceModel.Description;
using System.ServiceModel.Diagnostics;

namespace System.ServiceModel.Dispatcher
{
  internal class UriTemplateDispatchFormatter : IDispatchMessageFormatter
  {
    internal Dictionary<int, string> pathMapping;
    internal Dictionary<int, KeyValuePair<string, System.Type>> queryMapping;
    private Uri baseAddress;
    private IDispatchMessageFormatter inner;
    private string operationName;
    private QueryStringConverter qsc;
    private int totalNumUTVars;
    private UriTemplate uriTemplate;

    public UriTemplateDispatchFormatter(
      OperationDescription operationDescription,
      IDispatchMessageFormatter inner,
      QueryStringConverter qsc,
      string contractName,
      Uri baseAddress)
    {
      this.inner = inner;
      this.qsc = qsc;
      this.baseAddress = baseAddress;
      this.operationName = operationDescription.Name;
      UriTemplateClientFormatter.Populate(out this.pathMapping, out this.queryMapping, out this.totalNumUTVars, out this.uriTemplate, operationDescription, qsc, contractName);
    }

    public void DeserializeRequest(Message message, object[] parameters)
    {
      object[] parameters1 = new object[parameters.Length - this.totalNumUTVars];
      if (parameters1.Length != 0)
        this.inner.DeserializeRequest(message, parameters1);
      int index = 0;
      UriTemplateMatch uriTemplateMatch = (UriTemplateMatch) null;
      string name = "UriTemplateMatchResults";
      if (message.Properties.ContainsKey(name))
        uriTemplateMatch = message.Properties[name] as UriTemplateMatch;
      else if (message.Headers.To != (Uri) null && message.Headers.To.IsAbsoluteUri)
        uriTemplateMatch = this.uriTemplate.Match(this.baseAddress, message.Headers.To);
      NameValueCollection nameValueCollection = uriTemplateMatch == null ? new NameValueCollection() : uriTemplateMatch.BoundVariables;
      for (int key = 0; key < parameters.Length; ++key)
      {
        if (this.pathMapping.ContainsKey(key) && uriTemplateMatch != null)
          parameters[key] = (object) nameValueCollection[this.pathMapping[key]];
        else if (this.queryMapping.ContainsKey(key) && uriTemplateMatch != null)
        {
          string parameter = nameValueCollection[this.queryMapping[key].Key];
          parameters[key] = this.qsc.ConvertStringToValue(parameter, this.queryMapping[key].Value);
        }
        else
        {
          parameters[key] = parameters1[index];
          ++index;
        }
      }
      if (!DiagnosticUtility.ShouldTraceInformation || uriTemplateMatch == null)
        return;
      foreach (string key in uriTemplateMatch.QueryParameters.Keys)
      {
        bool flag = true;
        foreach (KeyValuePair<string, System.Type> keyValuePair in this.queryMapping.Values)
        {
          if (string.Compare(key, keyValuePair.Key, StringComparison.OrdinalIgnoreCase) == 0)
          {
            flag = false;
            break;
          }
        }
        if (flag)
        {
          // ISSUE: reference to a compiler-generated method
          TraceUtility.TraceEvent(TraceEventType.Information, 983076, SR2.GetString(SR2.TraceCodeWebRequestUnknownQueryParameterIgnored, (object) key, (object) this.operationName));
        }
      }
    }

    public Message SerializeReply(
      MessageVersion messageVersion,
      object[] parameters,
      object result)
    {
      // ISSUE: reference to a compiler-generated method
      throw DiagnosticUtility.ExceptionUtility.ThrowHelperError((Exception) new NotSupportedException(SR2.GetString(SR2.QueryStringFormatterOperationNotSupportedServerSide)));
    }
  }
}
