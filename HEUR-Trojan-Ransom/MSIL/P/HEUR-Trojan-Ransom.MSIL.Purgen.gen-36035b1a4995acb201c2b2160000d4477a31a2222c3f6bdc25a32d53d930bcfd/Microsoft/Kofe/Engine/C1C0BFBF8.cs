// Decompiled with JetBrains decompiler
// Type: Microsoft.Kofe.Engine.C1C0BFBF8
// Assembly: C5C480410, Version=14.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a
// MVID: BF642EC0-3F36-4177-B782-3E478BED34CB
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2021.12-msil\HEUR-Trojan-Ransom.MSIL.Purgen.gen-36035b1a4995acb201c2b2160000d4477a31a2222c3f6bdc25a32d53d930bcfd.exe

using Microsoft.Kofe.IJDWP;
using Microsoft.VisualStudio.Debugger.Interop;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Runtime.InteropServices;

namespace Microsoft.Kofe.Engine
{
  internal class C1C0BFBF8 : IDebugPendingBreakpoint2
  {
    private IDebugBreakpointRequest2 D6AA1B408;
    private BP_REQUEST_INFO EFA884C7B;
    private B92FAA9B7 A50E62544;
    private B6DF8D9E3 D96AC52DB;
    private List<BE52A5725> E0F33298A;
    private List<ADBF6C470> CE28745B7;
    private bool E5AD07317;
    private bool AEC8A9B11;

    internal bool EEAC0C0DD => this.E5AD07317;

    public C1C0BFBF8(IDebugBreakpointRequest2 pBPRequest, B92FAA9B7 engine, B6DF8D9E3 bpManager)
    {
      this.D6AA1B408 = pBPRequest;
      BP_REQUEST_INFO[] bpRequestInfoArray = new BP_REQUEST_INFO[1];
      A09717160.BA0F763AF(this.D6AA1B408.GetRequestInfo((enum_BPREQI_FIELDS) 511, bpRequestInfoArray));
      this.EFA884C7B = bpRequestInfoArray[0];
      this.A50E62544 = engine;
      this.D96AC52DB = bpManager;
      this.E0F33298A = new List<BE52A5725>();
      this.CE28745B7 = new List<ADBF6C470>();
      this.E5AD07317 = true;
      this.AEC8A9B11 = false;
    }

    private bool DCFCD603C()
    {
      this.CE28745B7.Clear();
      BP_REQUEST_INFO efA884C7B = this.EFA884C7B;
      if (this.AEC8A9B11)
        return false;
      List<C1C0BFBF8.CDCCCC28F> cdcccC28FList = this.D476A8962((enum_BP_LOCATION_TYPE) (int) this.EFA884C7B.bpLocation.bpLocationType, (IJdwpClass) null);
      if (this.EFA884C7B.bpCondition.styleCondition != null)
      {
        foreach (C1C0BFBF8.CDCCCC28F cdcccC28F in cdcccC28FList)
        {
          E604AB64A codeContext = new E604AB64A(this.A50E62544, cdcccC28F.A0E321FF8);
          F21674B78 documentContext = new F21674B78(cdcccC28F.F3670E8BD, cdcccC28F.A76AF6C7F, cdcccC28F.A76AF6C7F, codeContext);
          AC89F237D breakpointResolution = new AC89F237D(this.A50E62544, cdcccC28F.A0E321FF8, documentContext);
          ((IDebugBoundBreakpoint2) new BE52A5725(this.A50E62544, cdcccC28F.A0E321FF8, this, breakpointResolution)).SetCondition(this.EFA884C7B.bpCondition);
        }
      }
      return this.CE28745B7.Count == 0;
    }

    public void E9B3B564F()
    {
      lock (this.E0F33298A)
      {
        for (int index = this.E0F33298A.Count - 1; index >= 0; --index)
          ((IDebugBoundBreakpoint2) this.E0F33298A[index]).Delete();
        this.E0F33298A.Clear();
      }
    }

    public void B91C7FA3A(IJdwpClass DB1AB9CB4) => this.ECE77AFF0(DB1AB9CB4);

    public int CF30FF1B8() => this.ECE77AFF0((IJdwpClass) null);

    public int ECE77AFF0(IJdwpClass AC94C1300)
    {
      lock (this.E0F33298A)
      {
        if (this.DCFCD603C())
        {
          List<C1C0BFBF8.CDCCCC28F> C81A48031 = this.D476A8962((enum_BP_LOCATION_TYPE) (int) this.EFA884C7B.bpLocation.bpLocationType, AC94C1300);
          return C81A48031.Count <= 0 || !this.B49CA1359(C81A48031) ? -2147467259 : 0;
        }
        return !this.AEC8A9B11 ? -2147467259 : -2147221408;
      }
    }

    private List<C1C0BFBF8.CDCCCC28F> D476A8962(
      enum_BP_LOCATION_TYPE F0F049AC4,
      IJdwpClass F3FAA2416)
    {
      if (F0F049AC4 == 65537)
        return this.D0E5A9E58(F3FAA2416);
      if (F0F049AC4 == 131073)
        return this.DE7B2D275(F3FAA2416);
      this.AB1E81DA4(B0E4D9146.A57BB5859, (IJdwpCodeLocation) null, (F21674B78) null, (enum_BP_ERROR_TYPE) 117440514);
      return new List<C1C0BFBF8.CDCCCC28F>();
    }

    private List<C1C0BFBF8.CDCCCC28F> D0E5A9E58(IJdwpClass ECFF1FB44)
    {
      IDebugDocumentPosition2 objectForIunknown = (IDebugDocumentPosition2) Marshal.GetObjectForIUnknown(this.EFA884C7B.bpLocation.unionmember2);
      string str1;
      A09717160.BA0F763AF(objectForIunknown.GetFileName(ref str1));
      TEXT_POSITION[] textPositionArray1 = new TEXT_POSITION[1];
      TEXT_POSITION[] textPositionArray2 = new TEXT_POSITION[1];
      A09717160.BA0F763AF(objectForIunknown.GetRange(textPositionArray1, textPositionArray2));
      string str2 = this.A50E62544.BEB396177.C7D223CD2(str1);
      this.A50E62544.B3E3893F5.SetDebugPackage(str2);
      IJdwpClass[] ijdwpClassArray = new IJdwpClass[0];
      if (ECFF1FB44 != null)
      {
        if (ECFF1FB44.Name != null && ECFF1FB44.Name.StartsWith(str2 + ".", StringComparison.Ordinal))
          ijdwpClassArray = new IJdwpClass[1]{ ECFF1FB44 };
      }
      else
        ijdwpClassArray = this.A50E62544.B3E3893F5.GetClasses(Path.GetFileName(str1));
      List<IJdwpClass> ijdwpClassList = new List<IJdwpClass>();
      foreach (IJdwpClass C7CD084A9 in ijdwpClassArray)
      {
        string str3 = this.A50E62544.BEB396177.AEB742416(C7CD084A9);
        if (str1.EndsWith(str3, StringComparison.OrdinalIgnoreCase) || !Path.IsPathRooted(str1) && string.Equals(((IJdwpReferenceType) C7CD084A9).GetSourceFile(), str1, StringComparison.OrdinalIgnoreCase))
          ijdwpClassList.Add(C7CD084A9);
      }
      if (ijdwpClassList.Count == 0)
      {
        this.AB1E81DA4(B0E4D9146.A44699B94, (IJdwpCodeLocation) null, (F21674B78) null);
        return new List<C1C0BFBF8.CDCCCC28F>();
      }
      uint dwLine = textPositionArray1[0].dwLine;
      List<C1C0BFBF8.CDCCCC28F> cdcccC28FList = new List<C1C0BFBF8.CDCCCC28F>();
      List<IJdwpCodeLocation> ijdwpCodeLocationList = new List<IJdwpCodeLocation>();
      foreach (IJdwpClass ijdwpClass in ijdwpClassList)
      {
        IJdwpCodeLocation location = ijdwpClass.GetLocation(dwLine + 1U);
        if (location != null)
          ijdwpCodeLocationList.Add(location);
      }
      if (ijdwpCodeLocationList.Count > 0)
      {
        TEXT_POSITION textPosition = new TEXT_POSITION();
        textPosition.dwLine = dwLine;
        textPosition.dwColumn = textPositionArray1[0].dwColumn;
        foreach (IJdwpCodeLocation location in ijdwpCodeLocationList)
          cdcccC28FList.Add(new C1C0BFBF8.CDCCCC28F(location, textPosition, str1));
        return cdcccC28FList;
      }
      this.AB1E81DA4(B0E4D9146.BA87E22E0, (IJdwpCodeLocation) null, (F21674B78) null);
      return new List<C1C0BFBF8.CDCCCC28F>();
    }

    private List<C1C0BFBF8.CDCCCC28F> DE7B2D275(IJdwpClass F6129A00D)
    {
      IDebugFunctionPosition2 objectForIunknown = (IDebugFunctionPosition2) Marshal.GetObjectForIUnknown(this.EFA884C7B.bpLocation.unionmember2);
      string str1;
      A09717160.BA0F763AF(objectForIunknown.GetFunctionName(ref str1));
      int startIndex = str1.LastIndexOf('.');
      string str2 = startIndex != -1 ? str1.Remove(startIndex) : "";
      string str3 = startIndex != -1 ? str1.Remove(0, startIndex + 1) : str1;
      bool flag = !string.IsNullOrWhiteSpace(str2);
      TEXT_POSITION[] textPositionArray = new TEXT_POSITION[1];
      A09717160.BA0F763AF(objectForIunknown.GetOffset(textPositionArray));
      List<C1C0BFBF8.CDCCCC28F> cdcccC28FList = new List<C1C0BFBF8.CDCCCC28F>();
      IJdwpClass[] ijdwpClassArray;
      if (F6129A00D != null)
        ijdwpClassArray = new IJdwpClass[1]{ F6129A00D };
      else
        ijdwpClassArray = this.A50E62544.B3E3893F5.GetClasses();
      foreach (IJdwpClass C7CD084A9 in ijdwpClassArray)
      {
        string documentName = this.A50E62544.BEB396177.AEB742416(C7CD084A9);
        foreach (IJdwpMethod method in C7CD084A9.GetMethods(str3))
        {
          if (!flag || C7CD084A9.Name.Contains(str2))
          {
            IJdwpCodeLocation startLocation = method.GetStartLocation();
            IJdwpCodeLine[] lines = method.GetLines();
            if (startLocation != null && lines.Length != 0)
            {
              TEXT_POSITION textPosition = new TEXT_POSITION();
              textPosition.dwLine = (uint) (lines[0].LineNumber + (int) textPositionArray[0].dwLine - 1);
              textPosition.dwColumn = textPositionArray[0].dwColumn;
              IJdwpCodeLocation location = C7CD084A9.GetLocation((uint) lines[0].LineNumber);
              cdcccC28FList.Add(new C1C0BFBF8.CDCCCC28F(location, textPosition, documentName));
            }
          }
        }
      }
      if (cdcccC28FList.Count == 0)
        this.AB1E81DA4(string.Format((IFormatProvider) CultureInfo.CurrentCulture, B0E4D9146.DC08A8D4E, new object[1]
        {
          (object) str3
        }), (IJdwpCodeLocation) null, (F21674B78) null);
      return cdcccC28FList;
    }

    private bool B49CA1359(List<C1C0BFBF8.CDCCCC28F> C81A48031)
    {
      foreach (C1C0BFBF8.CDCCCC28F cdcccC28F in C81A48031)
      {
        IJdwpCodeLocation a0E321Ff8 = cdcccC28F.A0E321FF8;
        if (this.F0A592D84(a0E321Ff8))
        {
          E604AB64A codeContext = new E604AB64A(this.A50E62544, a0E321Ff8);
          F21674B78 f21674B78 = new F21674B78(cdcccC28F.F3670E8BD, cdcccC28F.A76AF6C7F, cdcccC28F.A76AF6C7F, codeContext);
          AC89F237D breakpointResolution = new AC89F237D(this.A50E62544, a0E321Ff8, f21674B78);
          BE52A5725 E1C041A54 = new BE52A5725(this.A50E62544, a0E321Ff8, this, breakpointResolution);
          ((IDebugBoundBreakpoint2) E1C041A54).SetPassCount(this.EFA884C7B.bpPassCount);
          ((IDebugBoundBreakpoint2) E1C041A54).SetCondition(this.EFA884C7B.bpCondition);
          try
          {
            this.A50E62544.B3E3893F5.SetBreakpoint(a0E321Ff8, (object) E1C041A54);
          }
          catch (Exception ex)
          {
            this.AB1E81DA4(ex.Message, a0E321Ff8, f21674B78, (enum_BP_ERROR_TYPE) 117440514);
            return false;
          }
          this.A50E62544.F4F01CC92.E28BC42B4((object) E1C041A54, a0E321Ff8);
          this.E0F33298A.Add(E1C041A54);
        }
      }
      return true;
    }

    private bool F0A592D84(IJdwpCodeLocation E9BA024D5)
    {
      foreach (BE52A5725 be52A5725 in this.E0F33298A)
      {
        if (((object) E9BA024D5).Equals((object) be52A5725.FF69D4640()))
          return false;
      }
      lock (this.CE28745B7)
      {
        foreach (ADBF6C470 adbF6C470 in new List<ADBF6C470>((IEnumerable<ADBF6C470>) this.CE28745B7))
        {
          if (((object) E9BA024D5).Equals((object) adbF6C470.F477E8871()))
            this.CE28745B7.Remove(adbF6C470);
        }
      }
      return true;
    }

    public void AB1E81DA4(
      string AD691DC9C,
      IJdwpCodeLocation D45239114,
      F21674B78 E30823706,
      enum_BP_ERROR_TYPE A0CBDFB9A = 117440513)
    {
      lock (this.CE28745B7)
      {
        foreach (ADBF6C470 adbF6C470 in new List<ADBF6C470>((IEnumerable<ADBF6C470>) this.CE28745B7))
        {
          if ((D45239114 == null || ((object) D45239114).Equals((object) adbF6C470.F477E8871())) && AD691DC9C == adbF6C470.C719C3CCD())
            return;
        }
        ADBF6C470 C46B23511 = new ADBF6C470((IDebugPendingBreakpoint2) this, (IDebugErrorBreakpointResolution2) new B034EA488(this.A50E62544, D45239114, E30823706, AD691DC9C, A0CBDFB9A), D45239114, AD691DC9C);
        this.A50E62544.F4F01CC92.AF11E36AA((object) C46B23511);
        this.CE28745B7.Add(C46B23511);
      }
    }

    int IDebugPendingBreakpoint2.B4A1AA0A1(
      out IEnumDebugErrorBreakpoints2 E95FA91D7)
    {
      E95FA91D7 = (IEnumDebugErrorBreakpoints2) null;
      if (this.DCFCD603C())
        return 0;
      lock (this.CE28745B7)
      {
        IDebugErrorBreakpoint2[] array = (IDebugErrorBreakpoint2[]) this.CE28745B7.ToArray();
        E95FA91D7 = (IEnumDebugErrorBreakpoints2) new F7BD112C0(array);
        return 1;
      }
    }

    int IDebugPendingBreakpoint2.C615EFBF7()
    {
      lock (this.E0F33298A)
      {
        for (int index = this.E0F33298A.Count - 1; index >= 0; --index)
          ((IDebugBoundBreakpoint2) this.E0F33298A[index]).Delete();
        this.AEC8A9B11 = true;
        this.E0F33298A.Clear();
      }
      return 0;
    }

    int IDebugPendingBreakpoint2.C20E07C64(int F28BC8DDC)
    {
      lock (this.E0F33298A)
      {
        this.E5AD07317 = F28BC8DDC != 0;
        foreach (IDebugBoundBreakpoint2 boundBreakpoint2 in this.E0F33298A)
          boundBreakpoint2.Enable(F28BC8DDC);
      }
      return 0;
    }

    int IDebugPendingBreakpoint2.CC5DCA85F(
      out IEnumDebugBoundBreakpoints2 A392D12F2)
    {
      lock (this.E0F33298A)
      {
        IDebugBoundBreakpoint2[] array = (IDebugBoundBreakpoint2[]) this.E0F33298A.ToArray();
        A392D12F2 = (IEnumDebugBoundBreakpoints2) new EB9D79BED(array);
      }
      return 0;
    }

    int IDebugPendingBreakpoint2.D4F54657C(
      enum_BP_ERROR_TYPE EC1D3A31A,
      out IEnumDebugErrorBreakpoints2 EDC471ED5)
    {
      lock (this.CE28745B7)
      {
        IDebugErrorBreakpoint2[] array = (IDebugErrorBreakpoint2[]) this.CE28745B7.ToArray();
        EDC471ED5 = (IEnumDebugErrorBreakpoints2) new F7BD112C0(array);
      }
      return 0;
    }

    int IDebugPendingBreakpoint2.F7A3B25A0(
      out IDebugBreakpointRequest2 FDD8FD39F)
    {
      FDD8FD39F = this.D6AA1B408;
      return 0;
    }

    int IDebugPendingBreakpoint2.D5971972F(PENDING_BP_STATE_INFO[] D6D92DEB3)
    {
      if (this.AEC8A9B11)
        D6D92DEB3[0].state = (enum_PENDING_BP_STATE) 1;
      else if (this.E5AD07317)
        D6D92DEB3[0].state = (enum_PENDING_BP_STATE) 3;
      else if (!this.E5AD07317)
        D6D92DEB3[0].state = (enum_PENDING_BP_STATE) 2;
      return 0;
    }

    int IDebugPendingBreakpoint2.F9AFF6B49(BP_CONDITION B92982D2F)
    {
      if (this.AEC8A9B11)
        return -2147221408;
      lock (this.E0F33298A)
      {
        foreach (IDebugBoundBreakpoint2 boundBreakpoint2 in this.E0F33298A)
          boundBreakpoint2.SetCondition(B92982D2F);
        this.EFA884C7B.bpCondition = B92982D2F;
      }
      return 0;
    }

    int IDebugPendingBreakpoint2.F4B24D0DE(BP_PASSCOUNT AFEB4C4E4)
    {
      if (this.AEC8A9B11)
        return -2147221408;
      lock (this.E0F33298A)
      {
        foreach (IDebugBoundBreakpoint2 boundBreakpoint2 in this.E0F33298A)
          boundBreakpoint2.SetPassCount(AFEB4C4E4);
      }
      return 0;
    }

    int IDebugPendingBreakpoint2.F03A1C4C3(int BADD007C4) => 0;

    private class CDCCCC28F
    {
      public readonly IJdwpCodeLocation A0E321FF8;
      public readonly TEXT_POSITION A76AF6C7F;
      public readonly string F3670E8BD;

      public CDCCCC28F(IJdwpCodeLocation location, TEXT_POSITION textPosition, string documentName)
      {
        this.A0E321FF8 = location;
        this.A76AF6C7F = textPosition;
        this.F3670E8BD = documentName;
      }
    }
  }
}
