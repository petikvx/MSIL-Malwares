// Decompiled with JetBrains decompiler
// Type: Microsoft.Kofe.Engine.AAC38626A
// Assembly: C5C480410, Version=14.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a
// MVID: BF642EC0-3F36-4177-B782-3E478BED34CB
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2021.12-msil\HEUR-Trojan-Ransom.MSIL.Purgen.gen-36035b1a4995acb201c2b2160000d4477a31a2222c3f6bdc25a32d53d930bcfd.exe

using C70E4DCD4;
using Microsoft.Kofe.IJDWP;
using Microsoft.VisualStudio.Debugger.Interop;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;

namespace Microsoft.Kofe.Engine
{
  internal class AAC38626A : IDebugStackFrame2, IDebugExpressionContext2
  {
    private readonly B92FAA9B7 C1E2C19B9;
    private readonly FE8030C1E D5FF5760A;
    private readonly IJdwpStackFrame F3C7ADD20;
    private IJdwpClass A9EAA4697;
    private IJdwpMethod DA1630840;
    private string E339C2D65;
    private int CD537BC28;
    private List<IJdwpVariable> EEAD4C256;
    private List<IJdwpVariable> A7693AB38;
    private DD3247535 C906FD859;
    private bool A7E6A7245;
    private string EE450A371;

    public AAC38626A(B92FAA9B7 engine, FE8030C1E thread, IJdwpStackFrame stackFrame)
    {
      this.C1E2C19B9 = engine;
      this.D5FF5760A = thread;
      this.F3C7ADD20 = stackFrame;
      this.A9EAA4697 = this.C1E2C19B9.B3E3893F5.GetClass(this.F3C7ADD20.Location.ClassID);
      this.E339C2D65 = this.C1E2C19B9.BEB396177.AEB742416(this.A9EAA4697);
      this.DA1630840 = this.A9EAA4697.GetMethod(this.F3C7ADD20.Location.MethodID);
      this.CD537BC28 = this.DA1630840.LineNumber(this.F3C7ADD20.Location.Index) - 1;
      this.EEAD4C256 = new List<IJdwpVariable>();
      this.A7693AB38 = new List<IJdwpVariable>();
      this.C906FD859 = new DD3247535(this.C1E2C19B9.B3E3893F5, this.D5FF5760A.BAB7FF789(), this.F3C7ADD20);
      Array.ForEach<IJdwpVariable>(this.DA1630840.GetVariables(), (Action<IJdwpVariable>) (ED39FD08C =>
      {
        if (ED39FD08C.CodeIndex == 0L && this.F3C7ADD20.Location.Index < (ulong) ED39FD08C.Length)
        {
          this.EEAD4C256.Add(ED39FD08C);
        }
        else
        {
          if ((ulong) ED39FD08C.CodeIndex > this.F3C7ADD20.Location.Index || this.F3C7ADD20.Location.Index >= (ulong) ED39FD08C.CodeIndex + (ulong) ED39FD08C.Length)
            return;
          this.A7693AB38.Add(ED39FD08C);
        }
      }));
    }

    public AAC38626A(string annotation)
    {
      this.A7E6A7245 = true;
      this.EE450A371 = annotation;
    }

    public void B9DAA8335(enum_FRAMEINFO_FLAGS FB92F8D23, out FRAMEINFO F95A3E908)
    {
      F95A3E908 = new FRAMEINFO();
      if (this.A7E6A7245)
      {
        F95A3E908.m_bstrFuncName = this.EE450A371;
        ref enum_FRAMEINFO_FLAGS local1 = ref F95A3E908.m_dwValidFields;
        // ISSUE: cast to a reference type
        // ISSUE: explicit reference operation
        // ISSUE: cast to a reference type
        // ISSUE: explicit reference operation
        ^(int&) ref local1 = ^(int&) ref local1 | 1;
        F95A3E908.m_dwFlags = 1U;
        ref enum_FRAMEINFO_FLAGS local2 = ref F95A3E908.m_dwValidFields;
        // ISSUE: cast to a reference type
        // ISSUE: explicit reference operation
        // ISSUE: cast to a reference type
        // ISSUE: explicit reference operation
        ^(int&) ref local2 = ^(int&) ref local2 | 512;
      }
      else
      {
        if ((FB92F8D23 & 1) != null)
        {
          F95A3E908.m_bstrFuncName = "";
          if ((FB92F8D23 & 65536) != null && this.A9EAA4697 != null)
            F95A3E908.m_bstrFuncName = this.A9EAA4697.Name + ".";
          // ISSUE: explicit reference operation
          ^ref F95A3E908.m_bstrFuncName += this.DA1630840.Name;
          if ((FB92F8D23 & 16384) != null && this.EEAD4C256.Count > 0)
          {
            // ISSUE: explicit reference operation
            ^ref F95A3E908.m_bstrFuncName += "(";
            int num = 0;
            BF602D4D0.E0EE62C88 = this.C1E2C19B9.C826EF455();
            foreach (IJdwpVariable variable in this.EEAD4C256)
            {
              if (variable.CodeIndex == 0L && variable.Name != "this")
              {
                if (num != 0)
                {
                  // ISSUE: explicit reference operation
                  ^ref F95A3E908.m_bstrFuncName += ", ";
                }
                if ((FB92F8D23 & 1048576) != null)
                {
                  ref string local = ref F95A3E908.m_bstrFuncName;
                  local = local + variable.DisplaySignature + " ";
                }
                if ((FB92F8D23 & 2097152) != null)
                {
                  // ISSUE: explicit reference operation
                  ^ref F95A3E908.m_bstrFuncName += variable.Name;
                }
                if ((FB92F8D23 & 4194304) != null)
                {
                  D85FA4443 d85Fa4443 = new D85FA4443(variable, this.C906FD859);
                  d85Fa4443.D47B03E76(this.C1E2C19B9.B3E3893F5);
                  if (!string.IsNullOrWhiteSpace(d85Fa4443.FC3E9C6DA.DisplayValue))
                  {
                    ref string local = ref F95A3E908.m_bstrFuncName;
                    local = local + "=" + d85Fa4443.FC3E9C6DA.DisplayValue;
                  }
                }
                ++num;
              }
            }
            // ISSUE: explicit reference operation
            ^ref F95A3E908.m_bstrFuncName += ")";
          }
          if ((FB92F8D23 & 131072) != null && this.CD537BC28 > -2)
          {
            ref string local = ref F95A3E908.m_bstrFuncName;
            local = local + " Line " + (this.CD537BC28 + 1).ToString((IFormatProvider) CultureInfo.InvariantCulture);
          }
          ref enum_FRAMEINFO_FLAGS local3 = ref F95A3E908.m_dwValidFields;
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          ^(int&) ref local3 = ^(int&) ref local3 | 1;
        }
        if ((FB92F8D23 & 16) != null && this.A9EAA4697 != null)
        {
          F95A3E908.m_bstrModule = this.A9EAA4697.Name;
          ref enum_FRAMEINFO_FLAGS local = ref F95A3E908.m_dwValidFields;
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          ^(int&) ref local = ^(int&) ref local | 16;
        }
        if ((FB92F8D23 & 32) != null)
        {
          F95A3E908.m_addrMin = (ulong) this.DA1630840.StartIndex;
          F95A3E908.m_addrMax = (ulong) this.DA1630840.EndIndex;
          ref enum_FRAMEINFO_FLAGS local = ref F95A3E908.m_dwValidFields;
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          ^(int&) ref local = ^(int&) ref local | 32;
        }
        if ((FB92F8D23 & 64) != null)
        {
          F95A3E908.m_pFrame = (IDebugStackFrame2) this;
          ref enum_FRAMEINFO_FLAGS local = ref F95A3E908.m_dwValidFields;
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          ^(int&) ref local = ^(int&) ref local | 64;
        }
        if ((FB92F8D23 & 8) != null)
        {
          F95A3E908.m_bstrLanguage = B0E4D9146.F720FB010;
          ref enum_FRAMEINFO_FLAGS local = ref F95A3E908.m_dwValidFields;
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          ^(int&) ref local = ^(int&) ref local | 8;
        }
        if ((FB92F8D23 & 128) != null)
        {
          F95A3E908.m_fHasDebugInfo = this.A9EAA4697 == null || !((IJdwpReferenceType) this.A9EAA4697).SymbolsLoaded ? 0 : 1;
          ref enum_FRAMEINFO_FLAGS local = ref F95A3E908.m_dwValidFields;
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          ^(int&) ref local = ^(int&) ref local | 128;
        }
        if ((FB92F8D23 & 256) != null)
        {
          F95A3E908.m_fStaleCode = 0;
          ref enum_FRAMEINFO_FLAGS local = ref F95A3E908.m_dwValidFields;
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          ^(int&) ref local = ^(int&) ref local | 256;
        }
        if ((FB92F8D23 & 1024) == null || this.A9EAA4697 == null)
          return;
        if (this.A9EAA4697.Client == null)
          this.A9EAA4697.Client = (object) new E941D6CC6(this.A9EAA4697);
        E941D6CC6 client = (E941D6CC6) this.A9EAA4697.Client;
        F95A3E908.m_pModule = (IDebugModule2) client;
        ref enum_FRAMEINFO_FLAGS local4 = ref F95A3E908.m_dwValidFields;
        // ISSUE: cast to a reference type
        // ISSUE: explicit reference operation
        // ISSUE: cast to a reference type
        // ISSUE: explicit reference operation
        ^(int&) ref local4 = ^(int&) ref local4 | 1024;
      }
    }

    private CE6CCD2B7 DD2E2FFA9(
      enum_DEBUGPROP_INFO_FLAGS A17081D57,
      IJdwpVariable[] CB96E2D48)
    {
      DEBUG_PROPERTY_INFO[] data = new DEBUG_PROPERTY_INFO[CB96E2D48.Length];
      if (CB96E2D48.Length != 0)
      {
        BF602D4D0.E0EE62C88 = this.C1E2C19B9.C826EF455();
        DD3247535 dd3247535 = new DD3247535(this.C1E2C19B9.B3E3893F5, this.D5FF5760A.BAB7FF789(), this.F3C7ADD20);
        D85FA4443[] BBC3AAC66 = Array.ConvertAll<IJdwpVariable, D85FA4443>(CB96E2D48, (Converter<IJdwpVariable, D85FA4443>) (B3FBC3A57 => new D85FA4443(B3FBC3A57, this.C906FD859)));
        D85FA4443.EA2938E0A(this.C1E2C19B9.B3E3893F5, BBC3AAC66);
        int num = 0;
        foreach (ADB5C0658 vi in BBC3AAC66)
        {
          C3BBB6305 c3BbB6305 = new C3BBB6305(vi);
          data[num++] = c3BbB6305.C8A04EC89(A17081D57);
        }
      }
      return new CE6CCD2B7(data);
    }

    private void F5C52031E(
      enum_DEBUGPROP_INFO_FLAGS FE4943494,
      out uint E3737A014,
      out IEnumDebugPropertyInfo2 F0B2FD15B)
    {
      E3737A014 = (uint) (this.A7693AB38.Count + this.EEAD4C256.Count);
      F0B2FD15B = (IEnumDebugPropertyInfo2) this.DD2E2FFA9(FE4943494, ((IEnumerable<IJdwpVariable>) this.EEAD4C256).Concat<IJdwpVariable>((IEnumerable<IJdwpVariable>) this.A7693AB38).ToArray<IJdwpVariable>());
    }

    private void F90E18643(
      enum_DEBUGPROP_INFO_FLAGS BA6DF9688,
      out uint EB8F5F806,
      out IEnumDebugPropertyInfo2 BDFE74D58)
    {
      EB8F5F806 = (uint) this.A7693AB38.Count;
      BDFE74D58 = (IEnumDebugPropertyInfo2) this.DD2E2FFA9(BA6DF9688, this.A7693AB38.ToArray());
    }

    private void AA0C251C3(
      enum_DEBUGPROP_INFO_FLAGS DED5578B0,
      out uint DDC59E71A,
      out IEnumDebugPropertyInfo2 E8C8D8320)
    {
      DDC59E71A = (uint) this.EEAD4C256.Count;
      E8C8D8320 = (IEnumDebugPropertyInfo2) this.DD2E2FFA9(DED5578B0, this.EEAD4C256.ToArray());
    }

    int IDebugStackFrame2.E93E2F0B6(
      enum_DEBUGPROP_INFO_FLAGS D80F99751,
      uint ECBF16566,
      ref Guid A34BCB4B0,
      uint A82371DA5,
      out uint A0A43FA50,
      out IEnumDebugPropertyInfo2 E31766BCF)
    {
      A0A43FA50 = 0U;
      E31766BCF = (IEnumDebugPropertyInfo2) null;
      int num;
      try
      {
        if (A34BCB4B0 == EC594D2A3.ADBD5B3E1 || A34BCB4B0 == EC594D2A3.ABA2B0EF4 || A34BCB4B0 == EC594D2A3.E6A1E6BBC)
        {
          this.F5C52031E(D80F99751, out A0A43FA50, out E31766BCF);
          num = 0;
        }
        else if (A34BCB4B0 == EC594D2A3.C34EE4F4A)
        {
          this.F90E18643(D80F99751, out A0A43FA50, out E31766BCF);
          num = 0;
        }
        else if (A34BCB4B0 == EC594D2A3.A2267B562)
        {
          this.AA0C251C3(D80F99751, out A0A43FA50, out E31766BCF);
          num = 0;
        }
        else
          num = 1;
      }
      catch (ComponentException ex)
      {
        return ((Exception) ex).HResult;
      }
      catch (Exception ex)
      {
        return A09717160.ABD5D2EFF(ex);
      }
      return num;
    }

    int IDebugStackFrame2.FE4EEEB83(out IDebugCodeContext2 BFDEBEF5D)
    {
      BFDEBEF5D = (IDebugCodeContext2) null;
      try
      {
        BFDEBEF5D = (IDebugCodeContext2) new E604AB64A(this.C1E2C19B9, this.F3C7ADD20.Location);
        return 0;
      }
      catch (ComponentException ex)
      {
        return ((Exception) ex).HResult;
      }
      catch (Exception ex)
      {
        return A09717160.ABD5D2EFF(ex);
      }
    }

    int IDebugStackFrame2.B3C76DB57(out IDebugProperty2 D7F0EB90D) => throw new NotImplementedException();

    int IDebugStackFrame2.BDB62AABF(out IDebugDocumentContext2 D4FC9A2F9)
    {
      D4FC9A2F9 = (IDebugDocumentContext2) null;
      try
      {
        if (this.A9EAA4697 != null)
        {
          if (!string.IsNullOrWhiteSpace(this.E339C2D65))
          {
            D4FC9A2F9 = (IDebugDocumentContext2) new F21674B78(this.E339C2D65, new TEXT_POSITION()
            {
              dwColumn = 0U,
              dwLine = (uint) this.CD537BC28
            }, new TEXT_POSITION()
            {
              dwColumn = 0U,
              dwLine = (uint) this.CD537BC28
            }, new E604AB64A(this.C1E2C19B9, this.F3C7ADD20.Location));
            return 0;
          }
        }
      }
      catch (ComponentException ex)
      {
        return ((Exception) ex).HResult;
      }
      catch (Exception ex)
      {
        return A09717160.ABD5D2EFF(ex);
      }
      return 1;
    }

    int IDebugStackFrame2.A75EFC43E(out IDebugExpressionContext2 F7C40691A)
    {
      F7C40691A = (IDebugExpressionContext2) this;
      return 0;
    }

    int IDebugStackFrame2.FC398A33C(
      enum_FRAMEINFO_FLAGS CDCED79FC,
      uint CDE7F7038,
      FRAMEINFO[] CF4E78E29)
    {
      try
      {
        this.B9DAA8335(CDCED79FC, out CF4E78E29[0]);
        return 0;
      }
      catch (ComponentException ex)
      {
        return ((Exception) ex).HResult;
      }
      catch (Exception ex)
      {
        return A09717160.ABD5D2EFF(ex);
      }
    }

    int IDebugStackFrame2.AE88508CD(ref string EEB023DBC, ref Guid D992BFC10)
    {
      EEB023DBC = "Java";
      D992BFC10 = EC594D2A3.E0822BBCF;
      return 0;
    }

    int IDebugStackFrame2.A4E62F9CB(out string A841D4D0E)
    {
      A841D4D0E = (string) null;
      try
      {
        A841D4D0E = this.A9EAA4697.Name + "!" + this.DA1630840.Name + "!" + ((object) this.F3C7ADD20.Location).ToString();
        return 0;
      }
      catch (ComponentException ex)
      {
        return ((Exception) ex).HResult;
      }
      catch (Exception ex)
      {
        return A09717160.ABD5D2EFF(ex);
      }
    }

    int IDebugStackFrame2.DD401BAF3(out ulong C6EF1D6FB, out ulong EF2431E42)
    {
      C6EF1D6FB = (ulong) this.DA1630840.StartIndex;
      EF2431E42 = (ulong) this.DA1630840.EndIndex;
      return 0;
    }

    int IDebugStackFrame2.EE52F5D5E(out IDebugThread2 D869BA4DD)
    {
      D869BA4DD = (IDebugThread2) this.D5FF5760A;
      return 0;
    }

    int IDebugExpressionContext2.F0CF681F1(out string F650E8084) => throw new NotImplementedException();

    int IDebugExpressionContext2.CBCC10611(
      string AE4F269C6,
      enum_PARSEFLAGS CBD7E8435,
      uint E26379F2F,
      out IDebugExpression2 E6443DAE8,
      out string B0625B50D,
      out uint D516A245B)
    {
      B0625B50D = (string) null;
      D516A245B = 0U;
      DD3247535 cxt = new DD3247535(this.C1E2C19B9.B3E3893F5, this.D5FF5760A.BAB7FF789(), this.F3C7ADD20);
      ADB5C0658 exp = new ADB5C0658(AE4F269C6, cxt);
      exp.AF927A510();
      if (exp.A0A6085FD)
      {
        E6443DAE8 = (IDebugExpression2) null;
        string displayValue = exp.FC3E9C6DA.DisplayValue;
        B0625B50D = displayValue;
        D516A245B = (uint) displayValue.Length;
        return 1;
      }
      E6443DAE8 = (IDebugExpression2) new E0CF23B5F(exp, this.C1E2C19B9);
      return 0;
    }
  }
}
