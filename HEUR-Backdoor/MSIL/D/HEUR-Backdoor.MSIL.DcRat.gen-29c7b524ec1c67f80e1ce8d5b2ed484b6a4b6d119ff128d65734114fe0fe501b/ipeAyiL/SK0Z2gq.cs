// Decompiled with JetBrains decompiler
// Type: ipeAyiL.SK0Z2gq
// Assembly: jmZGgwW, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a
// MVID: 3D70FD3D-7EEC-4701-9107-04233FCFD67F
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.03\HEUR-Backdoor.MSIL.DcRat.gen-29c7b524ec1c67f80e1ce8d5b2ed484b6a4b6d119ff128d65734114fe0fe501b.exe

using \u0035JPyvlW;
using EUnNX62;
using kgqpfpg;
using Microsoft;
using Microsoft.ServiceHub.HostStub;
using Microsoft.ServiceHub.Utility;
using PCRQbUi;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Security;
using System.Security.Policy;
using System.Threading;
using System.Threading.Tasks;
using xHeK27I;

namespace ipeAyiL
{
  internal sealed class SK0Z2gq : MarshalByRefObject, IServiceManager, IDisposable, IServiceHost
  {
    private const string \u0033nMj9A6 = "//\\\\";
    private const int YliJJoS = 5;
    private readonly object us36lIz = new object();
    private readonly IDictionary<VWXjwyx, IServiceManager> MDmkziK = (IDictionary<VWXjwyx, IServiceManager>) new Dictionary<VWXjwyx, IServiceManager>();
    private readonly IServiceHost i5ClcQD;
    private readonly DevHubTraceSource JGGuy4K;
    private readonly string El5mnu6;
    private readonly CancellationTokenSource Isy6ku3 = new CancellationTokenSource();
    private bool jc3pqYT;
    private int O1Jl0xW;
    private readonly FQG9qSc Ijgzv01;

    internal SK0Z2gq(IServiceHost host, DevHubTraceSource logger, string pipeName)
    {
      Requires.NotNull<IServiceHost>(host, nameof (host));
      Requires.NotNull<DevHubTraceSource>(logger, nameof (logger));
      this.i5ClcQD = host;
      this.JGGuy4K = logger;
      this.El5mnu6 = pipeName;
      this.Ijgzv01 = new FQG9qSc(this.JGGuy4K, this.Isy6ku3.Token);
    }

    [SecurityCritical]
    public virtual object \u0039jYOveP() => (object) null;

    public void RaaPaCI() => this.idOb4jp(true);

    private void idOb4jp(bool qt0IM58)
    {
      if (!qt0IM58 || this.jc3pqYT)
        return;
      this.jc3pqYT = true;
      this.Isy6ku3.Cancel();
      lock (this.us36lIz)
      {
        foreach (IDisposable disposable in (IEnumerable<IServiceManager>) this.MDmkziK.Values)
          disposable.Dispose();
      }
    }

    public void qiege7n()
    {
      this.gvih5lt();
      IServiceManager[] array;
      lock (this.us36lIz)
      {
        this.O1Jl0xW = ((ICollection<KeyValuePair<VWXjwyx, IServiceManager>>) this.MDmkziK).Count;
        array = ((IEnumerable<IServiceManager>) this.MDmkziK.Values).ToArray<IServiceManager>();
      }
      if (this.O1Jl0xW == 0)
      {
        this.i5ClcQD.AllServicesDisposed();
      }
      else
      {
        foreach (IServiceManager iserviceManager in array)
          iserviceManager.DisposeServices();
      }
    }

    public Task<string> C3nOZ3g(ServiceModuleInfo I2wVTYA, string Kpi9YyN)
    {
      Requires.NotNull<ServiceModuleInfo>(I2wVTYA, "smi");
      this.gvih5lt();
      int num = 0;
      while (true)
      {
        try
        {
          VWXjwyx vwXjwyx = SK0Z2gq.\u0035YhO2qx(I2wVTYA, this.El5mnu6);
          IServiceManager iserviceManager;
          lock (this.us36lIz)
          {
            if (this.MDmkziK.TryGetValue(vwXjwyx, out iserviceManager))
            {
              this.JGGuy4K.TraceInformation("Service '{0}' will start in existing {1}", new object[2]
              {
                (object) I2wVTYA.Name,
                (object) vwXjwyx
              });
            }
            else
            {
              iserviceManager = this.QHgeyg1(vwXjwyx, I2wVTYA);
              this.MDmkziK.Add(vwXjwyx, iserviceManager);
            }
          }
          MarshalledTask<string> marshalledTask = new MarshalledTask<string>();
          iserviceManager.StartService(I2wVTYA, Kpi9YyN, marshalledTask);
          return marshalledTask.Task;
        }
        catch (FileLoadException ex)
        {
          if (num < 5)
          {
            ++num;
          }
          else
          {
            TraceSourceExtensions.TraceException((TraceSource) this.JGGuy4K, (Exception) ex, "Error starting service '{0}'", new object[1]
            {
              (object) I2wVTYA.Name
            });
            throw;
          }
        }
        catch (Exception ex)
        {
          TraceSourceExtensions.TraceException((TraceSource) this.JGGuy4K, ex, "Error starting service '{0}'", new object[1]
          {
            (object) I2wVTYA.Name
          });
          throw;
        }
      }
    }

    public void gb0FLMi(ServiceModuleInfo zHzWeVo, string _param2, MarshalledTask<string> hBo64wR)
    {
      // ISSUE: object of a compiler-generated type is created
      // ISSUE: variable of a compiler-generated type
      nh7QlOa.\u0034j4Rjuo obj = new nh7QlOa.\u0034j4Rjuo();
      // ISSUE: reference to a compiler-generated field
      obj.N2O0e33 = hBo64wR;
      // ISSUE: reference to a compiler-generated field
      obj.\u00393b1AgX = this;
      // ISSUE: reference to a compiler-generated field
      obj.ZCI36IL = zHzWeVo;
      // ISSUE: reference to a compiler-generated field
      obj.n8zGXZU = _param2;
      // ISSUE: reference to a compiler-generated field
      Requires.NotNull<ServiceModuleInfo>(obj.ZCI36IL, "smi");
      // ISSUE: reference to a compiler-generated field
      Requires.NotNull<MarshalledTask<string>>(obj.N2O0e33, "tsc");
      // ISSUE: reference to a compiler-generated method
      Task.Run(new Func<Task>(((SK0Z2gq.HbgEMHR) obj).rTQKJXH));
    }

    public void oCaEGoz(string FcGqx5W)
    {
      IServiceManager[] array;
      lock (this.us36lIz)
        array = ((IEnumerable<IServiceManager>) this.MDmkziK.Values).ToArray<IServiceManager>();
      foreach (IServiceManager iserviceManager in array)
        iserviceManager.CancelServiceRequest(FcGqx5W);
    }

    public void ndtiCYF()
    {
      this.gvih5lt();
      this.i5ClcQD.ServicesStarted();
    }

    public void \u0034MtMGMY()
    {
      this.gvih5lt();
      this.i5ClcQD.AllServicesEnded();
    }

    public void S8wsKrW()
    {
      this.gvih5lt();
      bool flag;
      lock (this.us36lIz)
      {
        Verify.Operation(this.O1Jl0xW > 0, \u0030oLjw4e.n2zC6Uh, (object) "AllServicesDisposed");
        --this.O1Jl0xW;
        flag = this.O1Jl0xW == 0;
      }
      if (!flag)
        return;
      this.i5ClcQD.AllServicesDisposed();
    }

    private IServiceManager QHgeyg1(VWXjwyx FywJws8, ServiceModuleInfo DAplZVj)
    {
      Requires.NotNull<VWXjwyx>(FywJws8, "domainKey");
      Requires.NotNull<ServiceModuleInfo>(DAplZVj, "smi");
      AppDomainSetup info = new AppDomainSetup()
      {
        ApplicationBase = FywJws8.c0uBawp,
        ConfigurationFile = FywJws8.Z7wMiOM ?? string.Empty,
        LoaderOptimization = FywJws8.nexeJuN
      };
      string friendlyName = Path.GetFileName(FywJws8.c0uBawp.TrimEnd(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar, '.'));
      if (!string.IsNullOrEmpty(FywJws8.Z7wMiOM))
      {
        friendlyName = friendlyName + "/" + Path.GetFileName(FywJws8.Z7wMiOM);
        if (File.Exists(FywJws8.Z7wMiOM))
          info.SetConfigurationBytes(File.ReadAllBytes(FywJws8.Z7wMiOM));
      }
      AppDomain domain = AppDomain.CreateDomain(friendlyName, (Evidence) null, info);
      this.JGGuy4K.TraceInformation("Created new {0} for service '{1}'", new object[2]
      {
        (object) FywJws8,
        (object) DAplZVj.Name
      });
      Type type = typeof (ServiceManagerBootstrapper);
      return ((ServiceManagerBootstrapper) domain.CreateInstanceFromAndUnwrap(type.Assembly.Location, type.FullName)).Start((IServiceHost) this, DAplZVj.Name, (IServiceBrokerServerDisposer) this.Ijgzv01);
    }

    private static VWXjwyx \u0035YhO2qx(ServiceModuleInfo Z8i4w5H, string EZ1DXIy)
    {
      Requires.NotNull<ServiceModuleInfo>(Z8i4w5H, "smi");
      Requires.Argument(Z8i4w5H.EntryPoint != null, "smi", \u0030oLjw4e.sgQu6iT, (object) "EntryPoint");
      Requires.Argument(!string.IsNullOrWhiteSpace(Z8i4w5H.EntryPoint.AssemblyPath), "smi", \u0030oLjw4e.\u0033ga91x2, (object) "EntryPoint", (object) "AssemblyPath");
      string fullPath = Path.GetFullPath(Path.Combine(Z8i4w5H.ServiceBaseDirectory, Z8i4w5H.EntryPoint.AssemblyPath));
      string str = (string) null;
      if (!string.IsNullOrEmpty(Z8i4w5H.EntryPoint.ConfigPath))
      {
        str = Path.GetFullPath(Path.Combine(Z8i4w5H.ServiceBaseDirectory, Z8i4w5H.EntryPoint.ConfigPath));
        if (!File.Exists(str))
        {
          int num = EZ1DXIy.LastIndexOf("//\\\\");
          if (num == -1)
            throw new c2lzwCO((c2lzwCO.oCFiYwT) 12, string.Format((IFormatProvider) CultureInfo.CurrentCulture, \u0030oLjw4e.Ez5rvG5, (object) str));
          string path2 = EZ1DXIy.Substring(num + "//\\\\".Length);
          str = Path.GetFullPath(Path.Combine(Z8i4w5H.ServiceBaseDirectory, path2));
          if (!File.Exists(str))
            throw new c2lzwCO((c2lzwCO.oCFiYwT) 12, string.Format((IFormatProvider) CultureInfo.CurrentCulture, \u0030oLjw4e.Ez5rvG5, (object) str));
        }
      }
      else if (File.Exists(fullPath + ".config"))
        str = fullPath + ".config";
      string appBaseDirectory = Path.GetDirectoryName(fullPath);
      if (!string.IsNullOrEmpty(Z8i4w5H.EntryPoint.AppBasePath))
        appBaseDirectory = Path.GetFullPath(Path.Combine(Z8i4w5H.ServiceBaseDirectory, Z8i4w5H.EntryPoint.AppBasePath));
      bool? loaderOptimization1 = Z8i4w5H.SingleDomainLoaderOptimization;
      int num1;
      if (loaderOptimization1.HasValue)
      {
        loaderOptimization1 = Z8i4w5H.SingleDomainLoaderOptimization;
        if (loaderOptimization1.Value)
        {
          num1 = 1;
          goto label_14;
        }
      }
      num1 = 2;
label_14:
      LoaderOptimization loaderOptimization2 = (LoaderOptimization) num1;
      return new VWXjwyx(appBaseDirectory, str, loaderOptimization2);
    }

    private void gvih5lt()
    {
      if (this.jc3pqYT)
        throw new ObjectDisposedException(this.GetType().Name);
    }
  }
}
