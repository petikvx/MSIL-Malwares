// Decompiled with JetBrains decompiler
// Type: System.ServiceModel.Channels.HttpStreamMessage
// Assembly: Microsoft.Transactions.Bridge, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 51116F84-6FE2-4BD6-A908-2C88E06F45BB
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.07\HEUR-Trojan.MSIL.Picsys.gen-d64123468b2dcb11e9205288e0a6cb144a448944457a708807b7345a8a766675.exe

using System.Runtime;
using System.Xml;

namespace System.ServiceModel.Channels
{
  internal class HttpStreamMessage : Message
  {
    internal const string StreamElementName = "Binary";
    private BodyWriter bodyWriter;
    private MessageHeaders headers;
    private MessageProperties properties;

    public HttpStreamMessage(BodyWriter writer)
    {
      this.bodyWriter = writer != null ? writer : throw DiagnosticUtility.ExceptionUtility.ThrowHelperArgumentNull(nameof (writer));
      this.headers = new MessageHeaders(MessageVersion.None, 1);
      this.properties = new MessageProperties();
    }

    public HttpStreamMessage(
      MessageHeaders headers,
      MessageProperties properties,
      BodyWriter bodyWriter)
    {
      if (bodyWriter == null)
        throw DiagnosticUtility.ExceptionUtility.ThrowHelperArgumentNull(nameof (bodyWriter));
      this.headers = new MessageHeaders(headers);
      this.properties = new MessageProperties(properties);
      this.bodyWriter = bodyWriter;
    }

    public override MessageHeaders Headers
    {
      get
      {
        if (this.IsDisposed)
          throw DiagnosticUtility.ExceptionUtility.ThrowHelperError(this.CreateDisposedException());
        return this.headers;
      }
    }

    public override bool IsEmpty => false;

    public override bool IsFault => false;

    public override MessageProperties Properties
    {
      get
      {
        if (this.IsDisposed)
          throw DiagnosticUtility.ExceptionUtility.ThrowHelperError(this.CreateDisposedException());
        return this.properties;
      }
    }

    public override MessageVersion Version
    {
      get
      {
        if (this.IsDisposed)
          throw DiagnosticUtility.ExceptionUtility.ThrowHelperError(this.CreateDisposedException());
        return MessageVersion.None;
      }
    }

    protected override void OnBodyToString(XmlDictionaryWriter writer)
    {
      if (this.bodyWriter.IsBuffered)
      {
        this.bodyWriter.WriteBodyContents(writer);
      }
      else
      {
        // ISSUE: reference to a compiler-generated method
        writer.WriteString(SR2.GetString(SR2.MessageBodyIsStream));
      }
    }

    protected override void OnClose()
    {
      Exception exception = (Exception) null;
      try
      {
        base.OnClose();
      }
      catch (Exception ex)
      {
        if (Fx.IsFatal(ex))
          throw;
        else
          exception = ex;
      }
      try
      {
        if (this.properties != null)
          this.properties.Dispose();
      }
      catch (Exception ex)
      {
        if (Fx.IsFatal(ex))
          throw;
        else if (exception == null)
          exception = ex;
      }
      if (exception != null)
        throw DiagnosticUtility.ExceptionUtility.ThrowHelperError(exception);
      this.bodyWriter = (BodyWriter) null;
    }

    protected override MessageBuffer OnCreateBufferedCopy(int maxBufferSize) => (MessageBuffer) new HttpStreamMessage.HttpStreamMessageBuffer(this.Headers, new MessageProperties(this.Properties), !this.bodyWriter.IsBuffered ? this.bodyWriter.CreateBufferedCopy(maxBufferSize) : this.bodyWriter);

    protected override void OnWriteBodyContents(XmlDictionaryWriter writer) => this.bodyWriter.WriteBodyContents(writer);

    private Exception CreateDisposedException() => (Exception) new ObjectDisposedException("", SR2.GetString(SR2.MessageClosed));

    private class HttpStreamMessageBuffer : MessageBuffer
    {
      private BodyWriter bodyWriter;
      private bool closed;
      private MessageHeaders headers;
      private MessageProperties properties;
      private object thisLock = new object();

      public HttpStreamMessageBuffer(
        MessageHeaders headers,
        MessageProperties properties,
        BodyWriter bodyWriter)
      {
        this.bodyWriter = bodyWriter;
        this.headers = headers;
        this.properties = properties;
      }

      public override int BufferSize => 0;

      private object ThisLock => this.thisLock;

      public override void Close()
      {
        lock (this.ThisLock)
        {
          if (this.closed)
            return;
          this.closed = true;
          this.bodyWriter = (BodyWriter) null;
          this.headers = (MessageHeaders) null;
          this.properties = (MessageProperties) null;
        }
      }

      public override Message CreateMessage()
      {
        lock (this.ThisLock)
        {
          if (this.closed)
            throw DiagnosticUtility.ExceptionUtility.ThrowHelperError(this.CreateDisposedException());
          return (Message) new HttpStreamMessage(this.headers, this.properties, this.bodyWriter);
        }
      }

      private Exception CreateDisposedException() => (Exception) new ObjectDisposedException("", SR2.GetString(SR2.MessageBufferIsClosed));
    }
  }
}
