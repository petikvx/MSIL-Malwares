// Decompiled with JetBrains decompiler
// Type: System.ServiceModel.Dispatcher.ContentTypeSettingDispatchMessageFormatter
// Assembly: Microsoft.Transactions.Bridge, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 51116F84-6FE2-4BD6-A908-2C88E06F45BB
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.07\HEUR-Trojan.MSIL.Picsys.gen-d64123468b2dcb11e9205288e0a6cb144a448944457a708807b7345a8a766675.exe

using System.Net;
using System.ServiceModel.Channels;
using System.ServiceModel.Web;

namespace System.ServiceModel.Dispatcher
{
  internal class ContentTypeSettingDispatchMessageFormatter : IDispatchMessageFormatter
  {
    private IDispatchMessageFormatter innerFormatter;
    private string outgoingContentType;

    public ContentTypeSettingDispatchMessageFormatter(
      string outgoingContentType,
      IDispatchMessageFormatter innerFormatter)
    {
      if (outgoingContentType == null)
        throw DiagnosticUtility.ExceptionUtility.ThrowHelperArgumentNull(nameof (outgoingContentType));
      if (innerFormatter == null)
        throw DiagnosticUtility.ExceptionUtility.ThrowHelperArgumentNull(nameof (innerFormatter));
      this.outgoingContentType = outgoingContentType;
      this.innerFormatter = innerFormatter;
    }

    public void DeserializeRequest(Message message, object[] parameters) => this.innerFormatter.DeserializeRequest(message, parameters);

    public Message SerializeReply(
      MessageVersion messageVersion,
      object[] parameters,
      object result)
    {
      Message message = this.innerFormatter.SerializeReply(messageVersion, parameters, result);
      if (message != null)
        ContentTypeSettingDispatchMessageFormatter.AddResponseContentTypeProperty(message, this.outgoingContentType);
      return message;
    }

    private static void AddResponseContentTypeProperty(Message message, string contentType)
    {
      if (message == null)
        throw DiagnosticUtility.ExceptionUtility.ThrowHelperArgumentNull(nameof (message));
      if (contentType == null)
        throw DiagnosticUtility.ExceptionUtility.ThrowHelperArgumentNull(nameof (contentType));
      if (OperationContext.Current != null && OperationContext.Current.HasOutgoingMessageProperties)
      {
        if (!string.IsNullOrEmpty(WebOperationContext.Current.OutgoingResponse.ContentType))
          return;
        WebOperationContext.Current.OutgoingResponse.ContentType = contentType;
      }
      else
      {
        object obj;
        message.Properties.TryGetValue(HttpResponseMessageProperty.Name, out obj);
        HttpResponseMessageProperty property;
        if (obj != null)
        {
          property = (HttpResponseMessageProperty) obj;
        }
        else
        {
          property = new HttpResponseMessageProperty();
          message.Properties.Add(HttpResponseMessageProperty.Name, (object) property);
        }
        if (!string.IsNullOrEmpty(property.Headers[HttpResponseHeader.ContentType]))
          return;
        property.Headers[HttpResponseHeader.ContentType] = contentType;
      }
    }
  }
}
