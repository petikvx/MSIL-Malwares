// Decompiled with JetBrains decompiler
// Type: s149697224745174.s683291852413404
// Assembly: s968508024776124, Version=2.0.47.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a
// MVID: E3596912-35E7-405B-A05A-F5F12AB5E292
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.04\HEUR-Trojan.MSIL.PowerShell.gen-b1729c7ae8423cc844b16aa10ca8ddd2b2331adbfb6646d80d73381fbc73a109.exe

using s025420649509424;
using s065175910567653;
using s092719836152703;
using s111377166353221;
using s297449729949532;
using s418410312208900;
using s466899421896987;
using s528813736053581;
using s584120839923761;
using s878358404072606;
using s962360155664524;
using s985393833263885;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Diagnostics.Tracing;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
using System.Text;
using TraceReloggerLib;

namespace s149697224745174
{
  public class s683291852413404 : s726691949965431
  {
    private EventListener s004661951053370;
    private CTraceRelogger s756627861499019;
    private ulong s450380616754797;
    private s683291852413404.s933015187655976 s971060188772219;
    private int s537543681607508;
    private unsafe byte* s240896299369574;
    private int s741171577885633;
    private ITraceEvent s173328851376737;
    private unsafe s134995860702422.s648877553938236* s605435059603802;
    private s370345380266841 s757265221305603;

    public s683291852413404(string inputFileName, string outputFileName)
      : this(inputFileName, s707087110524030.MergeAll, outputFileName)
    {
    }

    public unsafe s683291852413404(
      string fileOrSessionName,
      s707087110524030 type,
      string outputFileName)
    {
      if (!s752892378058130.s569164546966561(62))
        throw new NotSupportedException("System Tracing is only supported on Windows 8 and above.");
      this.s756627861499019 = (CTraceRelogger) new CTraceReloggerClass();
      switch (type)
      {
        case s707087110524030.FileOnly:
          this.s450380616754797 = ((ITraceRelogger) this.s756627861499019).AddLogfileTraceStream(fileOrSessionName, IntPtr.Zero);
          break;
        case s707087110524030.Session:
          this.s450380616754797 = ((ITraceRelogger) this.s756627861499019).AddRealtimeTraceStream(fileOrSessionName, IntPtr.Zero);
          break;
        default:
          List<string> stringList = s302986156607931.s265453676981728(fileOrSessionName);
          bool flag = true;
          using (List<string>.Enumerator enumerator = stringList.GetEnumerator())
          {
            while (enumerator.MoveNext())
            {
              ulong num = ((ITraceRelogger) this.s756627861499019).AddLogfileTraceStream(enumerator.Current, IntPtr.Zero);
              if (flag)
              {
                this.s450380616754797 = num;
                flag = false;
              }
            }
            break;
          }
      }
      ((ITraceRelogger) this.s756627861499019).SetOutputFilename(outputFileName);
      this.s971060188772219 = (s683291852413404.s933015187655976) new s683291852413404.s896798951956110(this);
      ((ITraceRelogger) this.s756627861499019).RegisterCallback((ITraceEventCallback) this.s971060188772219);
      this.s741171577885633 = 0;
      this.s240896299369574 = (byte*) null;
    }

    public bool s544653139343569
    {
      set => ((ITraceRelogger) this.s756627861499019).SetCompressionMode(value ? (sbyte) 1 : (sbyte) 0);
    }

    public unsafe void s394238543940998(s034852122986107 s095432089469597)
    {
      if (s095432089469597.s598076025198321 != this.s605435059603802)
        throw new InvalidOperationException("Currently can only write the event being processed by the callback");
      ((ITraceRelogger) this.s756627861499019).Inject(this.s173328851376737);
    }

    public void s894184225521687(EventSource s804973631748761)
    {
      if (this.s004661951053370 == null)
      {
        // ISSUE: object of a compiler-generated type is created
        this.s004661951053370 = (EventListener) new s384585984974928.s976838324909387(this);
      }
      this.s004661951053370.EnableEvents(s804973631748761, EventLevel.Verbose, EventKeywords.All);
    }

    public unsafe void s835191429572438(
      Guid s837128884686869,
      ref _EVENT_DESCRIPTOR s233553922701114,
      s034852122986107 s520537200664128,
      params object[] s309153925513186)
    {
      if (s520537200664128.s598076025198321 != this.s605435059603802)
        throw new InvalidOperationException("Currently can only write the event being processed by the callback");
      ITraceEvent s130831011307530 = this.s173328851376737.Clone();
      fixed (_EVENT_DESCRIPTOR* eventDescriptorPtr = &s233553922701114)
      {
        s130831011307530.SetEventDescriptor(ref *eventDescriptorPtr);
        s130831011307530.SetProviderId(ref s837128884686869);
        this.s689581845929056(s130831011307530, (IList<object>) s309153925513186);
        ((ITraceRelogger) this.s756627861499019).Inject(s130831011307530);
      }
    }

    public unsafe void s325157820731551(
      Guid s294342669971991,
      ref _EVENT_DESCRIPTOR s237004427301855,
      DateTime s503929634386299,
      int s358632330830374,
      int s282535735219909,
      int s850319101315241,
      Guid s362165135895455,
      params object[] s251811250248600)
    {
      ITraceEvent eventInstance = ((ITraceRelogger) this.s756627861499019).CreateEventInstance(this.s450380616754797, this.s824321134384686 == 8 ? 64U : 32U);
      fixed (_EVENT_DESCRIPTOR* eventDescriptorPtr = &s237004427301855)
      {
        eventInstance.SetEventDescriptor(ref *eventDescriptorPtr);
        eventInstance.SetProviderId(ref s294342669971991);
        eventInstance.SetTimeStamp(ref new _LARGE_INTEGER()
        {
          QuadPart = s503929634386299.ToFileTimeUtc()
        });
        eventInstance.SetProcessId((uint) s358632330830374);
        eventInstance.SetProcessorIndex((uint) s282535735219909);
        eventInstance.SetThreadId((uint) s850319101315241);
        eventInstance.SetActivityId(ref s362165135895455);
        this.s689581845929056(eventInstance, (IList<object>) s251811250248600);
        ((ITraceRelogger) this.s756627861499019).Inject(eventInstance);
      }
    }

    public virtual int s623128049220269 => this.s537543681607508;

    public virtual bool s802445812048039()
    {
      ((ITraceRelogger) this.s756627861499019).ProcessTrace();
      return !this.s301783657697048;
    }

    protected override unsafe void Dispose(bool disposing)
    {
      if (disposing)
      {
        if (this.s756627861499019 != null)
          Marshal.FinalReleaseComObject((object) this.s756627861499019);
        if (this.s004661951053370 != null)
        {
          this.s004661951053370.Dispose();
          this.s004661951053370 = (EventListener) null;
        }
        GC.SuppressFinalize((object) this);
      }
      if ((IntPtr) this.s240896299369574 != IntPtr.Zero)
        Marshal.FreeHGlobal((IntPtr) (void*) this.s240896299369574);
      this.s240896299369574 = (byte*) null;
      this.s741171577885633 = 0;
      this.s756627861499019 = (CTraceRelogger) null;
      this.s757265221305603.s091031820654218();
    }

    public virtual void s752816323218532()
    {
      this.s536266016348602();
      ((ITraceRelogger) this.s756627861499019).Cancel();
    }

    private unsafe void s689581845929056(
      ITraceEvent s130831011307530,
      IList<object> s049334780274690)
    {
      int num1 = 0;
      foreach (object obj in (IEnumerable<object>) s049334780274690)
      {
        Type type = obj.GetType();
        if (type == typeof (string))
        {
          string str = (string) obj;
          int num2 = (str.Length + 1) * 2;
          int s210888222351867 = num1 + num2;
          this.s505846630761661(s210888222351867);
          char* chPtr1 = (char*) (this.s240896299369574 + num1);
          fixed (char* chPtr2 = str)
          {
            for (int index = 0; index < str.Length; ++index)
              chPtr1[index] = chPtr2[index];
            chPtr1[str.Length] = char.MinValue;
          }
          num1 = s210888222351867;
        }
        else if (type == typeof (int))
        {
          this.s505846630761661(num1 + 4);
          *(int*) (this.s240896299369574 + num1) = (int) obj;
          num1 += 4;
        }
        else if (type == typeof (long))
        {
          this.s505846630761661(num1 + 8);
          *(long*) (this.s240896299369574 + num1) = (long) obj;
          num1 += 8;
        }
        else if (type == typeof (double))
        {
          this.s505846630761661(num1 + 8);
          *(double*) (this.s240896299369574 + num1) = (double) obj;
          num1 += 8;
        }
        else
        {
          if (!(type == typeof (ulong)))
            throw new NotImplementedException();
          this.s505846630761661(num1 + 8);
          *(long*) (this.s240896299369574 + num1) = (long) (ulong) obj;
          num1 += 8;
        }
      }
      s130831011307530.SetPayload(ref *this.s240896299369574, (uint) num1);
    }

    private unsafe void s505846630761661(int s210888222351867)
    {
      if (this.s741171577885633 >= s210888222351867)
        return;
      this.s240896299369574 = (IntPtr) this.s240896299369574 == IntPtr.Zero ? (byte*) (void*) Marshal.AllocHGlobal(s210888222351867) : (byte*) (void*) Marshal.ReAllocHGlobal((IntPtr) (void*) this.s240896299369574, (IntPtr) s210888222351867);
      this.s741171577885633 = s210888222351867;
    }

    internal void s730618609848872(byte[] s033024820399646, EventSource s439288267666410)
    {
      // ISSUE: unable to decompile the method.
    }

    private class s896798951956110 : EventListener
    {
      private bool[] s197535449909747;
      private s683291852413404 s194484345462792;

      protected override unsafe void OnEventWritten(EventWrittenEventArgs eventData)
      {
        this.s752412061158932(eventData.EventSource);
        // ISSUE: reference to a compiler-generated field
        s683291852413404 s218774944914453 = ((s384585984974928.s976838324909387) this).s218774944914453;
        ITraceEvent eventInstance = ((ITraceRelogger) s218774944914453.s756627861499019).CreateEventInstance(s218774944914453.s450380616754797, 0U);
        eventInstance.SetEventDescriptor(ref new _EVENT_DESCRIPTOR()
        {
          Id = (ushort) eventData.EventId,
          Keyword = (ulong) eventData.Keywords,
          Level = (byte) eventData.Level,
          Opcode = (byte) eventData.Opcode,
          Task = (ushort) eventData.Task,
          Version = eventData.Version
        });
        Guid guid = eventData.EventSource.Guid;
        eventInstance.SetProviderId(ref guid);
        _EVENT_RECORD* eventRecord = (_EVENT_RECORD*) (void*) s218774944914453.s173328851376737.GetEventRecord();
        eventInstance.SetThreadId(eventRecord->EventHeader.ThreadId);
        eventInstance.SetProcessId(eventRecord->EventHeader.ProcessId);
        eventInstance.SetTimeStamp(ref eventRecord->EventHeader.TimeStamp);
        s218774944914453.s689581845929056(eventInstance, (IList<object>) eventData.Payload);
        ((ITraceRelogger) s218774944914453.s756627861499019).Inject(eventInstance);
      }

      private void s752412061158932(EventSource s428158728124565)
      {
        int index = EventListener.EventSourceIndex(s428158728124565);
        if (this.s197535449909747.Length <= index)
        {
          bool[] destinationArray = new bool[index + 4];
          Array.Copy((Array) this.s197535449909747, (Array) destinationArray, this.s197535449909747.Length);
          this.s197535449909747 = destinationArray;
        }
        if (this.s197535449909747[index])
          return;
        this.s197535449909747[index] = true;
        // ISSUE: reference to a compiler-generated field
        ((s384585984974928.s976838324909387) this).s218774944914453.s730618609848872(Encoding.UTF8.GetBytes(EventSource.GenerateManifest(s428158728124565.GetType(), s428158728124565.Name)), s428158728124565);
      }

      public s896798951956110(s683291852413404 source) => this.s194484345462792 = source;
    }

    private class s933015187655976 : ITraceEventCallback
    {
      [SpecialName]
      public int value__;

      public unsafe void s774258265606331(
        ITraceEvent s273632297755734,
        CTraceRelogger s005762502704080)
      {
        this.s779507334729408((s134995860702422.s648877553938236*) (void*) s273632297755734.GetEventRecord());
      }

      public unsafe void s255254658374436(
        ITraceEvent s296970437649907,
        CTraceRelogger s252577203847611)
      {
        s134995860702422.s648877553938236* eventRecord = (s134995860702422.s648877553938236*) (void*) s296970437649907.GetEventRecord();
        s683291852413404 s194484345462792 = ((s683291852413404.s896798951956110) this).s194484345462792;
        if (s194484345462792.s301783657697048)
          return;
        if (((s683291852413404.s896798951956110) this).s194484345462792.s843632117898745 == 0L)
          this.s779507334729408(eventRecord);
        s194484345462792.s757265221305603.s332283293464676(eventRecord);
        s034852122986107 s180318052354735 = s194484345462792.s128380686175907(eventRecord);
        s194484345462792.s173328851376737 = s296970437649907;
        s194484345462792.s605435059603802 = s180318052354735.s598076025198321;
        if (s180318052354735.s841790547125492)
          s180318052354735.s204978232629101();
        s194484345462792.s551418563715328(s180318052354735);
        Marshal.FinalReleaseComObject((object) s194484345462792.s173328851376737);
        s194484345462792.s173328851376737 = (ITraceEvent) null;
      }

      public void s786743766208505(CTraceRelogger s195361553630812)
      {
      }

      private unsafe void s779507334729408(
        s134995860702422.s648877553938236* s518894084197861)
      {
        s435513404871277 s435513404871277 = new s435513404871277((Action<s435513404871277>) null, (int) ushort.MaxValue, 0, "EventTrace", s137522757078529.s209864620798100, 0, "Header", s137522757078529.s830809025931954, s137522757078529.s600339361085624, (s465400585338729) null);
        s435513404871277.s388204795291822 = (s470725726477034) ((s683291852413404.s896798951956110) this).s194484345462792;
        s435513404871277.s598076025198321 = s518894084197861;
        s435513404871277.s969799445044717 = s518894084197861->s066345635431405;
        if (((s134995860702422.s728170393225391*) s435513404871277.s598076025198321)->s870227314561507.s865414040669856 != s435513404871277.s966949059091664 || ((s134995860702422.s728170393225391*) s435513404871277.s598076025198321)->s870227314561507.s611740701286585 != (byte) 0)
        {
          if (((s683291852413404.s896798951956110) this).s194484345462792.s843632117898745 != 0L)
            return;
          ((s683291852413404.s896798951956110) this).s194484345462792.s824321134384686 = s302986156607931.s300084204096549();
          ((s683291852413404.s896798951956110) this).s194484345462792.s558633164156824 = Environment.ProcessorCount;
          ((s683291852413404.s896798951956110) this).s194484345462792.s605285401142765 = Stopwatch.Frequency;
          ((s683291852413404.s896798951956110) this).s194484345462792.s715999696684854 = DateTime.UtcNow;
          ((s683291852413404.s896798951956110) this).s194484345462792.s843632117898745 = ((s134995860702422.s728170393225391*) s518894084197861)->s870227314561507.s473266651679490;
          ((s683291852413404.s896798951956110) this).s194484345462792.s432147997440474 = ((s134995860702422.s728170393225391*) s518894084197861)->s870227314561507.s473266651679490;
          ((s683291852413404.s896798951956110) this).s194484345462792.s560950662468685 = long.MaxValue;
        }
        else
        {
          ((s683291852413404.s896798951956110) this).s194484345462792.s537543681607508 += s435513404871277.s968796486135856;
          if (((s683291852413404.s896798951956110) this).s194484345462792.s843632117898745 != 0L)
            return;
          ((s683291852413404.s896798951956110) this).s194484345462792.s824321134384686 = s435513404871277.s067205517243458;
          ((s683291852413404.s896798951956110) this).s194484345462792.s558633164156824 = s435513404871277.s186196049737677;
          ((s683291852413404.s896798951956110) this).s194484345462792.s336446448723642 = s435513404871277.s637772635539676;
          ((s683291852413404.s896798951956110) this).s194484345462792.s348947355737433 = new int?(s435513404871277.s872343592715923);
          int s609993866832959 = s435513404871277.s609993866832959;
          ((s683291852413404.s896798951956110) this).s194484345462792.s745687107734249 = new Version((int) (byte) s609993866832959, (int) (byte) (s609993866832959 >> 8));
          ((s683291852413404.s896798951956110) this).s194484345462792.s605285401142765 = s435513404871277.s152079335837424;
          ((s683291852413404.s896798951956110) this).s194484345462792.s715999696684854 = DateTime.FromFileTimeUtc(s435513404871277.s421685687524409);
          ((s683291852413404.s896798951956110) this).s194484345462792.s843632117898745 = ((s134995860702422.s728170393225391*) s518894084197861)->s870227314561507.s473266651679490;
          ((s683291852413404.s896798951956110) this).s194484345462792.s432147997440474 = ((s134995860702422.s728170393225391*) s518894084197861)->s870227314561507.s473266651679490;
          if (s435513404871277.s911609475885631 == 0L)
            ((s683291852413404.s896798951956110) this).s194484345462792.s560950662468685 = long.MaxValue;
          else
            ((s683291852413404.s896798951956110) this).s194484345462792.s560950662468685 = ((s683291852413404.s896798951956110) this).s194484345462792.s048532042555637(DateTime.FromFileTimeUtc(s435513404871277.s911609475885631));
        }
      }

      public int s256821150448190(s302986156607931.s808831215449236 s620937057282113)
      {
        int num1 = ((s302986156607931.s808831215449236) this).s351731687773735.CompareTo(s620937057282113.s351731687773735);
        if (num1 != 0)
          return num1;
        int num2 = ((s302986156607931.s758934652151773) this).s034893317423019 - ((s302986156607931.s758934652151773) s620937057282113).s034893317423019;
        return num2 != 0 ? num2 : ((s302986156607931.s808831215449236) this).s139854256785270.CompareTo(s620937057282113.s139854256785270);
      }
    }
  }
}
