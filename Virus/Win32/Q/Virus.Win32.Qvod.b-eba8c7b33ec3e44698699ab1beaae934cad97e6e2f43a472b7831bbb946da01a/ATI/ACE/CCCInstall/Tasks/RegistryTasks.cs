// Decompiled with JetBrains decompiler
// Type: ATI.ACE.CCCInstall.Tasks.RegistryTasks
// Assembly: CCCInstall, Version=2.0.3274.26237, Culture=neutral, PublicKeyToken=null
// MVID: A3863DD5-25D9-4041-8436-FCCC1F09C036
// Assembly location: C:\Users\Administrateur\Downloads\VirusShare_CryptoRansom_20160715-msil\Virus.Win32.Qvod.b-eba8c7b33ec3e44698699ab1beaae934cad97e6e2f43a472b7831bbb946da01a.exe

using System;
using System.IO;
using System.Reflection;
using System.Xml;

namespace ATI.ACE.CCCInstall.Tasks
{
  internal class RegistryTasks : BaseTask, ITask
  {
    private ATI.ACE.CCCInstall.Action action;

    public RegistryTasks(CCCInstallLog log, ATI.ACE.CCCInstall.Action action)
      : base(log)
    {
      this.action = action;
    }

    public void Run(string filePath)
    {
      if (this.action == ATI.ACE.CCCInstall.Action.CreateReg)
      {
        StreamWriter streamWriter = (StreamWriter) null;
        try
        {
          string path = this.MassagePath(filePath);
          string directoryName = Path.GetDirectoryName(path);
          XmlDocument xmlDocument = this.LoadXmlDocument(path);
          if (xmlDocument == null)
            return;
          this.Logger.LogMessage("Successfully loaded XML file " + path);
          XmlNodeList xmlNodeList = xmlDocument.SelectNodes("Package/Include");
          streamWriter = new StreamWriter(path.Replace(".xml", ".reg"));
          streamWriter.WriteLine("Windows Registry Editor Version 5.00");
          streamWriter.WriteLine("");
          bool flag1 = true;
          foreach (XmlNode xmlNode in xmlNodeList)
          {
            try
            {
              XmlAttributeCollection attributes = xmlNode.Attributes;
              string innerText1 = attributes["file"].InnerText;
              string innerText2 = attributes["extension"].InnerText;
              bool flag2 = bool.Parse(attributes["GAC"].InnerText);
              string str1 = directoryName + "\\" + innerText1 + "." + innerText2;
              try
              {
                if (flag2)
                {
                  if (File.Exists(str1))
                  {
                    string str2 = "\"" + innerText1 + "\"=\"" + Assembly.ReflectionOnlyLoadFrom(str1).FullName + "\"";
                    if (IntPtr.Size == 8)
                      streamWriter.WriteLine("[HKEY_LOCAL_MACHINE\\Software\\Wow6432Node\\ATI\\ACE\\Assemblies]");
                    else
                      streamWriter.WriteLine("[HKEY_LOCAL_MACHINE\\Software\\ATI\\ACE\\Assemblies]");
                    streamWriter.WriteLine(str2);
                    streamWriter.WriteLine();
                  }
                  else
                    this.Logger.LogMessage("Assembly file not found: " + str1);
                }
              }
              catch (Exception ex)
              {
                this.Logger.LogException(ex, "Error loading " + innerText1 + "." + innerText2);
                flag1 = false;
              }
            }
            catch (Exception ex)
            {
              this.Logger.LogException(ex);
              flag1 = false;
            }
          }
          if (flag1)
            this.Logger.LogMessage("Install.reg file successfully created.");
          else
            this.Logger.LogMessage("Install.reg file created. Some assemblies had errors.");
        }
        catch (Exception ex)
        {
          this.Logger.LogException(ex);
        }
        finally
        {
          streamWriter?.Close();
        }
      }
      else
        this.Logger.LogMessage("Debug: Wrong parameter passed");
    }
  }
}
