// Decompiled with JetBrains decompiler
// Type: 2NspH2k.R7EAZSM
// Assembly: aO8BSlP, Version=2.0.0.0, Culture=neutral, PublicKeyToken=0a613f4dd989e8ae
// MVID: 26D80EA7-FF8D-466E-8999-D26AD81041E3
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.03\HEUR-Trojan.MSIL.DOTHETUK.gen-37c04e3821fcaedfc79bce018910dfdb141a491f2e2e18102353a3e3e74ebde6.exe

using \u0032NspH2k;
using \u0034MHN5HU;
using bumJRnO;
using dyfScAb;
using FfsK7Q3;
using HhOIosV;
using SWswj9r;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Runtime.InteropServices;
using System.Security.Cryptography;
using System.Threading;

namespace \u0032NspH2k
{
  public sealed class R7EAZSM
  {
    private static readonly Lazy<TraceSource> Fcc8JF9 = new Lazy<TraceSource>(new Func<TraceSource>(R7EAZSM.\u0038TEK8eI.\u0031FCI9IO.\u0035DXWOYN));
    private const int icdwKuY = 20;
    private const int sLQY3GE = 200;
    private readonly TraceSource SWslUuJ;
    private IntPtr \u0030FwHyOs = IntPtr.Zero;

    internal vLYw8hm EG0jBBX { get; }

    public R7EAZSM(vLYw8hm creationProperties, TraceSource logger)
    {
      this.SWslUuJ = logger ?? R7EAZSM.Fcc8JF9.Value;
      this.EG0jBBX = creationProperties ?? throw new ArgumentNullException(nameof (creationProperties));
      logger.TraceEvent(TraceEventType.Information, 0, "Initialized 'R7EAZSM' with cacheFilePath '" + creationProperties.DqI3JDM + "'");
    }

    public static string \u0037hsUW9a => AKWzGCu.rdD4xol();

    public string PcaR47H => this.EG0jBBX.fcX4FJC;

    private string mKgLcxS => this.PcaR47H + ".version";

    public bool f0jhmY9 => true;

    public byte[] yxHZYxl()
    {
      this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, string.Format("ReadData Cache file exists '{0}'", (object) File.Exists(this.PcaR47H)));
      byte[] numArray = (byte[]) null;
      bool flag = false;
      try
      {
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Reading Data");
        byte[] encryptedData = this.\u0031MnSJDA();
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, string.Format("Got '{0}' bytes from file storage", (object) encryptedData?.Length));
        if (encryptedData != null && encryptedData.Length != 0)
        {
          this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Unprotecting the data");
          numArray = AKWzGCu.tAeuM3K() ? ProtectedData.Unprotect(encryptedData, (byte[]) null, DataProtectionScope.CurrentUser) : encryptedData;
        }
        else if (encryptedData == null || encryptedData.Length == 0)
        {
          numArray = new byte[0];
          this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Empty data does not need to be unprotected");
        }
        else
        {
          this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Data does not need to be unprotected");
          return encryptedData;
        }
      }
      catch (Exception ex)
      {
        if (!flag)
          this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, string.Format("An exception was encountered while reading data from the {0} : {1}", (object) nameof (R7EAZSM), (object) ex));
        this.Dwt7HY9();
      }
      return numArray;
    }

    public void xLKmaGd(byte[] lD0x34U)
    {
      if (lD0x34U == null)
        throw new ArgumentNullException("data");
      try
      {
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, string.Format("Got '{0}' bytes to write to storage", (object) lD0x34U?.Length));
        if (AKWzGCu.tAeuM3K() && lD0x34U.Length != 0)
        {
          this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Protecting the data");
          lD0x34U = ProtectedData.Protect(lD0x34U, (byte[]) null, DataProtectionScope.CurrentUser);
        }
        this.lt6Co78(lD0x34U);
      }
      catch (Exception ex)
      {
        this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, string.Format("An exception was encountered while writing data from the {0} : {1}", (object) nameof (R7EAZSM), (object) ex));
      }
    }

    public void hYuHXZ2()
    {
      this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Clearing the adal cache file");
      this.Dwt7HY9();
    }

    private byte[] \u0031MnSJDA()
    {
      // ISSUE: object of a compiler-generated type is created
      // ISSUE: variable of a compiler-generated type
      R7EAZSM.JbWwwZI jbWwwZi = (R7EAZSM.JbWwwZI) new pJ0Jjqu.OCoJvEj();
      // ISSUE: reference to a compiler-generated field
      jbWwwZi.qjTQCGe = this;
      this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "ReadDataCore");
      // ISSUE: reference to a compiler-generated field
      ((pJ0Jjqu.OCoJvEj) jbWwwZi).QwNeY9b = (byte[]) null;
      bool flag = File.Exists(this.PcaR47H);
      this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, string.Format("ReadDataCore Cache file exists '{0}'", (object) flag));
      if (AKWzGCu.tAeuM3K())
      {
        if (flag)
        {
          // ISSUE: reference to a compiler-generated method
          this.youPYJT(new Action(jbWwwZi.IZ73nQb));
        }
      }
      else if (AKWzGCu.XIcfD0x())
      {
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "ReadDataCore, Before reading from mac keychain");
        // ISSUE: reference to a compiler-generated field
        ((pJ0Jjqu.OCoJvEj) jbWwwZi).QwNeY9b = \u0031LD4Zsp.\u00327ZmAoe(this.EG0jBBX.ubuyvIh, this.EG0jBBX.mvCwlV0, this.SWslUuJ);
        // ISSUE: reference to a compiler-generated field
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, string.Format("ReadDataCore, read '{0}' bytes from the keychain", (object) ((pJ0Jjqu.OCoJvEj) jbWwwZi).QwNeY9b?.Length));
      }
      else if (AKWzGCu.\u0032p3s4fh())
      {
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "ReadDataCore, Before reading from linux keyring");
        IntPtr zero1 = IntPtr.Zero;
        IntPtr VRyVwJ6 = this.Ic2Xezg();
        IntPtr zero2 = IntPtr.Zero;
        ref IntPtr local = ref zero1;
        string key1 = this.EG0jBBX.XXitDsq.Key;
        string aeeVhHQ = this.EG0jBBX.XXitDsq.Value;
        KeyValuePair<string, string> p7sKbtE = this.EG0jBBX.p7sKbtE;
        string key2 = p7sKbtE.Key;
        p7sKbtE = this.EG0jBBX.p7sKbtE;
        string nVygppb = p7sKbtE.Value;
        IntPtr zero3 = IntPtr.Zero;
        string s = CRf8sxc.qczrJGF(VRyVwJ6, zero2, out local, key1, aeeVhHQ, key2, nVygppb, zero3);
        if (zero1 != IntPtr.Zero)
        {
          try
          {
            mWChuPo structure = (mWChuPo) Marshal.PtrToStructure(zero1, typeof (mWChuPo));
            this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, string.Format("An error was encountered while reading secret from keyring in the {0} domain:'{1}' code:'{2}' message:'{3}'", (object) nameof (R7EAZSM), (object) structure.SB0Vxws, (object) structure.jNH5zE5, (object) structure.RK5lYNJ));
          }
          catch (Exception ex)
          {
            this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, string.Format("An exception was encountered while processing libsecret error information during reading in the {0} ex:'{1}'", (object) nameof (R7EAZSM), (object) ex));
          }
        }
        else if (string.IsNullOrEmpty(s))
        {
          this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, "No matching secret found in the keyring");
        }
        else
        {
          this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Base64 decoding the secret string");
          // ISSUE: reference to a compiler-generated field
          ((pJ0Jjqu.OCoJvEj) jbWwwZi).QwNeY9b = Convert.FromBase64String(s);
          // ISSUE: reference to a compiler-generated field
          this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, string.Format("ReadDataCore, read '{0}' bytes from the keyring", (object) ((pJ0Jjqu.OCoJvEj) jbWwwZi).QwNeY9b?.Length));
        }
      }
      else
      {
        this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, "Platform not supported");
        throw new PlatformNotSupportedException();
      }
      // ISSUE: reference to a compiler-generated field
      return ((pJ0Jjqu.OCoJvEj) jbWwwZi).QwNeY9b;
    }

    private void lt6Co78(byte[] zO2nVZy)
    {
      // ISSUE: object of a compiler-generated type is created
      // ISSUE: variable of a compiler-generated type
      R7EAZSM.\u0038TEK8eI obj = (R7EAZSM.\u0038TEK8eI) new R7EAZSM.JbWwwZI();
      // ISSUE: reference to a compiler-generated field
      ((R7EAZSM.JbWwwZI) obj).unfMTyx = this;
      // ISSUE: reference to a compiler-generated field
      obj.RTC2yDZ = zO2nVZy;
      // ISSUE: reference to a compiler-generated field
      if (obj.RTC2yDZ == null)
        throw new ArgumentNullException("data");
      // ISSUE: reference to a compiler-generated field
      this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, string.Format("Write Data core, goign to write '{0}' to the storage", (object) obj.RTC2yDZ.Length));
      if (AKWzGCu.XIcfD0x() || AKWzGCu.\u0032p3s4fh())
      {
        if (AKWzGCu.XIcfD0x())
        {
          this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Before write to mac keychain");
          // ISSUE: reference to a compiler-generated field
          \u0031LD4Zsp.ctKjZ6G(this.EG0jBBX.ubuyvIh, this.EG0jBBX.mvCwlV0, obj.RTC2yDZ);
          this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "After write to mac keychain");
        }
        else if (AKWzGCu.\u0032p3s4fh())
        {
          this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Before saving to linux keyring");
          IntPtr zero1 = IntPtr.Zero;
          IntPtr jF0dzJ1 = this.Ic2Xezg();
          string oj7ecIo = this.EG0jBBX.\u0035op2hj8;
          string rGqkAbj = this.EG0jBBX.rGQkABJ;
          // ISSUE: reference to a compiler-generated field
          string base64String = Convert.ToBase64String(obj.RTC2yDZ);
          IntPtr zero2 = IntPtr.Zero;
          ref IntPtr local = ref zero1;
          KeyValuePair<string, string> keyValuePair = this.EG0jBBX.XXitDsq;
          string key1 = keyValuePair.Key;
          keyValuePair = this.EG0jBBX.XXitDsq;
          string str = keyValuePair.Value;
          keyValuePair = this.EG0jBBX.p7sKbtE;
          string key2 = keyValuePair.Key;
          keyValuePair = this.EG0jBBX.p7sKbtE;
          string mEHoLN5 = keyValuePair.Value;
          IntPtr zero3 = IntPtr.Zero;
          CRf8sxc.T2mnxp5(jF0dzJ1, oj7ecIo, rGqkAbj, base64String, zero2, out local, key1, str, key2, mEHoLN5, zero3);
          if (zero1 != IntPtr.Zero)
          {
            try
            {
              mWChuPo structure = (mWChuPo) Marshal.PtrToStructure(zero1, typeof (mWChuPo));
              this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, string.Format("An error was encountered while saving secret to keyring in the {0} domain:'{1}' code:'{2}' message:'{3}'", (object) nameof (R7EAZSM), (object) structure.SB0Vxws, (object) structure.jNH5zE5, (object) structure.RK5lYNJ));
            }
            catch (Exception ex)
            {
              this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, string.Format("An exception was encountered while processing libsecret error information during saving in the {0} ex:'{1}'", (object) nameof (R7EAZSM), (object) ex));
            }
          }
          this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "After saving to linux keyring");
        }
        // ISSUE: reference to a compiler-generated field
        obj.RTC2yDZ = new byte[1]{ (byte) 1 };
      }
      string directoryName1 = Path.GetDirectoryName(this.PcaR47H);
      if (!Directory.Exists(directoryName1))
      {
        string directoryName2 = Path.GetDirectoryName(this.PcaR47H);
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Creating directory '" + directoryName2 + "'");
        Directory.CreateDirectory(directoryName2);
      }
      this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, string.Format("Cache file directory exists. '{0}' now writing cache file", (object) Directory.Exists(directoryName1)));
      // ISSUE: reference to a compiler-generated method
      this.youPYJT(new Action(obj.fo97M7V));
    }

    private void Dwt7HY9()
    {
      this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Clearing adal cache");
      this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, string.Format("ReadDataCore Cache file exists '{0}'", (object) File.Exists(this.PcaR47H)));
      this.youPYJT((Action) (() =>
      {
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Before deleting the cache file");
        try
        {
          File.Delete(this.PcaR47H);
        }
        catch (Exception ex)
        {
          this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, string.Format("Problem deleting the cache file '{0}'", (object) ex));
        }
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "After deleting the cache file.");
      }));
      if (AKWzGCu.XIcfD0x())
      {
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Before delete mac keychain");
        \u0031LD4Zsp.SSEKK0r(this.EG0jBBX.ubuyvIh, this.EG0jBBX.mvCwlV0);
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "After delete mac keychain");
      }
      else if (AKWzGCu.\u0032p3s4fh())
      {
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Before deletring secret from linux keyring");
        IntPtr CgVmws1 = IntPtr.Zero;
        CRf8sxc.JMGhnnZ(this.Ic2Xezg(), IntPtr.Zero, out CgVmws1, this.EG0jBBX.XXitDsq.Key, this.EG0jBBX.XXitDsq.Value, this.EG0jBBX.p7sKbtE.Key, this.EG0jBBX.p7sKbtE.Value, IntPtr.Zero);
        if (CgVmws1 != IntPtr.Zero)
        {
          try
          {
            mWChuPo structure = (mWChuPo) Marshal.PtrToStructure(CgVmws1, typeof (mWChuPo));
            this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, string.Format("An error was encountered while clearing secret from keyring in the {0} domain:'{1}' code:'{2}' message:'{3}'", (object) nameof (R7EAZSM), (object) structure.SB0Vxws, (object) structure.jNH5zE5, (object) structure.RK5lYNJ));
          }
          catch (Exception ex)
          {
            this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, string.Format("An exception was encountered while processing libsecret error information during clearing secret in the {0} ex:'{1}'", (object) nameof (R7EAZSM), (object) ex));
          }
        }
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "After deleting secret from linux keyring");
      }
      else if (!AKWzGCu.tAeuM3K())
      {
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Not supported platform");
        throw new PlatformNotSupportedException();
      }
    }

    private void youPYJT(Action EBnHddA)
    {
      for (int index = 0; index <= 20; ++index)
      {
        try
        {
          EBnHddA();
          break;
        }
        catch (Exception ex)
        {
          Thread.Sleep(TimeSpan.FromMilliseconds(200.0));
          if (index == 20)
            this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, string.Format("An exception was encountered while processing the Adal cache file from the {0} ex:'{1}'", (object) nameof (R7EAZSM), (object) ex));
        }
      }
    }

    private IntPtr Ic2Xezg()
    {
      if (this.\u0030FwHyOs == IntPtr.Zero)
      {
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "Before creating libsecret schema");
        string yCpybWm = this.EG0jBBX.yCPybWm;
        KeyValuePair<string, string> keyValuePair = this.EG0jBBX.XXitDsq;
        string key1 = keyValuePair.Key;
        keyValuePair = this.EG0jBBX.p7sKbtE;
        string key2 = keyValuePair.Key;
        IntPtr zero = IntPtr.Zero;
        this.\u0030FwHyOs = CRf8sxc.ZgctJeY(yCpybWm, 2, key1, 0, key2, 0, zero);
        if (this.\u0030FwHyOs == IntPtr.Zero)
          this.SWslUuJ.TraceEvent(TraceEventType.Error, 0, "Failed to create libsecret schema from the R7EAZSM");
        this.SWslUuJ.TraceEvent(TraceEventType.Information, 0, "After creating libsecret schema");
      }
      return this.\u0030FwHyOs;
    }
  }
}
