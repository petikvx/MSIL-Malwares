// Decompiled with JetBrains decompiler
// Type: jimbii.BrowserCookies
// Assembly: sysrt, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: F2102D52-57B0-4622-A1CB-9DE0B00E107F
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare.00100-msil\Trojan-Ransom.Win32.Blocker.hehh-e9e3600777f319c90d3c06bee4af8f501eba42a876d1d5ed7d3de045ff7cba31.exe

using Microsoft.Win32;
using System;
using System.Collections.Generic;
using System.Data.SQLite;
using System.IO;
using System.Net;
using System.Runtime.InteropServices;
using System.Text;

namespace jimbii
{
  internal class BrowserCookies
  {
    private static Dictionary<string, CookieContainer> CookieYar = new Dictionary<string, CookieContainer>();

    [DllImport("wininet.dll", SetLastError = true)]
    public static extern bool InternetGetCookie(
      string url,
      string cookieName,
      StringBuilder cookieData,
      ref int size);

    [DllImport("wininet.dll", CharSet = CharSet.Unicode, SetLastError = true)]
    private static extern bool InternetSetCookie(string url, string cookieName, string cookieData);

    private static CookieContainer GetUriCookieContainer(Uri uri)
    {
      CookieContainer uriCookieContainer = (CookieContainer) null;
      int size = 256;
      StringBuilder cookieData = new StringBuilder(size);
      if (!BrowserCookies.InternetGetCookie(uri.ToString(), (string) null, cookieData, ref size))
      {
        if (size < 0)
          return (CookieContainer) null;
        cookieData = new StringBuilder(size);
        if (!BrowserCookies.InternetGetCookie(uri.ToString(), (string) null, cookieData, ref size))
          return (CookieContainer) null;
      }
      if (cookieData.Length > 0)
      {
        uriCookieContainer = new CookieContainer();
        uriCookieContainer.SetCookies(uri, cookieData.ToString().Replace(';', ','));
      }
      return uriCookieContainer;
    }

    private static string GetFireFoxCookiePath()
    {
      string path1 = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + "\\Mozilla\\Firefox\\Profiles\\";
      string path2;
      try
      {
        DirectoryInfo[] directories = new DirectoryInfo(path1).GetDirectories("*.default");
        if (directories.Length != 1)
          return string.Empty;
        path2 = path1 + directories[0].Name + "\\cookies.sqlite";
        if (!System.IO.File.Exists(path2))
          return string.Empty;
      }
      catch (Exception ex)
      {
        path2 = "";
      }
      return path2;
    }

    private static CookieContainer GetCookieContainerForFirefox(Uri uri)
    {
      string key = uri.Host.Replace("www.", "");
      if (BrowserCookies.CookieYar.ContainsKey(key))
        return BrowserCookies.CookieYar[key];
      CookieContainer containerForFirefox = new CookieContainer();
      string fireFoxCookiePath = BrowserCookies.GetFireFoxCookiePath();
      string tempFileName = Path.GetTempFileName();
      System.IO.File.Copy(fireFoxCookiePath, tempFileName, true);
      if (System.IO.File.Exists(tempFileName))
      {
        using (SQLiteConnection sqLiteConnection = new SQLiteConnection("Data Source=" + fireFoxCookiePath))
        {
          using (SQLiteCommand command = sqLiteConnection.CreateCommand())
          {
            command.CommandText = "select * from moz_cookies where host like '%" + key + "%';";
            sqLiteConnection.Open();
            using (SQLiteDataReader sqLiteDataReader = command.ExecuteReader())
            {
              while (sqLiteDataReader.Read())
                containerForFirefox.Add(new Cookie(sqLiteDataReader["name"].ToString(), sqLiteDataReader["value"].ToString(), sqLiteDataReader["path"].ToString(), sqLiteDataReader["host"].ToString()));
            }
          }
          sqLiteConnection.Close();
        }
      }
      System.IO.File.Delete(tempFileName);
      BrowserCookies.CookieYar.Add(key, containerForFirefox);
      return containerForFirefox;
    }

    public void get_or_set_cookies()
    {
      Uri uri = new Uri("http://jimbii.com");
      RegistryKey subKey = Registry.LocalMachine.CreateSubKey("SOFTWARE\\Jimbii\\Preferences");
      string str1 = "";
      string str2 = "";
      try
      {
        if (subKey != null)
        {
          str1 = subKey.GetValue("AffiliateID").ToString();
          str2 = subKey.GetValue("identity").ToString();
        }
      }
      catch (Exception ex)
      {
      }
      CookieCollection cookieCollection = (CookieCollection) null;
      if (!(str1 == "") && !(str2 == ""))
        return;
      CookieContainer uriCookieContainer = BrowserCookies.GetUriCookieContainer(uri);
      try
      {
        cookieCollection = uriCookieContainer.GetCookies(uri);
      }
      catch (Exception ex)
      {
      }
      if (cookieCollection != null)
      {
        foreach (Cookie cookie in cookieCollection)
          subKey?.SetValue(cookie.Name, (object) cookie.Value);
      }
      try
      {
        cookieCollection = BrowserCookies.GetCookieContainerForFirefox(uri).GetCookies(uri);
      }
      catch (Exception ex)
      {
      }
      if (cookieCollection == null)
        return;
      foreach (Cookie cookie in cookieCollection)
        subKey?.SetValue(cookie.Name, (object) cookie.Value);
    }
  }
}
