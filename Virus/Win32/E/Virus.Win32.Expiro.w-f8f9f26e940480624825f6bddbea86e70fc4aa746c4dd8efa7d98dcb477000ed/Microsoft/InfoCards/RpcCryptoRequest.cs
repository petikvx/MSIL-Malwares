// Decompiled with JetBrains decompiler
// Type: Microsoft.InfoCards.RpcCryptoRequest
// Assembly: infocard, Version=3.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089
// MVID: 1D4D5564-A025-490C-AF1D-DF4FBB709D1F
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare-00001-msil\Virus.Win32.Expiro.w-f8f9f26e940480624825f6bddbea86e70fc4aa746c4dd8efa7d98dcb477000ed.exe

using Microsoft.InfoCards.Diagnostics;
using System;
using System.ComponentModel;
using System.IO;

namespace Microsoft.InfoCards
{
  internal abstract class RpcCryptoRequest
  {
    private RpcCryptoContext m_context;

    protected RpcCryptoRequest(RpcCryptoContext context) => this.m_context = context;

    public abstract string Name { get; }

    public void Process()
    {
      MemoryStream memoryStream = new MemoryStream();
      this.MarshalOutArgs((Stream) memoryStream);
      byte[] buffer1 = memoryStream.GetBuffer();
      byte[] buffer2;
      try
      {
        buffer2 = NativeMcppMethods.RpcCryptoDispatchRequest(this.m_context.InterfaceHandle, this.m_context.ContextKey, this.Name, buffer1, 0, Convert.ToInt32(memoryStream.Length));
      }
      catch (Win32Exception ex)
      {
        if (ex.NativeErrorCode == -2146434962)
          throw InfoCardTrace.ThrowHelperError((Exception) new UserCancelledException((string) null, (Exception) ex));
        throw InfoCardTrace.ThrowHelperError((Exception) new CommunicationException((string) null, (Exception) ex));
      }
      this.MarshalReturnArgs((Stream) new MemoryStream(buffer2));
    }

    protected abstract void MarshalOutArgs(Stream stream);

    protected abstract void MarshalReturnArgs(Stream stream);
  }
}
