// Decompiled with JetBrains decompiler
// Type: 4IerJKw.qjPLF0w
// Assembly: gO77Fih, Version=16.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a
// MVID: F43F05C3-DF79-4EF2-8C94-619BF1ED6D3E
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.03\HEUR-Trojan.MSIL.Gorgon.gen-83f6c309f411e1aebbdf75c62f67f163231f1b0ee065936230741272cda1cb9a.exe

using \u0030foHdXo;
using \u0032DVyudQ;
using \u0032xpwO2w;
using \u0033JGJehp;
using \u0034IerJKw;
using \u00366N2IhJ;
using \u0037h0JAji;
using \u0039XQfkTy;
using BBHTkZJ;
using BIUYCVz;
using d4z6HnV;
using Di3tgNX;
using gERM8cd;
using jz0haJe;
using Microsoft;
using odRvpaC;
using oVkjSvs;
using QLVBrEo;
using R4qHaNR;
using SCjHuPD;
using System;
using System.Collections.Generic;
using System.ComponentModel.Composition.Hosting;
using System.ComponentModel.Composition.Primitives;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
using U8zsCil;
using ui2f5w0;
using vn312U5;
using vR4h26m;
using wDymEzd;
using yAhKu3H;
using zi9HJIz;
using ZuqPiTm;

namespace \u0034IerJKw
{
  internal class qjPLF0w : MyzKvwp, IAssemblyDataCacheWriter
  {
    internal const uint WyzKfux = 23;
    private readonly Encoding yev1Z7y = (Encoding) new UTF8Encoding(true, true);
    private JMBpZHP NTKYDaD;
    private string \u0034881wt5;
    private FileStream P5uCwAv;
    private zINRWpL ji8ySJC;
    private IEnumerable<YkBa6Sd> NUeFhp2;
    private IDictionary<string, YkBa6Sd> awL2dES;
    private IDictionary<string, YkBa6Sd> sm8d2LM = (IDictionary<string, YkBa6Sd>) new Dictionary<string, YkBa6Sd>((IEqualityComparer<string>) StringComparer.OrdinalIgnoreCase);
    private jUU2Be4 DIuN7Kf;
    private \u0032nZwvYg H30OzFL;
    private IDictionary<ComposablePartDefinition, \u0036ag9UIM> LWhSGfb;
    private IDictionary<string, string> uLNr4hA = (IDictionary<string, string>) new Dictionary<string, string>();

    public qjPLF0w(
      string cacheFilePath,
      zINRWpL catalog,
      IEnumerable<YkBa6Sd> allAssembliesData,
      jUU2Be4 host)
    {
      if (cacheFilePath == null)
        throw new ArgumentNullException(nameof (cacheFilePath));
      if (allAssembliesData == null)
        throw new ArgumentNullException(nameof (allAssembliesData));
      if (catalog == null)
        throw new ArgumentNullException(nameof (catalog));
      if (host == null)
        throw new ArgumentNullException(nameof (host));
      this.\u0034881wt5 = cacheFilePath;
      this.NUeFhp2 = allAssembliesData;
      this.ji8ySJC = catalog;
      this.DIuN7Kf = host;
      this.awL2dES = catalog.z09Mq1a ?? (IDictionary<string, YkBa6Sd>) new Dictionary<string, YkBa6Sd>((IEqualityComparer<string>) StringComparer.OrdinalIgnoreCase);
    }

    public void t1iJpQy(FileShare _param1 = FileShare.None, bool YE2nvX6 = true)
    {
      using (this.P5uCwAv = new FileStream(this.\u0034881wt5, FileMode.Create, FileAccess.ReadWrite, _param1))
      {
        \u0032nZwvYg obj1 = new \u0032nZwvYg((Stream) this.P5uCwAv, (IEnumerable<object>) cvsquDh.Sryla4z, this.yev1Z7y);
        obj1.\u0034gaCx7A = (IAssemblyDataCacheWriter) this;
        \u0032nZwvYg obj2 = obj1;
        this.H30OzFL = obj1;
        using (obj2)
        {
          if (YE2nvX6)
            this.LWhSGfb = this.ji8ySJC.k5jVZzy;
          this.NTKYDaD = new JMBpZHP();
          long num = this.\u00331E7MFv();
          this.ZNdk1xZ();
          this.ji8ySJC.zEapjLA((MyzKvwp) this);
          this.lOdmwAn(num);
        }
      }
    }

    public virtual void Yhvqx8m(object _param1)
    {
    }

    public void \u0030mzutWc(string GhMxLlI, string KofSo3H)
    {
      Requires.NotNullOrEmpty(GhMxLlI, "assemblyName");
      if (this.sm8d2LM.ContainsKey(GhMxLlI))
        return;
      YkBa6Sd ykBa6Sd;
      if (!this.awL2dES.TryGetValue(GhMxLlI, out ykBa6Sd))
      {
        if (!string.IsNullOrEmpty(KofSo3H))
          ykBa6Sd = cvsquDh.ukWCmA2(KofSo3H);
      }
      else
        ykBa6Sd = cvsquDh.ukWCmA2(ykBa6Sd.CoHpFeR);
      if (ykBa6Sd == null)
        return;
      this.sm8d2LM[GhMxLlI] = ykBa6Sd;
    }

    protected override object WriteCacheCore(
      ComposablePartCatalog catalog,
      IDictionary<string, object> catalogMetadata,
      ICachedComposablePartCatalogSite catalogSite)
    {
      // ISSUE: object of a compiler-generated type is created
      // ISSUE: variable of a compiler-generated type
      qjPLF0w.Vr2ISnj vr2Isnj = (qjPLF0w.Vr2ISnj) new BeWDuY7.\u0035L3giYj();
      // ISSUE: reference to a compiler-generated field
      ((BeWDuY7.\u0035L3giYj) vr2Isnj).KrpvzN5 = catalog;
      // ISSUE: reference to a compiler-generated field
      if (((BeWDuY7.\u0035L3giYj) vr2Isnj).KrpvzN5 == null)
        throw new ArgumentNullException(nameof (catalog));
      Lazy<IEnumerable<ComposablePartDefinition>> lazy;
      try
      {
        // ISSUE: reference to a compiler-generated field
        if (((BeWDuY7.\u0035L3giYj) vr2Isnj).KrpvzN5 is N0I5jr4)
        {
          // ISSUE: reference to a compiler-generated field
          // ISSUE: reference to a compiler-generated field
          vr2Isnj.ZACOskD = ((N0I5jr4) ((BeWDuY7.\u0035L3giYj) vr2Isnj).KrpvzN5).ziDWAcR();
          // ISSUE: reference to a compiler-generated method
          lazy = new Lazy<IEnumerable<ComposablePartDefinition>>(new Func<IEnumerable<ComposablePartDefinition>>(vr2Isnj.sJgDoGJ));
        }
        else
        {
          // ISSUE: reference to a compiler-generated method
          lazy = new Lazy<IEnumerable<ComposablePartDefinition>>(new Func<IEnumerable<ComposablePartDefinition>>(vr2Isnj.n2vg6ez));
          // ISSUE: reference to a compiler-generated field
          vr2Isnj.ZACOskD = qjPLF0w.X1mtiwL(lazy.Value, catalogSite);
        }
      }
      catch (Exception ex)
      {
        U1j2scS.CJDYFbi(this.DIuN7Kf, ex, catalogMetadata.eguvZws<object>("Assembly").O2sGFwD<string>("Location"));
        return (object) null;
      }
      // ISSUE: reference to a compiler-generated field
      long ZP5clDX = this.goPIWIs(vr2Isnj.ZACOskD);
      this.NTKYDaD.C0z9nvd.Add(gzMilTR.NTTE7I6(catalogMetadata, ZP5clDX));
      int num1 = this.NTKYDaD.C0z9nvd.Count - 1;
      int num2 = 0;
      foreach (ComposablePartDefinition key in lazy.Value)
      {
        this.LWhSGfb[key] = new \u0036ag9UIM()
        {
          \u0031S8z0HD = num1,
          zzR5o85 = num2
        };
        ++num2;
      }
      return (object) null;
    }

    private static QmEgsrn X1mtiwL(
      IEnumerable<ComposablePartDefinition> _param0,
      ICachedComposablePartCatalogSite zjdnWTV)
    {
      // ISSUE: object of a compiler-generated type is created
      // ISSUE: variable of a compiler-generated type
      qjPLF0w.DoJkQBn doJkQbn = (qjPLF0w.DoJkQBn) new qjPLF0w.Vr2ISnj();
      // ISSUE: reference to a compiler-generated field
      ((qjPLF0w.Vr2ISnj) doJkQbn).BJYNyER = zjdnWTV;
      // ISSUE: reference to a compiler-generated field
      if (_param0.Count<ComposablePartDefinition>() > 0 && ((qjPLF0w.Vr2ISnj) doJkQbn).BJYNyER == null)
        throw new ArgumentNullException("catalogSite");
      QmEgsrn qmEgsrn = new QmEgsrn();
      int num = 0;
      foreach (ComposablePartDefinition composablePartDefinition in _param0)
      {
        // ISSUE: object of a compiler-generated type is created
        // ISSUE: variable of a compiler-generated type
        qjPLF0w.SXliIzX sxliIzX = (qjPLF0w.SXliIzX) new qjPLF0w.DoJkQBn();
        // ISSUE: reference to a compiler-generated field
        sxliIzX.\u0032r4oCLE = doJkQbn;
        // ISSUE: reference to a compiler-generated field
        ((qjPLF0w.DoJkQBn) sxliIzX).TqJZ4XJ = composablePartDefinition;
        // ISSUE: reference to a compiler-generated field
        // ISSUE: reference to a compiler-generated field
        // ISSUE: reference to a compiler-generated field
        VoF5cMP voF5cMp = ((qjPLF0w.Vr2ISnj) sxliIzX.\u0032r4oCLE).BJYNyER.CachePartDefinition(((qjPLF0w.DoJkQBn) sxliIzX).TqJZ4XJ);
        // ISSUE: reference to a compiler-generated field
        // ISSUE: reference to a compiler-generated method
        voF5cMp.ZylqkBf = (ICollection<nXnptVy>) new List<nXnptVy>(((qjPLF0w.DoJkQBn) sxliIzX).TqJZ4XJ.ExportDefinitions.Select<ExportDefinition, nXnptVy>(new Func<ExportDefinition, nXnptVy>(sxliIzX.XMQlbUQ)));
        // ISSUE: reference to a compiler-generated field
        // ISSUE: reference to a compiler-generated method
        voF5cMp.rfXtc4j = (ICollection<bYYkkdb>) new List<bYYkkdb>(((qjPLF0w.DoJkQBn) sxliIzX).TqJZ4XJ.ImportDefinitions.Select<ImportDefinition, bYYkkdb>(new Func<ImportDefinition, bYYkkdb>(sxliIzX.oahSteF)));
        qmEgsrn.dj8Bk6Q.Add(voF5cMp);
        ++num;
      }
      return qmEgsrn;
    }

    private long \u00331E7MFv()
    {
      this.H30OzFL.\u00393vYguo(Assembly.GetExecutingAssembly().FullName);
      this.H30OzFL.Write(CultureInfo.CurrentUICulture.LCID);
      this.qfTDVRe(23U);
      this.Z5YOeKZ(this.DIuN7Kf.\u0033Tx9kQI);
      long position = this.P5uCwAv.Position;
      this.Z5YOeKZ(0L);
      return position;
    }

    private void ZNdk1xZ()
    {
      this.uLNr4hA = this.ji8ySJC.ibRIFHl;
      using (this.H30OzFL.u2kyMRp())
        this.H30OzFL.lmGpT5t<KeyValuePair<string, string>>((Action<IWriter, KeyValuePair<string, string>>) ((nhlDuKU, yArEDsQ) =>
        {
          ((IWriter<string>) nhlDuKU).Write(yArEDsQ.Key);
          ((IWriter<string>) nhlDuKU).Write(yArEDsQ.Value);
        }), (ICollection<KeyValuePair<string, string>>) this.uLNr4hA);
    }

    private long goPIWIs(QmEgsrn hhoQ7uM)
    {
      long position = this.P5uCwAv.Position;
      using (this.H30OzFL.u2kyMRp())
        this.H30OzFL.Ol84WyD<QmEgsrn>(hhoQ7uM);
      return position;
    }

    private void lOdmwAn(long _param1)
    {
      long position = this.P5uCwAv.Position;
      this.\u0034JWmvw7();
      this.NTKYDaD.nTXyZkX = this.zdkL9kv();
      using (this.H30OzFL.u2kyMRp())
        this.H30OzFL.Ol84WyD<JMBpZHP>(this.NTKYDaD);
      if (this.P5uCwAv.Seek(_param1, SeekOrigin.Begin) != _param1)
        throw new IOException(MykOU9k.Tu9Rd59);
      this.Z5YOeKZ(position);
    }

    private mLfwbPr zdkL9kv() => this.KsCE5If(this.ji8ySJC.G1Hcxpy);

    private mLfwbPr KsCE5If(CompositionScopeDefinition kG8uYAD)
    {
      mLfwbPr mLfwbPr = new mLfwbPr();
      foreach (ComposablePartDefinition part in (IEnumerable<ComposablePartDefinition>) kG8uYAD.Parts)
      {
        \u0036ag9UIM obj;
        if (this.LWhSGfb.TryGetValue(part, out obj))
        {
          mLfwbPr.\u0031O70BYd.Add(obj);
        }
        else
        {
          this.DIuN7Kf.\u00340C4Zbq(\u0037jxjFzS.Error, MykOU9k.dRgBNBI, (string) null);
          return (mLfwbPr) null;
        }
      }
      foreach (CompositionScopeDefinition child in kG8uYAD.Children)
        mLfwbPr.k4xq5lf.Add(this.KsCE5If(child));
      return mLfwbPr;
    }

    private void \u0033nt5KlH(IDictionary<int, HashSet<int>> EVGFVdV)
    {
      this.TSd7wHf(EVGFVdV.Count);
      foreach (KeyValuePair<int, HashSet<int>> keyValuePair in (IEnumerable<KeyValuePair<int, HashSet<int>>>) EVGFVdV)
      {
        this.TSd7wHf(keyValuePair.Key);
        this.TSd7wHf(keyValuePair.Value.Count);
        foreach (int RpqBBY3 in keyValuePair.Value)
          this.TSd7wHf(RpqBBY3);
      }
    }

    private void \u0034JWmvw7()
    {
      IEnumerable<IGrouping<bool, YkBa6Sd>> source1 = this.NUeFhp2.GroupBy<YkBa6Sd, bool>((Func<YkBa6Sd, bool>) (OfsLPPZ => this.ji8ySJC.f5rfZI0(OfsLPPZ.CoHpFeR)));
      IEnumerable<YkBa6Sd> source2 = source1.Where<IGrouping<bool, YkBa6Sd>>((Func<IGrouping<bool, YkBa6Sd>, bool>) (Tv2ja3c => !Tv2ja3c.Key)).SelectMany<IGrouping<bool, YkBa6Sd>, YkBa6Sd>((Func<IGrouping<bool, YkBa6Sd>, IEnumerable<YkBa6Sd>>) (_param1 => (IEnumerable<YkBa6Sd>) _param1));
      IEnumerable<YkBa6Sd> source3 = source1.Where<IGrouping<bool, YkBa6Sd>>((Func<IGrouping<bool, YkBa6Sd>, bool>) (h6gdbqN => h6gdbqN.Key)).SelectMany<IGrouping<bool, YkBa6Sd>, YkBa6Sd>((Func<IGrouping<bool, YkBa6Sd>, IEnumerable<YkBa6Sd>>) (wxGeiOG => (IEnumerable<YkBa6Sd>) wxGeiOG)).Except<YkBa6Sd>((IEnumerable<YkBa6Sd>) this.NTKYDaD.C0z9nvd, (IEqualityComparer<YkBa6Sd>) new DFWo769());
      this.NTKYDaD.BB8IJtZ = source2.Select<YkBa6Sd, YkBa6Sd>((Func<YkBa6Sd, YkBa6Sd>) (AzxH61A => AzxH61A.\u0031ATIWHV())).ToList<YkBa6Sd>();
      this.NTKYDaD.qyEvWqY = source3.Select<YkBa6Sd, YkBa6Sd>((Func<YkBa6Sd, YkBa6Sd>) (uolta1q => uolta1q.\u0031ATIWHV())).ToList<YkBa6Sd>();
      HashSet<string> stringSet = new HashSet<string>(this.NUeFhp2.Select<YkBa6Sd, string>((Func<YkBa6Sd, string>) (EhG3AdW => EhG3AdW.CoHpFeR)), (IEqualityComparer<string>) StringComparer.OrdinalIgnoreCase);
      foreach (gzMilTR gzMilTr in this.NTKYDaD.C0z9nvd)
      {
        stringSet.Add(gzMilTr.CoHpFeR);
        if (!string.IsNullOrEmpty(gzMilTr.JmSlJXW))
          stringSet.Add(gzMilTr.JmSlJXW);
      }
      cvsquDh.n8SpUmj(this.NUeFhp2);
      foreach (KeyValuePair<string, YkBa6Sd> keyValuePair in (IEnumerable<KeyValuePair<string, YkBa6Sd>>) this.sm8d2LM)
      {
        if (!stringSet.Contains(keyValuePair.Value.CoHpFeR))
          this.NTKYDaD.\u0036Xkphkm.Add(keyValuePair);
      }
    }

    private void qfTDVRe(uint w2PkxrT) => this.qavydHS(BitConverter.GetBytes(w2PkxrT));

    private void TSd7wHf(int RpqBBY3) => this.qavydHS(BitConverter.GetBytes(RpqBBY3));

    private void Z5YOeKZ(long VLHYeZy) => this.qavydHS(BitConverter.GetBytes(VLHYeZy));

    private void \u0038h7t6SW(string SeE04Rp)
    {
      if (SeE04Rp != null)
      {
        byte[] bytes = this.yev1Z7y.GetBytes(SeE04Rp);
        this.TSd7wHf(bytes.Length);
        this.qavydHS(bytes);
      }
      else
        this.TSd7wHf(-1);
    }

    private void qavydHS(byte[] oYfl7Bf) => this.P5uCwAv.Write(oYfl7Bf, 0, oYfl7Bf.Length);
  }
}
