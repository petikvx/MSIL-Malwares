// Decompiled with JetBrains decompiler
// Type: TzMaCzp.IniBN8g
// Assembly: jmZGgwW, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a
// MVID: 3D70FD3D-7EEC-4701-9107-04233FCFD67F
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.03\HEUR-Backdoor.MSIL.DcRat.gen-29c7b524ec1c67f80e1ce8d5b2ed484b6a4b6d119ff128d65734114fe0fe501b.exe

using D3Wz40t;
using mBRmoQv;
using Microsoft;
using Microsoft.ServiceHub.Framework;
using Microsoft.ServiceHub.Utility;
using nDzmtIf;
using Newtonsoft.Json;
using oYxhQXO;
using qcMCadT;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using xHeK27I;
using yKOR6xg;

namespace TzMaCzp
{
  internal static class IniBN8g
  {
    internal const string x1knlPC = "servicehub.config.json";
    internal const string HTpAAMo = "$PIPE";
    internal const string tb44z5k = ".servicehub.service.json";
    internal const string USyIcbl = "./";
    internal const string qfLtxru = ".\\";
    internal const string \u0031dvGvpy = "../";
    internal const string ioAFntV = "..\\";
    internal const string ITBVhcW = "discoverService";
    private const int DTSAINU = 5;
    private const int PKj19n4 = 250;
    private const string \u00379wMMS1 = "PkgDefApplicationConfigFile";

    internal static ServiceActivationOptions Pe5Kxzn(
      string dUcZxXr,
      string px0oSUO,
      ServiceActivationOptions _param2)
    {
      if (((ServiceActivationOptions) ref _param2).ActivationArguments == null || !((ServiceActivationOptions) ref _param2).ActivationArguments.ContainsKey(dUcZxXr))
      {
        Dictionary<string, string> dictionary = new Dictionary<string, string>();
        if (((ServiceActivationOptions) ref _param2).ActivationArguments != null)
        {
          foreach (string key in ((ServiceActivationOptions) ref _param2).ActivationArguments.Keys)
          {
            string str;
            if (((ServiceActivationOptions) ref _param2).ActivationArguments.TryGetValue(key, out str))
              dictionary.Add(key, str);
          }
        }
        dictionary.Add(dUcZxXr, px0oSUO);
        ((ServiceActivationOptions) ref _param2).ActivationArguments = (IReadOnlyDictionary<string, string>) dictionary;
      }
      return _param2;
    }

    internal static string i7Yhmwd()
    {
      if (!EnvUtils.IsWindowsPlatform())
        return string.Empty;
      return Path.Combine((Environment.GetEnvironmentVariable("LocalAppData") ?? Environment.GetEnvironmentVariable("Temp")) ?? throw new Exception("The LocalAppData environment variable does not exist and is needed to initialize ServiceHub."), "ServiceHub", "salt");
    }

    internal static Task<string> buxSTMj(
      DevHubTraceSource jaoICF2,
      string _param1,
      IEnumerable<string> sSeYAOp = null)
    {
      // ISSUE: variable of a compiler-generated type
      IniBN8g.\u0030IGjegY stateMachine;
      // ISSUE: reference to a compiler-generated field
      stateMachine.Q1pyZSV = jaoICF2;
      // ISSUE: reference to a compiler-generated field
      stateMachine.wr8yjtM = _param1;
      // ISSUE: reference to a compiler-generated field
      stateMachine.\u0037iXVgli = sSeYAOp;
      // ISSUE: reference to a compiler-generated field
      stateMachine.fVRZrk1 = AsyncTaskMethodBuilder<string>.Create();
      // ISSUE: cast to a reference type
      // ISSUE: explicit reference operation
      (^(f8eJ2IW.Z9bMHDv&) ref stateMachine).\u0038oyMTgh = -1;
      // ISSUE: reference to a compiler-generated field
      stateMachine.fVRZrk1.Start<IniBN8g.\u0030IGjegY>(ref stateMachine);
      // ISSUE: reference to a compiler-generated field
      return stateMachine.fVRZrk1.Task;
    }

    internal static bool y41aFHr(string Vcu5Hq2)
    {
      if (Vcu5Hq2 == null)
        return false;
      return Vcu5Hq2.IndexOf("./") == 0 || Vcu5Hq2.IndexOf(".\\") == 0 || Vcu5Hq2.IndexOf("../") == 0 || Vcu5Hq2.IndexOf("..\\") == 0;
    }

    internal static string xTJKru3(string _param0, string mfL8Wjc)
    {
      if (string.IsNullOrEmpty(mfL8Wjc) || string.IsNullOrEmpty(_param0))
        return (string) null;
      return IniBN8g.y41aFHr(mfL8Wjc) ? Path.GetFullPath(Path.Combine(_param0, mfL8Wjc)) : mfL8Wjc;
    }

    internal static string qyrN7bV(string QvXrdr2)
    {
      for (; !string.IsNullOrEmpty(QvXrdr2); QvXrdr2 = Path.GetDirectoryName(QvXrdr2))
      {
        string path = Path.Combine(QvXrdr2, "servicehub.config.json");
        if (File.Exists(path))
          return path;
      }
      return (string) null;
    }

    internal static string uwLOL32(string GeGIGkH, DevHubTraceSource RLbS89C)
    {
      Requires.NotNull<string>(GeGIGkH, "path");
      try
      {
        return File.ReadAllText(GeGIGkH);
      }
      catch (Exception ex)
      {
        TraceSourceExtensions.TraceException((TraceSource) RLbS89C, ex, "Error reading '{0}'", new object[1]
        {
          (object) GeGIGkH
        });
        throw;
      }
    }

    internal static string[] \u0033H6mW5i(string[] g73S3jv, string b5FxoRL)
    {
      Requires.NotNull<string[]>(g73S3jv, "args");
      Requires.NotNull<string>(b5FxoRL, "pipeName");
      for (int index = 0; index < g73S3jv.Length; ++index)
        g73S3jv[index] = g73S3jv[index].Replace("$PIPE", b5FxoRL);
      return g73S3jv;
    }

    internal static Task qdtIOS9(Process YVJPlL4, CancellationToken yKneVMs)
    {
      // ISSUE: variable of a compiler-generated type
      IniBN8g.rWqojaR stateMachine;
      // ISSUE: reference to a compiler-generated field
      stateMachine.QKAhUJY = YVJPlL4;
      // ISSUE: reference to a compiler-generated field
      stateMachine.a72WeSL = yKneVMs;
      // ISSUE: reference to a compiler-generated field
      stateMachine.JbAnOy5 = AsyncTaskMethodBuilder.Create();
      // ISSUE: cast to a reference type
      // ISSUE: explicit reference operation
      // ISSUE: reference to a compiler-generated field
      (^(IniBN8g.AeBkUV2&) ref stateMachine).D9Yq972 = -1;
      // ISSUE: reference to a compiler-generated field
      stateMachine.JbAnOy5.Start<IniBN8g.rWqojaR>(ref stateMachine);
      // ISSUE: reference to a compiler-generated field
      return stateMachine.JbAnOy5.Task;
    }

    private static string tSXlx4s(string rV25XOp, string Fn2ROil, IEnumerable<string> uX4F7Bf = null)
    {
      rV25XOp = Path.GetFullPath(rV25XOp);
      StringBuilder stringBuilder1 = new StringBuilder(rV25XOp.ToLowerInvariant()).Append("//\\\\").Append(File.ReadAllText(rV25XOp, Encoding.UTF8)).Append("//\\\\").Append(EnvUtils.IsElevated() ? "elevated" : "unelevated").Append("//\\\\").Append(Process.GetCurrentProcess().Id);
      if (uX4F7Bf != null)
      {
        foreach (string str in uX4F7Bf)
        {
          if (!string.IsNullOrEmpty(str))
            stringBuilder1.Append("//\\\\").Append(str);
        }
      }
      if (EnvUtils.IsWindowsPlatform())
        stringBuilder1.Append("//\\\\").Append(Fn2ROil);
      string path = Environment.GetEnvironmentVariable("PkgDefApplicationConfigFile");
      if (!string.IsNullOrWhiteSpace(path))
      {
        path = Path.GetFileName(path);
        stringBuilder1.Append("//\\\\").Append(path);
      }
      StringBuilder stringBuilder2 = new StringBuilder(IsolatedUtilities.GetSHA256Hash(stringBuilder1.ToString()).ToLowerInvariant());
      if (!string.IsNullOrWhiteSpace(path))
        stringBuilder2.Append("//\\\\").Append(path);
      return stringBuilder2.ToString();
    }

    private static Task<string> nfJFgtD(DevHubTraceSource _param0)
    {
      // ISSUE: variable of a compiler-generated type
      IniBN8g.\u00300apMsW stateMachine;
      // ISSUE: reference to a compiler-generated field
      stateMachine.wuqZEXR = _param0;
      // ISSUE: reference to a compiler-generated field
      stateMachine.ySyzdW3 = AsyncTaskMethodBuilder<string>.Create();
      // ISSUE: cast to a reference type
      // ISSUE: explicit reference operation
      // ISSUE: reference to a compiler-generated field
      (^(IniBN8g.rWqojaR&) ref stateMachine).SOoGGdV = -1;
      // ISSUE: reference to a compiler-generated field
      stateMachine.ySyzdW3.Start<IniBN8g.\u00300apMsW>(ref stateMachine);
      // ISSUE: reference to a compiler-generated field
      return stateMachine.ySyzdW3.Task;
    }

    public static string dDtQgI2(string[] _param0, string uHrhLay)
    {
      if (_param0 == null || _param0.Length == 0)
        throw new c2lzwCO((c2lzwCO.oCFiYwT) 1, string.Format("Variable {0} is not defined", (object) "patterns"));
      if (uHrhLay == null)
        uHrhLay = Directory.GetCurrentDirectory();
      if (!Directory.Exists(uHrhLay))
        return (string) null;
      foreach (string searchPattern in _param0)
      {
        string[] files = Directory.GetFiles(uHrhLay, searchPattern, SearchOption.AllDirectories);
        if (files.Length != 0)
          return files[0];
      }
      return (string) null;
    }

    public static T PrfKXMi<T>(string aVIbXw6, string zg2V1ZJ)
    {
      Requires.NotNullOrEmpty(aVIbXw6, "filePath");
      return JsonConvert.DeserializeObject<T>(File.ReadAllText(aVIbXw6));
    }

    public static Process gOzPKGa(
      ProcessStartInfo hGA0wwA,
      EventHandler m2tdO3N = null,
      EventHandler IgSx4Ra = null)
    {
      if (hGA0wwA.UseShellExecute)
        throw new ArgumentException("This method can only be invoked with UseShellExecute set to false", "UseShellExecute");
      if (hGA0wwA.RedirectStandardInput || hGA0wwA.RedirectStandardOutput || hGA0wwA.RedirectStandardError)
        throw new ArgumentException("This method does not support redirecting StdInput, StdOutput, or StdErr");
      Process process = (Process) null;
      uQzPrdJ uQzPrdJ = uQzPrdJ.\u0030mYd1vP();
      StringBuilder stringBuilder1 = IniBN8g.\u0036SEaOvk(hGA0wwA.FileName, hGA0wwA.Arguments);
      n1cpyjz e5mk7MF = n1cpyjz.CREATE_SUSPENDED | n1cpyjz.CREATE_UNICODE_ENVIRONMENT | n1cpyjz.NORMAL_PRIORITY_CLASS;
      if (hGA0wwA.CreateNoWindow)
        e5mk7MF |= n1cpyjz.CREATE_NO_WINDOW;
      StringBuilder stringBuilder2 = new StringBuilder();
      foreach (string key in (IEnumerable<string>) hGA0wwA.Environment.Keys)
      {
        string str;
        if (hGA0wwA.Environment.TryGetValue(key, out str))
        {
          stringBuilder2.Append(key);
          stringBuilder2.Append("=");
          stringBuilder2.Append(str);
          stringBuilder2.Append("\0");
        }
      }
      stringBuilder2.Append("\0");
      byte[] bytes = Encoding.Unicode.GetBytes(stringBuilder2.ToString());
      GCHandle gcHandle = new GCHandle();
      try
      {
        gcHandle = GCHandle.Alloc((object) bytes, GCHandleType.Pinned);
        IntPtr VYjRKaG = gcHandle.AddrOfPinnedObject();
        fgwkXo4 eKUI1FD;
        if (FjtJsAe.yXTBGdZ((string) null, stringBuilder1.ToString(), IntPtr.Zero, IntPtr.Zero, false, e5mk7MF, VYjRKaG, hGA0wwA.WorkingDirectory, ref uQzPrdJ, out eKUI1FD))
        {
          process = Process.GetProcessById(eKUI1FD.zHrVppV);
          if (m2tdO3N != null || IgSx4Ra != null)
          {
            process.EnableRaisingEvents = true;
            if (m2tdO3N != null)
              process.Exited += m2tdO3N;
            if (IgSx4Ra != null)
              process.Disposed += IgSx4Ra;
          }
          FjtJsAe.i5MmbPS(new uFubD1v(eKUI1FD.F0wsvtJ));
        }
        else
          Marshal.ThrowExceptionForHR(Marshal.GetLastWin32Error());
      }
      finally
      {
        if (gcHandle.IsAllocated)
          gcHandle.Free();
      }
      return process;
    }

    private static StringBuilder \u0036SEaOvk(string wRHa6Ks, string JdpYX8E)
    {
      StringBuilder stringBuilder = new StringBuilder();
      string str = wRHa6Ks.Trim();
      int num = !str.StartsWith("\"", StringComparison.Ordinal) ? 0 : (str.EndsWith("\"", StringComparison.Ordinal) ? 1 : 0);
      if (num == 0)
        stringBuilder.Append("\"");
      stringBuilder.Append(str);
      if (num == 0)
        stringBuilder.Append("\"");
      if (!string.IsNullOrEmpty(JdpYX8E))
      {
        stringBuilder.Append(" ");
        stringBuilder.Append(JdpYX8E);
      }
      return stringBuilder;
    }
  }
}
