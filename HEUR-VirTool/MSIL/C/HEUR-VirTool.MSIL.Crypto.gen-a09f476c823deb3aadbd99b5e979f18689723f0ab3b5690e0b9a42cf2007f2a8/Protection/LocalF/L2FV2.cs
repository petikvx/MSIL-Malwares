// Decompiled with JetBrains decompiler
// Type: Aura.Protection.LocalF.L2FV2
// Assembly: Kudeta Crypter, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 16F9F4AC-EE0C-4DE1-A1E6-B297F2D4338B
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.04\HEUR-VirTool.MSIL.Crypto.gen-a09f476c823deb3aadbd99b5e979f18689723f0ab3b5690e0b9a42cf2007f2a8.exe

using Aura.Protection.Renamer;
using dnlib.DotNet;
using dnlib.DotNet.Emit;
using System;
using System.Collections.Generic;
using System.Linq;

namespace Aura.Protection.LocalF
{
  internal class L2FV2
  {
    private static Dictionary<Local, FieldDef> convertedLocals = new Dictionary<Local, FieldDef>();

    public static void Execute(ModuleDef Module)
    {
      foreach (TypeDef typeDef in ((IEnumerable<TypeDef>) Module.Types).Where<TypeDef>((Func<TypeDef, bool>) (x => x != Module.GlobalType)))
      {
        foreach (MethodDef method in ((IEnumerable<MethodDef>) typeDef.Methods).Where<MethodDef>((Func<MethodDef, bool>) (x => x.HasBody && x.Body.HasInstructions && !x.IsConstructor)))
        {
          L2FV2.convertedLocals = new Dictionary<Local, FieldDef>();
          L2FV2.Process(Module, method);
        }
      }
    }

    public static void Process(ModuleDef Module, MethodDef method)
    {
      method.Body.SimplifyMacros((IList<Parameter>) method.Parameters);
      foreach (Instruction instruction in (IEnumerable<Instruction>) method.Body.Instructions)
      {
        if (instruction.Operand is Local operand)
        {
          FieldDef fieldDef;
          if (!L2FV2.convertedLocals.ContainsKey(operand))
          {
            fieldDef = (FieldDef) new FieldDefUser(UTF8String.op_Implicit(RenamerPhase.GenerateString(RenamerPhase.RenameMode.Normal)), new FieldSig(operand.Type), (FieldAttributes) 22);
            ((ICollection<FieldDef>) Module.GlobalType.Fields).Add(fieldDef);
            L2FV2.convertedLocals.Add(operand, fieldDef);
          }
          else
            fieldDef = L2FV2.convertedLocals[operand];
          OpCode opCode = (OpCode) null;
          switch (instruction.OpCode.Code - 65036)
          {
            case 0:
              opCode = OpCodes.Ldsfld;
              break;
            case 1:
              opCode = OpCodes.Ldsflda;
              break;
            case 2:
              opCode = OpCodes.Stsfld;
              break;
          }
          instruction.OpCode = opCode;
          instruction.Operand = (object) fieldDef;
        }
      }
      ((IEnumerable<KeyValuePair<Local, FieldDef>>) L2FV2.convertedLocals).ToList<KeyValuePair<Local, FieldDef>>().ForEach((Action<KeyValuePair<Local, FieldDef>>) (x => method.Body.Variables.Remove(x.Key)));
      L2FV2.convertedLocals = new Dictionary<Local, FieldDef>();
    }
  }
}
