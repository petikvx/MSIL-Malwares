// Decompiled with JetBrains decompiler
// Type: s873795964751567.s244709160700278
// Assembly: s968508024776124, Version=2.0.47.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a
// MVID: E3596912-35E7-405B-A05A-F5F12AB5E292
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.04\HEUR-Trojan.MSIL.PowerShell.gen-b1729c7ae8423cc844b16aa10ca8ddd2b2331adbfb6646d80d73381fbc73a109.exe

using s418410312208900;
using s430663705211726;
using s466899421896987;
using s608480027755992;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.IO.Compression;
using System.Text.RegularExpressions;
using System.Threading;
using System.Threading.Tasks;

namespace s873795964751567
{
  public class s244709160700278
  {
    private List<Tuple<string, string>> s739183645082251;
    private string s072209586930007;

    public s244709160700278(string etlFilePath, TextWriter log = null)
    {
      this.s072209586930007 = etlFilePath;
      this.s854149938748973 = true;
      this.s286303236321390 = true;
      this.s949098005614670 = true;
      this.s930788519314742 = true;
      this.s060338719755549 = log;
    }

    public string s780657642242166 { get; set; }

    public TextWriter s060338719755549 { get; set; }

    public void s982255698866073(string s926611287959906, string s248851558771745 = null)
    {
      if (this.s739183645082251 == null)
        this.s739183645082251 = new List<Tuple<string, string>>();
      if (s248851558771745 == null)
        s248851558771745 = Path.GetFileName(s926611287959906);
      this.s739183645082251.Add(new Tuple<string, string>(s926611287959906, s248851558771745));
    }

    public bool s541430626243293(CompressionLevel s474823373193434 = CompressionLevel.Optimal)
    {
      List<string> stringList = this.s648355192103707();
      if (!this.s930788519314742)
        return true;
      Stopwatch stopwatch = Stopwatch.StartNew();
      if (this.s780657642242166 == null)
        this.s780657642242166 = this.s072209586930007 + ".zip";
      string str1 = this.s780657642242166 + ".new";
      s916389884151353.s760644410246924(str1);
      try
      {
        if (this.s805099087548945)
          Thread.CurrentThread.Priority = ThreadPriority.Lowest;
        this.s060338719755549.WriteLine("[Zipping ETL file {0}]", (object) this.s072209586930007);
        using (ZipArchive destination1 = ZipFile.Open(str1, ZipArchiveMode.Create))
        {
          destination1.CreateEntryFromFile(this.s072209586930007, Path.GetFileName(this.s072209586930007), s474823373193434);
          if (stringList != null)
          {
            this.s060338719755549.WriteLine("[Writing {0} PDBS to Zip file]", (object) stringList.Count);
            foreach (string str2 in stringList)
            {
              System.Text.RegularExpressions.Match match = Regex.Match(str2, "\\\\([^\\\\]+.pdb\\\\\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\w\\d+\\\\[^\\\\]+)$");
              string entryName = Path.Combine("symbols", !match.Success ? Path.GetFileName(str2) : match.Groups[1].Value);
              destination1.CreateEntryFromFile(str2, entryName, s474823373193434);
            }
            this.s060338719755549.WriteLine("ZIP generation took {0:f3} sec", (object) stopwatch.Elapsed.TotalSeconds);
            this.s060338719755549.WriteLine("ZIP output file {0}", (object) this.s780657642242166);
            this.s060338719755549.WriteLine("Time: {0}", (object) DateTime.Now);
            this.s060338719755549.Flush();
          }
          if (this.s739183645082251 != null)
          {
            foreach (Tuple<string, string> tuple in this.s739183645082251)
            {
              using (Stream stream = (Stream) File.Open(tuple.Item1, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
              {
                using (Stream destination2 = destination1.CreateEntry(tuple.Item2, s474823373193434).Open())
                  stream.CopyTo(destination2);
              }
            }
          }
        }
        s916389884151353.s390345387705666(str1, this.s780657642242166);
        if (this.s949098005614670)
        {
          this.s060338719755549.WriteLine("Deleting original ETL file {0}", (object) this.s072209586930007);
          s916389884151353.s760644410246924(this.s072209586930007);
        }
        File.SetLastWriteTimeUtc(this.s780657642242166, File.GetLastWriteTimeUtc(this.s072209586930007));
        return true;
      }
      finally
      {
        Thread.CurrentThread.Priority = ThreadPriority.Normal;
        s916389884151353.s760644410246924(str1);
      }
    }

    public s435790585148060 s173785088976180 { get; set; }

    public bool s854149938748973 { get; set; }

    public bool s428259300334438 { get; set; }

    public bool s286303236321390 { get; set; }

    public bool s805099087548945 { get; set; }

    public bool s930788519314742 { get; set; }

    public bool s949098005614670 { get; set; }

    private List<string> s648355192103707()
    {
      // ISSUE: variable of a compiler-generated type
      s244709160700278.s872817063366617 s872817063366617 = (s244709160700278.s872817063366617) new s370345380266841.s870729316666474();
      ((s370345380266841.s870729316666474) s872817063366617).s765791709258419 = this;
      if (this.s060338719755549 == null)
        this.s060338719755549 = (TextWriter) new StringWriter();
      Stopwatch stopwatch = Stopwatch.StartNew();
      string path = Path.GetDirectoryName(this.s072209586930007);
      if (path.Length == 0)
        path = ".";
      string withoutExtension = Path.GetFileNameWithoutExtension(this.s072209586930007);
      // ISSUE: reference to a compiler-generated field
      s872817063366617.s809615025477169 = new List<string>();
      // ISSUE: reference to a compiler-generated field
      s872817063366617.s809615025477169.Add(this.s072209586930007);
      // ISSUE: reference to a compiler-generated field
      s872817063366617.s809615025477169.AddRange((IEnumerable<string>) Directory.GetFiles(path, withoutExtension + ".kernel*.etl"));
      // ISSUE: reference to a compiler-generated field
      s872817063366617.s809615025477169.AddRange((IEnumerable<string>) Directory.GetFiles(path, withoutExtension + ".clr*.etl"));
      // ISSUE: reference to a compiler-generated field
      s872817063366617.s809615025477169.AddRange((IEnumerable<string>) Directory.GetFiles(path, withoutExtension + ".user*.etl"));
      // ISSUE: reference to a compiler-generated field
      s872817063366617.s718687751303377 = Path.ChangeExtension(this.s072209586930007, ".etl.new");
      // ISSUE: reference to a compiler-generated field
      s872817063366617.s728513230836872 = (List<string>) null;
      try
      {
        // ISSUE: reference to a compiler-generated method
        Task task1 = Task.Factory.StartNew(new Action(s872817063366617.s758211161396666));
        if (this.s805099087548945)
        {
          this.s060338719755549.WriteLine("Running Low Priority, Starting merge and waiting for it to complete before doing NGEN PDB generation.");
          task1.Wait();
          this.s060338719755549.WriteLine("Running Low Priority, Finished Merging, moving on to NGEN PDB generation.");
        }
        // ISSUE: reference to a compiler-generated method
        Task task2 = Task.Factory.StartNew(new Action(s872817063366617.s489290890510413));
        Task.WaitAll(task1, task2);
        // ISSUE: reference to a compiler-generated field
        if (File.Exists(s872817063366617.s718687751303377))
        {
          // ISSUE: reference to a compiler-generated field
          foreach (string s252262365546032 in s872817063366617.s809615025477169)
            s916389884151353.s760644410246924(s252262365546032);
          // ISSUE: reference to a compiler-generated field
          this.s060338719755549.WriteLine("Moving {0} to {1}", (object) s872817063366617.s718687751303377, (object) this.s072209586930007);
          // ISSUE: reference to a compiler-generated field
          s916389884151353.s390345387705666(s872817063366617.s718687751303377, this.s072209586930007);
        }
      }
      finally
      {
        this.s060338719755549.WriteLine("Deleting temp file");
        // ISSUE: reference to a compiler-generated field
        if (File.Exists(s872817063366617.s718687751303377))
        {
          // ISSUE: reference to a compiler-generated field
          File.Delete(s872817063366617.s718687751303377);
        }
      }
      stopwatch.Stop();
      this.s060338719755549.WriteLine("Merge and NGEN PDB Generation took {0:f3} sec.", (object) stopwatch.Elapsed.TotalSeconds);
      this.s060338719755549.WriteLine("Merge output file {0}", (object) this.s072209586930007);
      // ISSUE: reference to a compiler-generated field
      return s872817063366617.s728513230836872;
    }

    internal static List<string> s387148783170565(
      string s556220526868317,
      s435790585148060 s257027761971333,
      TextWriter s204777156504199)
    {
      List<string> stringList = new List<string>(100);
      foreach (string s338372449922748 in s302986156607931.s455297286511813(s556220526868317))
      {
        Stopwatch stopwatch = Stopwatch.StartNew();
        string str = s257027761971333.s204217166642935(s338372449922748);
        if (str != null)
        {
          stringList.Add(str);
          s204777156504199.WriteLine("Found NGEN pdb {0}", (object) str);
        }
        s204777156504199.WriteLine("NGEN PDB creation for {0} took {1:n2} Sec", (object) s338372449922748, (object) stopwatch.Elapsed.TotalSeconds);
      }
      return stringList;
    }
  }
}
