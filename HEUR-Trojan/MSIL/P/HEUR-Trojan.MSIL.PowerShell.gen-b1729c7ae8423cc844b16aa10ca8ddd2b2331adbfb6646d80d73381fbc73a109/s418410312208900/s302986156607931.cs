// Decompiled with JetBrains decompiler
// Type: s418410312208900.s302986156607931
// Assembly: s968508024776124, Version=2.0.47.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a
// MVID: E3596912-35E7-405B-A05A-F5F12AB5E292
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.04\HEUR-Trojan.MSIL.PowerShell.gen-b1729c7ae8423cc844b16aa10ca8ddd2b2331adbfb6646d80d73381fbc73a109.exe

using s025420649509424;
using s065175910567653;
using s111377166353221;
using s214170901478238;
using s466899421896987;
using s528813736053581;
using s584120839923761;
using s878358404072606;
using s931403478490351;
using s962360155664524;
using s985393833263885;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Runtime.InteropServices;
using System.Threading;

namespace s418410312208900
{
  public sealed class s302986156607931 : s726691949965431, IDisposable
  {
    private bool s329248861982502;
    private unsafe s134995860702422.s648877553938236* s309596607071739;
    private s134995860702422.s850980203428386[] s393590399745956;
    private ulong[] s740412043008899;
    private IEnumerable<string> s750099174957133;
    internal object s880805771966016;
    private Dictionary<int, string> s084156689599620;
    private s370345380266841 s605770430439902;

    public s302986156607931(string fileName)
      : this(fileName, s707087110524030.MergeAll)
    {
    }

    public s302986156607931(string fileOrSessionName, s707087110524030 type) => this.s516055209020935(fileOrSessionName, type);

    public s302986156607931(IEnumerable<string> fileNames) => this.s750099174957133 = fileNames;

    public virtual bool s876692703604161()
    {
      this.s301783657697048 = false;
      if (this.s329248861982502)
        this.s095851711449549();
      this.s329248861982502 = true;
      if (this.s750099174957133 != null)
      {
        foreach (string s278706920176702 in this.s750099174957133)
        {
          if (this.s740412043008899 != null && this.s740412043008899[0] != ulong.MaxValue)
            s134995860702422.s373861679794889(this.s740412043008899[0]);
          this.s516055209020935(s278706920176702, s707087110524030.FileOnly);
          if (!this.s678462929280283())
          {
            this.OnCompleted();
            return false;
          }
        }
        this.OnCompleted();
        return true;
      }
      bool flag = this.s678462929280283();
      if (this.s560950662468685 == long.MaxValue)
        this.s560950662468685 = s302986156607931.s808831215449236.s415027338160589(DateTime.UtcNow);
      this.OnCompleted();
      return flag;
    }

    [Obsolete("Not obsolete but experimental.   We may change this in the future.")]
    public unsafe void s270756869882261(s034852122986107 s923272269624700) => this.s242447360661385(s923272269624700.s598076025198321);

    public string s802760332294456 => (^(s134995860702422.s946185085699064&) ref this.s393590399745956[0]).s131630845090160;

    public string s825900628045817 => this.s393590399745956[0].s543571982771719;

    public virtual long s536057163712154
    {
      get
      {
        long size = 0;
        for (int index = 0; index < this.s393590399745956.Length; ++index)
        {
          string s131630845090160 = (^(s134995860702422.s946185085699064&) ref this.s393590399745956[index]).s131630845090160;
          if (File.Exists(s131630845090160))
            size += new FileInfo(s131630845090160).Length;
        }
        return size;
      }
    }

    public virtual int s822721112533616
    {
      get
      {
        int eventsLost = 0;
        for (int index = 0; index < this.s393590399745956.Length; ++index)
          eventsLost += (int) this.s393590399745956[index].s880850005545107.s000612104905212;
        return eventsLost;
      }
    }

    public bool s159861036011599 => ((int) this.s393590399745956[0].s630986022097681 & 256) == 0;

    public void s665621044634618()
    {
      if (!this.s100927375859058)
        throw new InvalidOperationException("SynchronizeClock is only for Real-Time Sessions");
      DateTime utcNow = DateTime.UtcNow;
      this.s843632117898745 = s302986156607931.s808831215449236.s415027338160589(utcNow);
      this.s715999696684854 = utcNow;
    }

    public static IEnumerable<string> s455297286511813(
      string s701707741592509,
      s302986156607931.s758934652151773 s162099658175603 = ); //unable to render the method

    private unsafe void s516055209020935(string s278706920176702, s707087110524030 s647118365635516)
    {
      if (s647118365635516 == s707087110524030.MergeAll)
      {
        List<string> stringList = s302986156607931.s265453676981728(s278706920176702);
        this.s393590399745956 = new s134995860702422.s850980203428386[stringList.Count];
        for (int index = 0; index < stringList.Count; ++index)
        {
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          (^(s134995860702422.s946185085699064&) ref this.s393590399745956[index]).s131630845090160 = stringList[index];
        }
      }
      else
      {
        this.s393590399745956 = new s134995860702422.s850980203428386[1];
        if (s647118365635516 == s707087110524030.FileOnly)
        {
          // ISSUE: cast to a reference type
          // ISSUE: explicit reference operation
          (^(s134995860702422.s946185085699064&) ref this.s393590399745956[0]).s131630845090160 = s278706920176702;
        }
        else
        {
          this.s393590399745956[0].s543571982771719 = s278706920176702;
          this.s393590399745956[0].s630986022097681 |= 256U;
          this.s100927375859058 = true;
        }
      }
      this.s740412043008899 = new ulong[this.s393590399745956.Length];
      // ISSUE: method pointer
      // ISSUE: object of a compiler-generated type is created
      this.s393590399745956[0].s790674858243490 = (s134995860702422.s125395808530277) new s865648704516988.s782822788764761((object) this, __methodptr(s726665078361988));
      this.s740412043008899[0] = ulong.MaxValue;
      this.s006184527445362 = !s752892378058130.s569164546966561(60);
      if (this.s006184527445362)
      {
        s134995860702422.s648877553938236* s648877553938236Ptr = (s134995860702422.s648877553938236*) (void*) Marshal.AllocHGlobal(sizeof (s134995860702422.s648877553938236));
        *s648877553938236Ptr = new s134995860702422.s648877553938236();
        this.s309596607071739 = s648877553938236Ptr;
        this.s393590399745956[0].s664556397216870 = (s134995860702422.s587787545948605) new s134995860702422.s125395808530277(this.s013542175497018);
      }
      else
      {
        this.s393590399745956[0].s630986022097681 |= 268435456U;
        this.s393590399745956[0].s664556397216870 = (s134995860702422.s587787545948605) new s134995860702422.s125395808530277(this.s242447360661385);
      }
      this.s393590399745956[0].s630986022097681 |= 4096U;
      for (int index = 1; index < this.s393590399745956.Length; ++index)
      {
        this.s393590399745956[index].s790674858243490 = this.s393590399745956[0].s790674858243490;
        this.s393590399745956[index].s664556397216870 = this.s393590399745956[0].s664556397216870;
        this.s393590399745956[index].s630986022097681 = this.s393590399745956[0].s630986022097681;
        this.s740412043008899[index] = this.s740412043008899[0];
      }
      DateTime s043633073892904_1 = DateTime.MaxValue;
      DateTime s043633073892904_2 = DateTime.MinValue + new TimeSpan(365, 0, 0, 0);
      for (int index = 0; index < this.s740412043008899.Length; ++index)
      {
        this.s740412043008899[index] = s134995860702422.s983712201802122(ref this.s393590399745956[index]);
        if (this.s740412043008899[index] == ulong.MaxValue)
          Marshal.ThrowExceptionForHR(s134995860702422.s386271101430851());
        DateTime dateTime1 = s302986156607931.s097428905053228(this.s393590399745956[index].s880850005545107.s564781123773866);
        DateTime dateTime2 = s302986156607931.s097428905053228(this.s393590399745956[index].s880850005545107.s180987607384559);
        if (dateTime1 < s043633073892904_1)
          s043633073892904_1 = dateTime1;
        if (dateTime2 > s043633073892904_2)
          s043633073892904_2 = dateTime2;
        if ((int) this.s393590399745956[index].s880850005545107.s316055626492950 > this.s824321134384686)
          this.s824321134384686 = (int) this.s393590399745956[index].s880850005545107.s316055626492950;
      }
      this.s605285401142765 = this.s393590399745956[0].s880850005545107.s825931265472475;
      if (this.s605285401142765 == 0L)
        this.s605285401142765 = Stopwatch.Frequency;
      if (((int) this.s393590399745956[0].s630986022097681 & 256) != 0)
      {
        DateTime utcNow = DateTime.UtcNow;
        long num = s302986156607931.s808831215449236.s415027338160589(utcNow);
        this.s843632117898745 = num;
        this.s715999696684854 = utcNow;
        this.s432147997440474 = num - this.s605285401142765 / 10L;
        this.s560950662468685 = long.MaxValue;
      }
      else
      {
        this.s715999696684854 = s043633073892904_1;
        this.s432147997440474 = this.s048532042555637(s043633073892904_1);
        this.s560950662468685 = this.s048532042555637(s043633073892904_2);
      }
      if (this.s824321134384686 == 0 || this.s100927375859058)
        this.s824321134384686 = s302986156607931.s300084204096549();
      this.s336446448723642 = (int) this.s393590399745956[0].s880850005545107.s134375601643720;
      this.s558633164156824 = (int) this.s393590399745956[0].s880850005545107.s001707118362430;
      if (this.s393590399745956[0].s880850005545107.s075616904136346 == 2U)
        this.s605285401142765 = 10000000L;
      int s786171113064152 = (int) this.s393590399745956[0].s880850005545107.s786171113064152;
      this.s745687107734249 = new Version((int) (byte) s786171113064152, (int) (byte) (s786171113064152 >> 8));
      this.s084156689599620 = new Dictionary<int, string>();
      s137522757078529 s137522757078529 = new s137522757078529((s470725726477034) this, (s137522757078529.s438235676929797) 0);
      s137522757078529.s567329967493575 += (Action<s499525253300813>) (s718242475533833 =>
      {
        string s473287231010914 = s718242475533833.s473287231010914;
        int num1 = s473287231010914.LastIndexOf('\\');
        int startIndex = 0 > num1 ? 0 : num1 + 1;
        int num2 = s473287231010914.LastIndexOf('.');
        if (num2 <= startIndex)
          num2 = s473287231010914.Length;
        this.s084156689599620[s718242475533833.s102913512010943] = s473287231010914.Substring(startIndex, num2 - startIndex);
      });
      s137522757078529.s496436999410637 += (Action<s499525253300813>) (s968664387270936 => this.s084156689599620.Remove(s968664387270936.s102913512010943));
      s137522757078529.s274896781471519 += (Action<s435513404871277>) (s197350142757157 =>
      {
        if (this.s843632117898745 != 0L)
          return;
        this.s843632117898745 = s197350142757157.s218856315967206;
        this.s432147997440474 += s197350142757157.s218856315967206;
        this.s560950662468685 += s197350142757157.s218856315967206;
      });
    }

    internal static int s300084204096549() => IntPtr.Size == 8 || Environment.Is64BitOperatingSystem ? 8 : 4;

    internal static DateTime s097428905053228(long s699653851492922) => (ulong) DateTime.MaxValue.ToFileTimeUtc() < (ulong) s699653851492922 ? DateTime.MaxValue : DateTime.FromFileTimeUtc(s699653851492922);

    internal static List<string> s265453676981728(string s426819361257012)
    {
      string withoutExtension = Path.GetFileNameWithoutExtension(s426819361257012);
      string path = Path.GetDirectoryName(s426819361257012);
      if (path.Length == 0)
        path = ".";
      List<string> stringList = new List<string>();
      stringList.AddRange((IEnumerable<string>) Directory.GetFiles(path, withoutExtension + ".etl"));
      stringList.AddRange((IEnumerable<string>) Directory.GetFiles(path, withoutExtension + ".kernel*.etl"));
      stringList.AddRange((IEnumerable<string>) Directory.GetFiles(path, withoutExtension + ".clr*.etl"));
      stringList.AddRange((IEnumerable<string>) Directory.GetFiles(path, withoutExtension + ".user*.etl"));
      return stringList.Count != 0 ? stringList : throw new FileNotFoundException("Could not find file     " + s426819361257012);
    }

    private bool s678462929280283()
    {
      int s697879424542264 = s134995860702422.s214310995671055(this.s740412043008899, (uint) this.s740412043008899.Length, (IntPtr) 0, (IntPtr) 0);
      switch (s697879424542264)
      {
        case 6:
          throw new ApplicationException("Error opening ETL file.  Most likely caused by opening a Win8 Trace on a Pre Win8 OS.");
        case 1223:
          if (this.s301783657697048)
            break;
          goto default;
        default:
          Marshal.ThrowExceptionForHR(s134995860702422.s378247297349470(s697879424542264));
          break;
      }
      return !this.s301783657697048;
    }

    private unsafe void s013542175497018(
      s134995860702422.s648877553938236* s344627385021860)
    {
      s134995860702422.s707627100864256* s707627100864256Ptr = (s134995860702422.s707627100864256*) s344627385021860;
      s344627385021860 = this.s309596607071739;
      // ISSUE: cast to a reference type
      // ISSUE: explicit reference operation
      (^(s134995860702422.s151130862077355&) ref ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507).s268754456213039 = (ushort) sizeof (s134995860702422.s555154128632491);
      ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s957198854550732 = (ushort) 256;
      if (this.s824321134384686 == 8)
        ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s957198854550732 |= (ushort) 64;
      else
        ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s957198854550732 |= (ushort) 32;
      ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s722228102271116 = ((s134995860702422.s555154128632491*) s707627100864256Ptr)->s371186859926300.s920751472915360;
      ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s001274643318731 = ((s134995860702422.s555154128632491*) s707627100864256Ptr)->s371186859926300.s042376375858325;
      ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s473266651679490 = ((s134995860702422.s555154128632491*) s707627100864256Ptr)->s371186859926300.s816765622584717;
      ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s865414040669856 = ((s134995860702422.s555154128632491*) s707627100864256Ptr)->s371186859926300.s584075644725622;
      ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s000023591405563 = (byte) ((s134995860702422.s555154128632491*) s707627100864256Ptr)->s371186859926300.s965933474340595;
      ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s306420005180068 = ((s134995860702422.s555154128632491*) s707627100864256Ptr)->s371186859926300.s207572685420876;
      ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s611740701286585 = ((s134995860702422.s555154128632491*) s707627100864256Ptr)->s371186859926300.s933590576796686;
      ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s480278647661808 = ((s134995860702422.s555154128632491*) s707627100864256Ptr)->s371186859926300.s996059550643477;
      ((s134995860702422.s728170393225391*) s344627385021860)->s870227314561507.s854368281614676 = ((s134995860702422.s555154128632491*) s707627100864256Ptr)->s371186859926300.s878329904771670;
      s344627385021860->s785824337853710 = s707627100864256Ptr->s123025735480027;
      s344627385021860->s855605335439496 = (ushort) s707627100864256Ptr->s255988909255887;
      s344627385021860->s066345635431405 = s707627100864256Ptr->s634827475661007;
      this.s242447360661385(s344627385021860);
    }

    private unsafe void s242447360661385(
      s134995860702422.s648877553938236* s482853406772563)
    {
      if (this.s301783657697048)
        return;
      if (this.s880805771966016 != null)
        Monitor.Enter(this.s880805771966016);
      this.s605770430439902.s332283293464676(s482853406772563);
      s034852122986107 s180318052354735 = this.s128380686175907(s482853406772563);
      if (s180318052354735.s841790547125492)
        s180318052354735.s204978232629101();
      this.s551418563715328(s180318052354735);
      if (this.s880805771966016 == null)
        return;
      Monitor.Exit(this.s880805771966016);
    }

    protected override unsafe void Dispose(bool disposing)
    {
      lock (this)
      {
        this.s301783657697048 = true;
        if (this.s740412043008899 != null)
        {
          foreach (ulong s489754519192958 in this.s740412043008899)
          {
            if (s489754519192958 != ulong.MaxValue)
              s134995860702422.s373861679794889(s489754519192958);
          }
          this.s740412043008899 = (ulong[]) null;
        }
        if ((IntPtr) this.s309596607071739 != IntPtr.Zero)
        {
          Marshal.FreeHGlobal((IntPtr) (void*) this.s309596607071739);
          this.s309596607071739 = (s134995860702422.s648877553938236*) null;
        }
        this.s605770430439902.s091031820654218();
        base.Dispose(disposing);
      }
    }

    ~s302986156607931() => this.Dispose(false);

    private void s095851711449549()
    {
      if (!this.s159861036011599)
        throw new InvalidOperationException("Event stream is not resetable (e.g. real time).");
      if (this.s740412043008899 == null)
        return;
      for (int index = 0; index < this.s740412043008899.Length; ++index)
      {
        if (this.s740412043008899[index] != ulong.MaxValue)
        {
          s134995860702422.s373861679794889(this.s740412043008899[index]);
          this.s740412043008899[index] = ulong.MaxValue;
        }
        if (!this.s006184527445362)
        {
          this.s393590399745956[index].s630986022097681 = 268435456U;
          this.s393590399745956[index].s630986022097681 |= 4096U;
        }
        this.s740412043008899[index] = s134995860702422.s983712201802122(ref this.s393590399745956[index]);
        if (this.s740412043008899[index] == ulong.MaxValue)
          Marshal.ThrowExceptionForHR(s134995860702422.s386271101430851());
      }
    }

    private bool s726665078361988(IntPtr s961039071888717) => !this.s301783657697048;

    internal virtual string s277465314988868(int s027971129248587, long s302615709313669)
    {
      string str;
      if (!this.s084156689599620.TryGetValue(s027971129248587, out str))
        str = "";
      return str;
    }

    [System.Flags]
    public enum s758934652151773
    {
      OnlyNGENImages = 0,
      IncludeUnmanagedModules = 1,
      IncludeModulesWithOutSamples = 2,
    }

    private class s808831215449236 : IComparable<s302986156607931.s808831215449236>
    {
      public string s139854256785270;
      public ulong s351731687773735;
      public int s568873002131684;
      private DateTime s144848023851463;

      public s808831215449236(int ProcessID, string DllName, ulong BaseAddress, int Size)
      {
        ((s302986156607931.s758934652151773) this).s034893317423019 = ProcessID;
        this.s139854256785270 = DllName;
        this.s351731687773735 = BaseAddress;
        this.s568873002131684 = Size;
      }

      public static long s415027338160589(DateTime s790768863440562) => new s302986156607931.s608070375670175().s721161426342044(s790768863440562);
    }

    private class s608070375670175
    {
      private long s174251716328856;
      public List<s302986156607931.s808831215449236> s337018858850677;

      private long s721161426342044(DateTime s054657024151495) => (long) ((double) (s054657024151495.Ticks - ((s302986156607931.s808831215449236) this).s144848023851463.Ticks) / 10000000.0 * (double) Stopwatch.Frequency) + this.s174251716328856;

      private s608070375670175()
      {
        DateTime utcNow1 = DateTime.UtcNow;
        long num = Stopwatch.GetTimestamp();
        DateTime utcNow2;
        while (true)
        {
          utcNow2 = DateTime.UtcNow;
          this.s174251716328856 = Stopwatch.GetTimestamp();
          if (!(utcNow2 != utcNow1))
            num = this.s174251716328856;
          else
            break;
        }
        ((s302986156607931.s808831215449236) this).s144848023851463 = utcNow2;
        this.s174251716328856 = num;
      }

      public s608070375670175()
      {
      }
    }
  }
}
