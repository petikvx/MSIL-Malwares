// Decompiled with JetBrains decompiler
// Type: Cradiator.Model.CountdownTimer
// Assembly: EvidenceTypeDescript, Version=2.1.0.0, Culture=neutral, PublicKeyToken=null
// MVID: B50F5F07-D63E-4094-B80D-E78774C87D41
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.02-msil\HEUR-Trojan.MSIL.Crypt.gen-c59c8e3be7ec42553ff6af2588e3bcd0569e9467dbb9307218fb8724e02739f2.exe

using Cradiator.Config;
using Cradiator.Views;
using System;
using System.Windows.Threading;

namespace Cradiator.Model
{
  public class CountdownTimer : ICountdownTimer
  {
    private static readonly TimeSpan OneSecond = new TimeSpan(0, 0, 1);
    private bool _isSwitchedOn;
    private DateTime _nextRefresh;
    private readonly ICradiatorView _view;
    private readonly DispatcherTimer _countdownTimer;
    private IDateTimeNow _date = (IDateTimeNow) new DateTimeNow();

    public TimeSpan PollFrequency { private get; set; }

    public IDateTimeNow Date
    {
      set
      {
        this._date = value;
        this.Reset();
      }
    }

    public bool IsSwitchedOn => this._isSwitchedOn;

    public CountdownTimer(IConfigSettings configSettings, ICradiatorView view)
    {
      this._view = view;
      this._isSwitchedOn = configSettings.ShowCountdown;
      this.PollFrequency = configSettings.PollFrequencyTimeSpan;
      this._countdownTimer = new DispatcherTimer()
      {
        Interval = CountdownTimer.OneSecond
      };
      this._countdownTimer.Tick += (EventHandler) ((sender, e) => this.Execute());
      this.Reset();
    }

    public void Start()
    {
      if (!this.IsSwitchedOn)
        return;
      this._countdownTimer.Start();
    }

    public void Stop()
    {
      if (!this.IsSwitchedOn)
        return;
      this._countdownTimer.Stop();
    }

    public DateTime Reset() => this._nextRefresh = this._date.Now + this.PollFrequency;

    public DateTime CalculateNext() => this._nextRefresh = this._nextRefresh < this._date.Now ? this.Reset() : this._nextRefresh;

    public void Execute() => this._view.UpdateCountdownTimer(this.CalculateTimeToGo());

    public TimeSpan CalculateTimeToGo() => this.CalculateNext() - this._date.Now;

    public void SwitchOff() => this._isSwitchedOn = false;

    public void SwitchOn() => this._isSwitchedOn = true;
  }
}
