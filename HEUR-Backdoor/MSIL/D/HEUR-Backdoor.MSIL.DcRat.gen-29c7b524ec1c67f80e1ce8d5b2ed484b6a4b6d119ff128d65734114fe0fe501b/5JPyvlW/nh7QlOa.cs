// Decompiled with JetBrains decompiler
// Type: 5JPyvlW.nh7QlOa
// Assembly: jmZGgwW, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a
// MVID: 3D70FD3D-7EEC-4701-9107-04233FCFD67F
// Assembly location: C:\Users\Administrateur\Downloads\Bazaar.2022.03\HEUR-Backdoor.MSIL.DcRat.gen-29c7b524ec1c67f80e1ce8d5b2ed484b6a4b6d119ff128d65734114fe0fe501b.exe

using \u0035JPyvlW;
using ipeAyiL;
using Microsoft;
using Microsoft.ServiceHub.Framework;
using Microsoft.ServiceHub.HostStub;
using Microsoft.ServiceHub.Utility;
using Microsoft.VisualStudio.Threading;
using s9shvFZ;
using StreamJsonRpc;
using System;
using System.Diagnostics;
using System.Runtime.CompilerServices;
using System.Threading;
using System.Threading.Tasks;

namespace \u0035JPyvlW
{
  internal sealed class nh7QlOa : IServiceHost, IDisposable
  {
    private const int q2O0moq = 0;
    private const int \u00350M7pda = 2;
    private const string xE5Mizz = "hubHostClr";
    private static readonly TimeSpan GS0i3JG = TimeSpan.FromSeconds(5.0);
    private readonly DevHubTraceSource Jd7jDmK;
    private readonly bool \u0039eCjBw4;
    private readonly string \u0037gaABpu;
    private readonly Task<JsonRpc> OE7QK0G;
    private readonly IServiceManager OBDf0D8;
    private readonly AsyncManualResetEvent MhJ371L;
    private readonly AsyncManualResetEvent cHI60Rf;
    private readonly SemaphoreSlim ohQNYXu;
    private int yAx00jy;
    private bool WOWEOyX;
    private bool o5yodb3;

    public nh7QlOa(string hostId, string pipeName, DevHubTraceSource logger = null)
    {
      // ISSUE: object of a compiler-generated type is created
      // ISSUE: variable of a compiler-generated type
      nh7QlOa.FMd6QK3 fmd6Qk3 = (nh7QlOa.FMd6QK3) new LvTTHHN<>.oY67Rlt();
      // ISSUE: reference to a compiler-generated field
      fmd6Qk3.\u0032ZrDWWA = pipeName;
      // ISSUE: explicit constructor call
      base.\u002Ector();
      // ISSUE: reference to a compiler-generated field
      ((LvTTHHN<>.oY67Rlt) fmd6Qk3).ZcWsUym = this;
      try
      {
        Requires.NotNullOrEmpty(hostId, nameof (hostId));
        // ISSUE: reference to a compiler-generated field
        Requires.NotNullOrEmpty(fmd6Qk3.\u0032ZrDWWA, nameof (pipeName));
        this.\u0037gaABpu = hostId;
        this.Jd7jDmK = logger;
        if (logger == null)
        {
          this.Jd7jDmK = EnvUtils.GetNewTraceSource("hubnh7QlOaClr");
          this.\u0039eCjBw4 = true;
        }
        // ISSUE: reference to a compiler-generated field
        this.Jd7jDmK.TraceInformation("Service Hub .NET service module host started. nh7QlOa id: {0}. Controller pipe: {1}", new object[2]
        {
          (object) hostId,
          (object) fmd6Qk3.\u0032ZrDWWA
        });
        // ISSUE: reference to a compiler-generated method
        this.OE7QK0G = Task.Run<JsonRpc>(new Func<Task<JsonRpc>>(fmd6Qk3.zKf4P3o));
        // ISSUE: reference to a compiler-generated field
        this.OBDf0D8 = (IServiceManager) new SK0Z2gq((IServiceHost) this, this.Jd7jDmK, fmd6Qk3.\u0032ZrDWWA);
      }
      catch (Exception ex)
      {
        if (this.\u0039eCjBw4)
          ((TraceSource) this.Jd7jDmK)?.Close();
        throw;
      }
    }

    public Task<int> GUGh4YZ()
    {
      // ISSUE: variable of a compiler-generated type
      nh7QlOa.cJjAZx6 stateMachine;
      // ISSUE: reference to a compiler-generated field
      stateMachine.Tpj07fL = this;
      // ISSUE: reference to a compiler-generated field
      stateMachine.HGspoPI = AsyncTaskMethodBuilder<int>.Create();
      // ISSUE: cast to a reference type
      // ISSUE: explicit reference operation
      // ISSUE: reference to a compiler-generated field
      (^(nh7QlOa.FMd6QK3&) ref stateMachine).g1O9y3h = -1;
      // ISSUE: reference to a compiler-generated field
      stateMachine.HGspoPI.Start<nh7QlOa.cJjAZx6>(ref stateMachine);
      // ISSUE: reference to a compiler-generated field
      return stateMachine.HGspoPI.Task;
    }

    public string wJYOJrl()
    {
      this.fOWNCsX();
      return this.\u0037gaABpu;
    }

    [JsonRpcMethod("startService")]
    public Task<string> \u00393zoSZa(
      ServiceModuleInfo NwQ95j8,
      ServiceActivationOptions _param2 = default (ServiceActivationOptions))
    {
      // ISSUE: variable of a compiler-generated type
      nh7QlOa.t1SG5rc stateMachine;
      // ISSUE: reference to a compiler-generated field
      stateMachine.kjOEmhz = this;
      // ISSUE: reference to a compiler-generated field
      stateMachine.sXF4cSK = NwQ95j8;
      // ISSUE: reference to a compiler-generated field
      stateMachine.cmsFxPG = _param2;
      // ISSUE: reference to a compiler-generated field
      stateMachine.Ya8nE8z = AsyncTaskMethodBuilder<string>.Create();
      // ISSUE: cast to a reference type
      // ISSUE: explicit reference operation
      // ISSUE: reference to a compiler-generated field
      (^(nh7QlOa.cJjAZx6&) ref stateMachine).DIp8HL9 = -1;
      // ISSUE: reference to a compiler-generated field
      stateMachine.Ya8nE8z.Start<nh7QlOa.t1SG5rc>(ref stateMachine);
      // ISSUE: reference to a compiler-generated field
      return stateMachine.Ya8nE8z.Task;
    }

    public void \u0039Blxhmz()
    {
      this.fOWNCsX();
      this.Jd7jDmK.TraceInformation("Exit command recieved. Exiting CLR host");
      this.MhJ371L.Set();
    }

    [JsonRpcMethod("cancelServiceRequest")]
    public void ICiaIRB(string UiDtckA) => this.OBDf0D8.CancelServiceRequest(UiDtckA);

    public void K7wu3xD() => this.MrYrYLN(true);

    private void MrYrYLN(bool TP8UbtB)
    {
      if (this.o5yodb3)
        return;
      this.o5yodb3 = true;
      if (!TP8UbtB)
        return;
      this.OE7QK0G.ContinueWith((Action<Task<JsonRpc>>) (NWiL0H3 => NWiL0H3.Result.Dispose()), TaskContinuationOptions.OnlyOnRanToCompletion | TaskContinuationOptions.ExecuteSynchronously);
      ((IDisposable) this.OBDf0D8).Dispose();
      if (!this.\u0039eCjBw4)
        return;
      ((TraceSource) this.Jd7jDmK).Close();
    }

    private Task lVQdO1V(string _param1)
    {
      // ISSUE: variable of a compiler-generated type
      nh7QlOa.UA1PaZY stateMachine;
      // ISSUE: reference to a compiler-generated field
      stateMachine.ccbDbdB = this;
      // ISSUE: reference to a compiler-generated field
      stateMachine.a6rZUNZ = _param1;
      // ISSUE: reference to a compiler-generated field
      stateMachine.WXKJHI2 = AsyncTaskMethodBuilder.Create();
      // ISSUE: cast to a reference type
      // ISSUE: explicit reference operation
      // ISSUE: reference to a compiler-generated field
      (^(nh7QlOa.\u0030KalUB2&) ref stateMachine).\u00356Jz0s4 = -1;
      // ISSUE: reference to a compiler-generated field
      stateMachine.WXKJHI2.Start<nh7QlOa.UA1PaZY>(ref stateMachine);
      // ISSUE: reference to a compiler-generated field
      return stateMachine.WXKJHI2.Task;
    }

    private Task<JsonRpc> E8l9Kck(string dEJEopQ)
    {
      // ISSUE: variable of a compiler-generated type
      nh7QlOa.\u0034j4Rjuo stateMachine;
      // ISSUE: reference to a compiler-generated field
      stateMachine.\u0031YQt0yo = this;
      // ISSUE: reference to a compiler-generated field
      stateMachine.bqHPXJi = dEJEopQ;
      // ISSUE: reference to a compiler-generated field
      stateMachine.mOnoLzs = AsyncTaskMethodBuilder<JsonRpc>.Create();
      // ISSUE: cast to a reference type
      // ISSUE: explicit reference operation
      // ISSUE: reference to a compiler-generated field
      (^(nh7QlOa.UA1PaZY&) ref stateMachine).\u0036VqKSAT = -1;
      // ISSUE: reference to a compiler-generated field
      stateMachine.mOnoLzs.Start<nh7QlOa.\u0034j4Rjuo>(ref stateMachine);
      // ISSUE: reference to a compiler-generated field
      return stateMachine.mOnoLzs.Task;
    }

    public void AYiqqYP()
    {
      this.fOWNCsX();
      this.hEUGEX5();
      if (Interlocked.Increment(ref this.yAx00jy) != 1)
        return;
      this.lVQdO1V("hostServicesStarted");
    }

    public void oOXtcOl()
    {
      this.fOWNCsX();
      if (Interlocked.Decrement(ref this.yAx00jy) != 0)
        return;
      this.lVQdO1V("hostServicesEnded");
    }

    public void xINSRXT()
    {
      this.fOWNCsX();
      this.cHI60Rf.Set();
    }

    private void hEUGEX5()
    {
      if (this.WOWEOyX)
        throw new ObjectDisposedException(this.GetType().Name);
    }

    private void fOWNCsX()
    {
      if (this.o5yodb3)
        throw new ObjectDisposedException(this.GetType().Name);
    }
  }
}
